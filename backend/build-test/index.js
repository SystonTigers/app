var pa=Object.defineProperty;var u=(t,e)=>pa(t,"name",{value:e,configurable:!0});var K=(t,e)=>()=>(t&&(e=t(t=0)),e);var Oe=(t,e)=>{for(var s in e)pa(t,s,{get:e[s],enumerable:!0})};function F(t){return new Error(`[unenv] ${t} is not implemented yet!`)}function fe(t){return Object.assign(u(()=>{throw F(t)},"fn"),{__unenv__:!0})}function ma(t){return class{__unenv__=!0;constructor(){throw new Error(`[unenv] ${t} is not implemented yet!`)}}}var Kt=K(()=>{_();w();y();u(F,"createNotImplementedError");u(fe,"notImplemented");u(ma,"notImplementedClass")});var Ts,xs,Nr,ke,Is,It,Rt,Vt,vt,Ft,fa,ha=K(()=>{_();w();y();Kt();Ts=globalThis.performance?.timeOrigin??Date.now(),xs=globalThis.performance?.now?globalThis.performance.now.bind(globalThis.performance):()=>Date.now()-Ts,Nr={name:"node",entryType:"node",startTime:0,duration:0,nodeStart:0,v8Start:0,bootstrapComplete:0,environment:0,loopStart:0,loopExit:0,idleTime:0,uvMetricsInfo:{loopCount:0,events:0,eventsWaiting:0},detail:void 0,toJSON(){return this}},ke=class{static{u(this,"PerformanceEntry")}__unenv__=!0;detail;entryType="event";name;startTime;constructor(e,s){this.name=e,this.startTime=s?.startTime||xs(),this.detail=s?.detail}get duration(){return xs()-this.startTime}toJSON(){return{name:this.name,entryType:this.entryType,startTime:this.startTime,duration:this.duration,detail:this.detail}}},Is=class extends ke{static{u(this,"PerformanceMark")}entryType="mark";constructor(){super(...arguments)}get duration(){return 0}},It=class extends ke{static{u(this,"PerformanceMeasure")}entryType="measure"},Rt=class extends ke{static{u(this,"PerformanceResourceTiming")}entryType="resource";serverTiming=[];connectEnd=0;connectStart=0;decodedBodySize=0;domainLookupEnd=0;domainLookupStart=0;encodedBodySize=0;fetchStart=0;initiatorType="";name="";nextHopProtocol="";redirectEnd=0;redirectStart=0;requestStart=0;responseEnd=0;responseStart=0;secureConnectionStart=0;startTime=0;transferSize=0;workerStart=0;responseStatus=0},Vt=class{static{u(this,"PerformanceObserverEntryList")}__unenv__=!0;getEntries(){return[]}getEntriesByName(e,s){return[]}getEntriesByType(e){return[]}},vt=class{static{u(this,"Performance")}__unenv__=!0;timeOrigin=Ts;eventCounts=new Map;_entries=[];_resourceTimingBufferSize=0;navigation=void 0;timing=void 0;timerify(e,s){throw F("Performance.timerify")}get nodeTiming(){return Nr}eventLoopUtilization(){return{}}markResourceTiming(){return new Rt("")}onresourcetimingbufferfull=null;now(){return this.timeOrigin===Ts?xs():Date.now()-this.timeOrigin}clearMarks(e){this._entries=e?this._entries.filter(s=>s.name!==e):this._entries.filter(s=>s.entryType!=="mark")}clearMeasures(e){this._entries=e?this._entries.filter(s=>s.name!==e):this._entries.filter(s=>s.entryType!=="measure")}clearResourceTimings(){this._entries=this._entries.filter(e=>e.entryType!=="resource"||e.entryType!=="navigation")}getEntries(){return this._entries}getEntriesByName(e,s){return this._entries.filter(a=>a.name===e&&(!s||a.entryType===s))}getEntriesByType(e){return this._entries.filter(s=>s.entryType===e)}mark(e,s){let a=new Is(e,s);return this._entries.push(a),a}measure(e,s,a){let n,o;typeof s=="string"?(n=this.getEntriesByName(s,"mark")[0]?.startTime,o=this.getEntriesByName(a,"mark")[0]?.startTime):(n=Number.parseFloat(s?.start)||this.now(),o=Number.parseFloat(s?.end)||this.now());let m=new It(e,{startTime:n,detail:{start:n,end:o}});return this._entries.push(m),m}setResourceTimingBufferSize(e){this._resourceTimingBufferSize=e}addEventListener(e,s,a){throw F("Performance.addEventListener")}removeEventListener(e,s,a){throw F("Performance.removeEventListener")}dispatchEvent(e){throw F("Performance.dispatchEvent")}toJSON(){return this}},Ft=class{static{u(this,"PerformanceObserver")}__unenv__=!0;static supportedEntryTypes=[];_callback=null;constructor(e){this._callback=e}takeRecords(){return[]}disconnect(){throw F("PerformanceObserver.disconnect")}observe(e){throw F("PerformanceObserver.observe")}bind(e){return e}runInAsyncScope(e,s,...a){return e.call(s,...a)}asyncId(){return 0}triggerAsyncId(){return 0}emitDestroy(){return this}},fa=globalThis.performance&&"addEventListener"in globalThis.performance?globalThis.performance:new vt});var ga=K(()=>{_();w();y();ha()});var y=K(()=>{ga();globalThis.performance=fa;globalThis.Performance=vt;globalThis.PerformanceEntry=ke;globalThis.PerformanceMark=Is;globalThis.PerformanceMeasure=It;globalThis.PerformanceObserver=Ft;globalThis.PerformanceObserverEntryList=Vt;globalThis.PerformanceResourceTiming=Rt});var G,ya=K(()=>{_();w();y();G=Object.assign(()=>{},{__unenv__:!0})});import{Writable as wa}from"node:stream";var B,_a,Ea,ba,Wt,$r,Ld,Ud,jd,Mr,Kd,Vd,Fd,Wd,Bd,Jd,Hd,Gd,zd,Yd,Zd,Xd,Qd,qd,el,tl,Sa,Ta,xa,Ia,Ra=K(()=>{_();w();y();ya();Kt();B=globalThis.console,_a=!0,Ea=new wa,ba=new wa,Wt=B?.log??G,$r=B?.info??Wt,Ld=B?.trace??$r,Ud=B?.debug??Wt,jd=B?.table??Wt,Mr=B?.error??Wt,Kd=B?.warn??Mr,Vd=B?.createTask??fe("console.createTask"),Fd=B?.clear??G,Wd=B?.count??G,Bd=B?.countReset??G,Jd=B?.dir??G,Hd=B?.dirxml??G,Gd=B?.group??G,zd=B?.groupEnd??G,Yd=B?.groupCollapsed??G,Zd=B?.profile??G,Xd=B?.profileEnd??G,Qd=B?.time??G,qd=B?.timeEnd??G,el=B?.timeLog??G,tl=B?.timeStamp??G,Sa=B?.Console??ma("console.Console"),Ta=new Map,xa=G,Ia=G});var Rs,cl,ul,dl,ll,pl,ml,fl,hl,gl,yl,wl,_l,El,bl,Sl,Tl,xl,Il,Rl,vl,Pl,Al,Ol,kl,va,Pa=K(()=>{_();w();y();Ra();Rs=globalThis.console,{assert:cl,clear:ul,context:dl,count:ll,countReset:pl,createTask:ml,debug:fl,dir:hl,dirxml:gl,error:yl,group:wl,groupCollapsed:_l,groupEnd:El,info:bl,log:Sl,profile:Tl,profileEnd:xl,table:Il,time:Rl,timeEnd:vl,timeLog:Pl,timeStamp:Al,trace:Ol,warn:kl}=Rs;Object.assign(Rs,{Console:Sa,_ignoreErrors:_a,_stderr:Ea,_stderrErrorHandler:Ia,_stdout:ba,_stdoutErrorHandler:xa,_times:Ta});va=Rs});var w=K(()=>{Pa();globalThis.console=va});var Aa,Oa=K(()=>{_();w();y();Aa=Object.assign(u(function(e){let s=Date.now(),a=Math.trunc(s/1e3),n=s%1e3*1e6;if(e){let o=a-e[0],m=n-e[0];return m<0&&(o=o-1,m=1e9+m),[o,m]}return[a,n]},"hrtime"),{bigint:u(function(){return BigInt(Date.now()*1e6)},"bigint")})});var Pt,ka=K(()=>{_();w();y();Pt=class{static{u(this,"ReadStream")}fd;isRaw=!1;isTTY=!1;constructor(e){this.fd=e}setRawMode(e){return this.isRaw=e,this}}});var at,Ca=K(()=>{_();w();y();at=class{static{u(this,"WriteStream")}fd;columns=80;rows=24;isTTY=!1;constructor(e){this.fd=e}clearLine(e,s){return s&&s(),!1}clearScreenDown(e){return e&&e(),!1}cursorTo(e,s,a){return a&&typeof a=="function"&&a(),!1}moveCursor(e,s,a){return a&&a(),!1}getColorDepth(e){return 1}hasColors(e,s){return!1}getWindowSize(){return[this.columns,this.rows]}write(e,s,a){e instanceof Uint8Array&&(e=new TextDecoder().decode(e));try{console.log(e)}catch{}return a&&typeof a=="function"&&a(),!1}}});var Da=K(()=>{_();w();y();ka();Ca()});var vs,Na=K(()=>{_();w();y();vs="22.14.0"});import{EventEmitter as $a}from"node:events";var Bt,Ma=K(()=>{_();w();y();Da();Kt();Na();Bt=class t extends $a{static{u(this,"Process")}env;hrtime;nextTick;constructor(e){super(),this.env=e.env,this.hrtime=e.hrtime,this.nextTick=e.nextTick;for(let s of[...Object.getOwnPropertyNames(t.prototype),...Object.getOwnPropertyNames($a.prototype)]){let a=this[s];typeof a=="function"&&(this[s]=a.bind(this))}}emitWarning(e,s,a){console.warn(`${a?`[${a}] `:""}${s?`${s}: `:""}${e}`)}emit(...e){return super.emit(...e)}listeners(e){return super.listeners(e)}#e;#t;#s;get stdin(){return this.#e??=new Pt(0)}get stdout(){return this.#t??=new at(1)}get stderr(){return this.#s??=new at(2)}#a="/";chdir(e){this.#a=e}cwd(){return this.#a}arch="";platform="";argv=[];argv0="";execArgv=[];execPath="";title="";pid=200;ppid=100;get version(){return`v${vs}`}get versions(){return{node:vs}}get allowedNodeEnvironmentFlags(){return new Set}get sourceMapsEnabled(){return!1}get debugPort(){return 0}get throwDeprecation(){return!1}get traceDeprecation(){return!1}get features(){return{}}get release(){return{}}get connected(){return!1}get config(){return{}}get moduleLoadList(){return[]}constrainedMemory(){return 0}availableMemory(){return 0}uptime(){return 0}resourceUsage(){return{}}ref(){}unref(){}umask(){throw F("process.umask")}getBuiltinModule(){}getActiveResourcesInfo(){throw F("process.getActiveResourcesInfo")}exit(){throw F("process.exit")}reallyExit(){throw F("process.reallyExit")}kill(){throw F("process.kill")}abort(){throw F("process.abort")}dlopen(){throw F("process.dlopen")}setSourceMapsEnabled(){throw F("process.setSourceMapsEnabled")}loadEnvFile(){throw F("process.loadEnvFile")}disconnect(){throw F("process.disconnect")}cpuUsage(){throw F("process.cpuUsage")}setUncaughtExceptionCaptureCallback(){throw F("process.setUncaughtExceptionCaptureCallback")}hasUncaughtExceptionCaptureCallback(){throw F("process.hasUncaughtExceptionCaptureCallback")}initgroups(){throw F("process.initgroups")}openStdin(){throw F("process.openStdin")}assert(){throw F("process.assert")}binding(){throw F("process.binding")}permission={has:fe("process.permission.has")};report={directory:"",filename:"",signal:"SIGUSR2",compact:!1,reportOnFatalError:!1,reportOnSignal:!1,reportOnUncaughtException:!1,getReport:fe("process.report.getReport"),writeReport:fe("process.report.writeReport")};finalization={register:fe("process.finalization.register"),unregister:fe("process.finalization.unregister"),registerBeforeExit:fe("process.finalization.registerBeforeExit")};memoryUsage=Object.assign(()=>({arrayBuffers:0,rss:0,external:0,heapTotal:0,heapUsed:0}),{rss:u(()=>0,"rss")});mainModule=void 0;domain=void 0;send=void 0;exitCode=void 0;channel=void 0;getegid=void 0;geteuid=void 0;getgid=void 0;getgroups=void 0;getuid=void 0;setegid=void 0;seteuid=void 0;setgid=void 0;setgroups=void 0;setuid=void 0;_events=void 0;_eventsCount=void 0;_exiting=void 0;_maxListeners=void 0;_debugEnd=void 0;_debugProcess=void 0;_fatalException=void 0;_getActiveHandles=void 0;_getActiveRequests=void 0;_kill=void 0;_preload_modules=void 0;_rawDebug=void 0;_startProfilerIdleNotifier=void 0;_stopProfilerIdleNotifier=void 0;_tickCallback=void 0;_disconnect=void 0;_handleQueue=void 0;_pendingMessage=void 0;_channel=void 0;_send=void 0;_linkedBinding=void 0}});var La,Ua,Jt,ja,Ps,Lr,Ur,jr,Kr,Vr,Fr,Wr,Br,Jr,Hr,Gr,zr,Yr,Zr,Xr,Qr,qr,eo,to,so,ao,no,ro,oo,io,co,uo,lo,po,mo,fo,ho,go,yo,wo,_o,Eo,bo,So,To,xo,Io,Ro,vo,Po,Ao,Oo,ko,Co,Do,No,$o,Mo,Lo,Uo,jo,Ko,Vo,Fo,Wo,Bo,Jo,Ho,Go,zo,Yo,Zo,Xo,Qo,qo,ei,ti,si,ai,ni,ri,oi,ii,ci,ui,di,Ep,li,pi,mi,fi,hi,gi,yi,wi,_i,Ei,bi,Si,Ti,xi,Ii,Ri,vi,Pi,Ai,Oi,ki,Ci,bp,Di,Ni,$i,Mi,Ka,Va=K(()=>{_();w();y();Oa();Ma();La=globalThis.process,Ua=La.getBuiltinModule,Jt=Ua("node:process"),ja=globalThis.Cloudflare.compatibilityFlags.enable_nodejs_process_v2,Ps=new Bt({env:La.env,hrtime:ja?Jt.hrtime:Aa,nextTick:Jt.nextTick}),{exit:Lr,features:Ur,platform:jr}=Jt,{env:Kr,hrtime:Vr,nextTick:Fr}=Ps,{_channel:Wr,_disconnect:Br,_events:Jr,_eventsCount:Hr,_handleQueue:Gr,_maxListeners:zr,_pendingMessage:Yr,_send:Zr,assert:Xr,disconnect:Qr,mainModule:qr}=Ps,{_debugEnd:eo,_debugProcess:to,_exiting:so,_fatalException:ao,_getActiveHandles:no,_getActiveRequests:ro,_kill:oo,_linkedBinding:io,_preload_modules:co,_rawDebug:uo,_startProfilerIdleNotifier:lo,_stopProfilerIdleNotifier:po,_tickCallback:mo,abort:fo,addListener:ho,allowedNodeEnvironmentFlags:go,arch:yo,argv:wo,argv0:_o,availableMemory:Eo,binding:bo,channel:So,chdir:To,config:xo,connected:Io,constrainedMemory:Ro,cpuUsage:vo,cwd:Po,debugPort:Ao,dlopen:Oo,domain:ko,emit:Co,emitWarning:Do,eventNames:No,execArgv:$o,execPath:Mo,exitCode:Lo,finalization:Uo,getActiveResourcesInfo:jo,getegid:Ko,geteuid:Vo,getgid:Fo,getgroups:Wo,getMaxListeners:Bo,getuid:Jo,hasUncaughtExceptionCaptureCallback:Ho,initgroups:Go,kill:zo,listenerCount:Yo,listeners:Zo,loadEnvFile:Xo,memoryUsage:Qo,moduleLoadList:qo,off:ei,on:ti,once:si,openStdin:ai,permission:ni,pid:ri,ppid:oi,prependListener:ii,prependOnceListener:ci,rawListeners:ui,reallyExit:di,ref:Ep,release:li,removeAllListeners:pi,removeListener:mi,report:fi,resourceUsage:hi,send:gi,setegid:yi,seteuid:wi,setgid:_i,setgroups:Ei,setMaxListeners:bi,setSourceMapsEnabled:Si,setuid:Ti,setUncaughtExceptionCaptureCallback:xi,sourceMapsEnabled:Ii,stderr:Ri,stdin:vi,stdout:Pi,throwDeprecation:Ai,title:Oi,traceDeprecation:ki,umask:Ci,unref:bp,uptime:Di,version:Ni,versions:$i}=ja?Jt:Ps,Mi={abort:fo,addListener:ho,allowedNodeEnvironmentFlags:go,hasUncaughtExceptionCaptureCallback:Ho,setUncaughtExceptionCaptureCallback:xi,loadEnvFile:Xo,sourceMapsEnabled:Ii,arch:yo,argv:wo,argv0:_o,chdir:To,config:xo,connected:Io,constrainedMemory:Ro,availableMemory:Eo,cpuUsage:vo,cwd:Po,debugPort:Ao,dlopen:Oo,disconnect:Qr,emit:Co,emitWarning:Do,env:Kr,eventNames:No,execArgv:$o,execPath:Mo,exit:Lr,finalization:Uo,features:Ur,getBuiltinModule:Ua,getActiveResourcesInfo:jo,getMaxListeners:Bo,hrtime:Vr,kill:zo,listeners:Zo,listenerCount:Yo,memoryUsage:Qo,nextTick:Fr,on:ti,off:ei,once:si,pid:ri,platform:jr,ppid:oi,prependListener:ii,prependOnceListener:ci,rawListeners:ui,release:li,removeAllListeners:pi,removeListener:mi,report:fi,resourceUsage:hi,setMaxListeners:bi,setSourceMapsEnabled:Si,stderr:Ri,stdin:vi,stdout:Pi,title:Oi,throwDeprecation:Ai,traceDeprecation:ki,umask:Ci,uptime:Di,version:Ni,versions:$i,domain:ko,initgroups:Go,moduleLoadList:qo,reallyExit:di,openStdin:ai,assert:Xr,binding:bo,send:gi,exitCode:Lo,channel:So,getegid:Ko,geteuid:Vo,getgid:Fo,getgroups:Wo,getuid:Jo,setegid:yi,seteuid:wi,setgid:_i,setgroups:Ei,setuid:Ti,permission:ni,mainModule:qr,_events:Jr,_eventsCount:Hr,_exiting:so,_maxListeners:zr,_debugEnd:eo,_debugProcess:to,_fatalException:ao,_getActiveHandles:no,_getActiveRequests:ro,_kill:oo,_preload_modules:co,_rawDebug:uo,_startProfilerIdleNotifier:lo,_stopProfilerIdleNotifier:po,_tickCallback:mo,_disconnect:Br,_handleQueue:Gr,_pendingMessage:Yr,_channel:Wr,_send:Zr,_linkedBinding:io},Ka=Mi});var _=K(()=>{Va();globalThis.process=Ka});var U,As,R,de,At=K(()=>{_();w();y();(function(t){t.assertEqual=n=>{};function e(n){}u(e,"assertIs"),t.assertIs=e;function s(n){throw new Error}u(s,"assertNever"),t.assertNever=s,t.arrayToEnum=n=>{let o={};for(let m of n)o[m]=m;return o},t.getValidEnumValues=n=>{let o=t.objectKeys(n).filter(r=>typeof n[n[r]]!="number"),m={};for(let r of o)m[r]=n[r];return t.objectValues(m)},t.objectValues=n=>t.objectKeys(n).map(function(o){return n[o]}),t.objectKeys=typeof Object.keys=="function"?n=>Object.keys(n):n=>{let o=[];for(let m in n)Object.prototype.hasOwnProperty.call(n,m)&&o.push(m);return o},t.find=(n,o)=>{for(let m of n)if(o(m))return m},t.isInteger=typeof Number.isInteger=="function"?n=>Number.isInteger(n):n=>typeof n=="number"&&Number.isFinite(n)&&Math.floor(n)===n;function a(n,o=" | "){return n.map(m=>typeof m=="string"?`'${m}'`:m).join(o)}u(a,"joinValues"),t.joinValues=a,t.jsonStringifyReplacer=(n,o)=>typeof o=="bigint"?o.toString():o})(U||(U={}));(function(t){t.mergeShapes=(e,s)=>({...e,...s})})(As||(As={}));R=U.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),de=u(t=>{switch(typeof t){case"undefined":return R.undefined;case"string":return R.string;case"number":return Number.isNaN(t)?R.nan:R.number;case"boolean":return R.boolean;case"function":return R.function;case"bigint":return R.bigint;case"symbol":return R.symbol;case"object":return Array.isArray(t)?R.array:t===null?R.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?R.promise:typeof Map<"u"&&t instanceof Map?R.map:typeof Set<"u"&&t instanceof Set?R.set:typeof Date<"u"&&t instanceof Date?R.date:R.object;default:return R.unknown}},"getParsedType")});var T,Li,Z,Ht=K(()=>{_();w();y();At();T=U.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Li=u(t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),"quotelessJson"),Z=class t extends Error{static{u(this,"ZodError")}get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=a=>{this.issues=[...this.issues,a]},this.addIssues=(a=[])=>{this.issues=[...this.issues,...a]};let s=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,s):this.__proto__=s,this.name="ZodError",this.issues=e}format(e){let s=e||function(o){return o.message},a={_errors:[]},n=u(o=>{for(let m of o.issues)if(m.code==="invalid_union")m.unionErrors.map(n);else if(m.code==="invalid_return_type")n(m.returnTypeError);else if(m.code==="invalid_arguments")n(m.argumentsError);else if(m.path.length===0)a._errors.push(s(m));else{let r=a,c=0;for(;c<m.path.length;){let h=m.path[c];c===m.path.length-1?(r[h]=r[h]||{_errors:[]},r[h]._errors.push(s(m))):r[h]=r[h]||{_errors:[]},r=r[h],c++}}},"processError");return n(this),a}static assert(e){if(!(e instanceof t))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,U.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=s=>s.message){let s={},a=[];for(let n of this.issues)if(n.path.length>0){let o=n.path[0];s[o]=s[o]||[],s[o].push(e(n))}else a.push(e(n));return{formErrors:a,fieldErrors:s}}get formErrors(){return this.flatten()}};Z.create=t=>new Z(t)});var Ui,he,Os=K(()=>{_();w();y();Ht();At();Ui=u((t,e)=>{let s;switch(t.code){case T.invalid_type:t.received===R.undefined?s="Required":s=`Expected ${t.expected}, received ${t.received}`;break;case T.invalid_literal:s=`Invalid literal value, expected ${JSON.stringify(t.expected,U.jsonStringifyReplacer)}`;break;case T.unrecognized_keys:s=`Unrecognized key(s) in object: ${U.joinValues(t.keys,", ")}`;break;case T.invalid_union:s="Invalid input";break;case T.invalid_union_discriminator:s=`Invalid discriminator value. Expected ${U.joinValues(t.options)}`;break;case T.invalid_enum_value:s=`Invalid enum value. Expected ${U.joinValues(t.options)}, received '${t.received}'`;break;case T.invalid_arguments:s="Invalid function arguments";break;case T.invalid_return_type:s="Invalid function return type";break;case T.invalid_date:s="Invalid date";break;case T.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(s=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(s=`${s} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?s=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?s=`Invalid input: must end with "${t.validation.endsWith}"`:U.assertNever(t.validation):t.validation!=="regex"?s=`Invalid ${t.validation}`:s="Invalid";break;case T.too_small:t.type==="array"?s=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?s=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?s=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="bigint"?s=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?s=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:s="Invalid input";break;case T.too_big:t.type==="array"?s=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?s=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?s=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?s=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?s=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:s="Invalid input";break;case T.custom:s="Invalid input";break;case T.invalid_intersection_types:s="Intersection results could not be merged";break;case T.not_multiple_of:s=`Number must be a multiple of ${t.multipleOf}`;break;case T.not_finite:s="Number must be finite";break;default:s=e.defaultError,U.assertNever(t)}return{message:s}},"errorMap"),he=Ui});function ji(t){Fa=t}function nt(){return Fa}var Fa,Gt=K(()=>{_();w();y();Os();Fa=he;u(ji,"setErrorMap");u(nt,"getErrorMap")});function I(t,e){let s=nt(),a=Ot({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,s,s===he?void 0:he].filter(n=>!!n)});t.common.issues.push(a)}var Ot,Ki,z,k,Ce,Y,zt,Yt,Te,rt,ks=K(()=>{_();w();y();Gt();Os();Ot=u(t=>{let{data:e,path:s,errorMaps:a,issueData:n}=t,o=[...s,...n.path||[]],m={...n,path:o};if(n.message!==void 0)return{...n,path:o,message:n.message};let r="",c=a.filter(h=>!!h).slice().reverse();for(let h of c)r=h(m,{data:e,defaultError:r}).message;return{...n,path:o,message:r}},"makeIssue"),Ki=[];u(I,"addIssueToContext");z=class t{static{u(this,"ParseStatus")}constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,s){let a=[];for(let n of s){if(n.status==="aborted")return k;n.status==="dirty"&&e.dirty(),a.push(n.value)}return{status:e.value,value:a}}static async mergeObjectAsync(e,s){let a=[];for(let n of s){let o=await n.key,m=await n.value;a.push({key:o,value:m})}return t.mergeObjectSync(e,a)}static mergeObjectSync(e,s){let a={};for(let n of s){let{key:o,value:m}=n;if(o.status==="aborted"||m.status==="aborted")return k;o.status==="dirty"&&e.dirty(),m.status==="dirty"&&e.dirty(),o.value!=="__proto__"&&(typeof m.value<"u"||n.alwaysSet)&&(a[o.value]=m.value)}return{status:e.value,value:a}}},k=Object.freeze({status:"aborted"}),Ce=u(t=>({status:"dirty",value:t}),"DIRTY"),Y=u(t=>({status:"valid",value:t}),"OK"),zt=u(t=>t.status==="aborted","isAborted"),Yt=u(t=>t.status==="dirty","isDirty"),Te=u(t=>t.status==="valid","isValid"),rt=u(t=>typeof Promise<"u"&&t instanceof Promise,"isAsync")});var Wa=K(()=>{_();w();y()});var A,Ba=K(()=>{_();w();y();(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e?.message})(A||(A={}))});function $(t){if(!t)return{};let{errorMap:e,invalid_type_error:s,required_error:a,description:n}=t;if(e&&(s||a))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:n}:{errorMap:u((m,r)=>{let{message:c}=t;return m.code==="invalid_enum_value"?{message:c??r.defaultError}:typeof r.data>"u"?{message:c??a??r.defaultError}:m.code!=="invalid_type"?{message:r.defaultError}:{message:c??s??r.defaultError}},"customMap"),description:n}}function za(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);let s=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${s}`}function ac(t){return new RegExp(`^${za(t)}$`)}function Ya(t){let e=`${Ga}T${za(t)}`,s=[];return s.push(t.local?"Z?":"Z"),t.offset&&s.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${s.join("|")})`,new RegExp(`^${e}$`)}function nc(t,e){return!!((e==="v4"||!e)&&Zi.test(t)||(e==="v6"||!e)&&Qi.test(t))}function rc(t,e){if(!Hi.test(t))return!1;try{let[s]=t.split(".");if(!s)return!1;let a=s.replace(/-/g,"+").replace(/_/g,"/").padEnd(s.length+(4-s.length%4)%4,"="),n=JSON.parse(atob(a));return!(typeof n!="object"||n===null||"typ"in n&&n?.typ!=="JWT"||!n.alg||e&&n.alg!==e)}catch{return!1}}function oc(t,e){return!!((e==="v4"||!e)&&Xi.test(t)||(e==="v6"||!e)&&qi.test(t))}function ic(t,e){let s=(t.toString().split(".")[1]||"").length,a=(e.toString().split(".")[1]||"").length,n=s>a?s:a,o=Number.parseInt(t.toFixed(n).replace(".","")),m=Number.parseInt(e.toFixed(n).replace(".",""));return o%m/10**n}function ot(t){if(t instanceof X){let e={};for(let s in t.shape){let a=t.shape[s];e[s]=ee.create(ot(a))}return new X({...t._def,shape:u(()=>e,"shape")})}else return t instanceof we?new we({...t._def,type:ot(t.element)}):t instanceof ee?ee.create(ot(t.unwrap())):t instanceof pe?pe.create(ot(t.unwrap())):t instanceof le?le.create(t.items.map(e=>ot(e))):t}function Ds(t,e){let s=de(t),a=de(e);if(t===e)return{valid:!0,data:t};if(s===R.object&&a===R.object){let n=U.objectKeys(e),o=U.objectKeys(t).filter(r=>n.indexOf(r)!==-1),m={...t,...e};for(let r of o){let c=Ds(t[r],e[r]);if(!c.valid)return{valid:!1};m[r]=c.data}return{valid:!0,data:m}}else if(s===R.array&&a===R.array){if(t.length!==e.length)return{valid:!1};let n=[];for(let o=0;o<t.length;o++){let m=t[o],r=e[o],c=Ds(m,r);if(!c.valid)return{valid:!1};n.push(c.data)}return{valid:!0,data:n}}else return s===R.date&&a===R.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}function Za(t,e){return new We({values:t,typeName:C.ZodEnum,...$(e)})}function Ha(t,e){let s=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof s=="string"?{message:s}:s}function Xa(t,e={},s){return t?Ie.create().superRefine((a,n)=>{let o=t(a);if(o instanceof Promise)return o.then(m=>{if(!m){let r=Ha(e,a),c=r.fatal??s??!0;n.addIssue({code:"custom",...r,fatal:c})}});if(!o){let m=Ha(e,a),r=m.fatal??s??!0;n.addIssue({code:"custom",...m,fatal:r})}}):Ie.create()}var te,Ja,M,Vi,Fi,Wi,Bi,Ji,Hi,Gi,zi,Yi,Cs,Zi,Xi,Qi,qi,ec,tc,Ga,sc,xe,De,Ne,$e,Me,it,Le,Ue,Ie,ye,ce,ct,we,X,je,ge,Zt,Ke,le,Xt,ut,dt,Qt,Ve,Fe,We,Be,Re,se,ee,pe,Je,He,lt,cc,kt,Ct,Ge,uc,C,dc,Qa,qa,lc,pc,en,mc,fc,hc,gc,yc,wc,_c,Ec,bc,Sc,Tc,xc,Ic,Rc,vc,Pc,Ac,Oc,kc,Cc,Dc,Nc,$c,Mc,Lc,Uc,jc,Kc,Vc,Fc,Wc,Bc,Jc,Hc,tn=K(()=>{_();w();y();Ht();Gt();Ba();ks();At();te=class{static{u(this,"ParseInputLazyPath")}constructor(e,s,a,n){this._cachedPath=[],this.parent=e,this.data=s,this._path=a,this._key=n}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Ja=u((t,e)=>{if(Te(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let s=new Z(t.common.issues);return this._error=s,this._error}}},"handleResult");u($,"processCreateParams");M=class{static{u(this,"ZodType")}get description(){return this._def.description}_getType(e){return de(e.data)}_getOrReturnCtx(e,s){return s||{common:e.parent.common,data:e.data,parsedType:de(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new z,ctx:{common:e.parent.common,data:e.data,parsedType:de(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let s=this._parse(e);if(rt(s))throw new Error("Synchronous parse encountered promise.");return s}_parseAsync(e){let s=this._parse(e);return Promise.resolve(s)}parse(e,s){let a=this.safeParse(e,s);if(a.success)return a.data;throw a.error}safeParse(e,s){let a={common:{issues:[],async:s?.async??!1,contextualErrorMap:s?.errorMap},path:s?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:de(e)},n=this._parseSync({data:e,path:a.path,parent:a});return Ja(a,n)}"~validate"(e){let s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:de(e)};if(!this["~standard"].async)try{let a=this._parseSync({data:e,path:[],parent:s});return Te(a)?{value:a.value}:{issues:s.common.issues}}catch(a){a?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(a=>Te(a)?{value:a.value}:{issues:s.common.issues})}async parseAsync(e,s){let a=await this.safeParseAsync(e,s);if(a.success)return a.data;throw a.error}async safeParseAsync(e,s){let a={common:{issues:[],contextualErrorMap:s?.errorMap,async:!0},path:s?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:de(e)},n=this._parse({data:e,path:a.path,parent:a}),o=await(rt(n)?n:Promise.resolve(n));return Ja(a,o)}refine(e,s){let a=u(n=>typeof s=="string"||typeof s>"u"?{message:s}:typeof s=="function"?s(n):s,"getIssueProperties");return this._refinement((n,o)=>{let m=e(n),r=u(()=>o.addIssue({code:T.custom,...a(n)}),"setError");return typeof Promise<"u"&&m instanceof Promise?m.then(c=>c?!0:(r(),!1)):m?!0:(r(),!1)})}refinement(e,s){return this._refinement((a,n)=>e(a)?!0:(n.addIssue(typeof s=="function"?s(a,n):s),!1))}_refinement(e){return new se({schema:this,typeName:C.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:u(s=>this["~validate"](s),"validate")}}optional(){return ee.create(this,this._def)}nullable(){return pe.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return we.create(this)}promise(){return Re.create(this,this._def)}or(e){return je.create([this,e],this._def)}and(e){return Ke.create(this,e,this._def)}transform(e){return new se({...$(this._def),schema:this,typeName:C.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let s=typeof e=="function"?e:()=>e;return new Je({...$(this._def),innerType:this,defaultValue:s,typeName:C.ZodDefault})}brand(){return new kt({typeName:C.ZodBranded,type:this,...$(this._def)})}catch(e){let s=typeof e=="function"?e:()=>e;return new He({...$(this._def),innerType:this,catchValue:s,typeName:C.ZodCatch})}describe(e){let s=this.constructor;return new s({...this._def,description:e})}pipe(e){return Ct.create(this,e)}readonly(){return Ge.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Vi=/^c[^\s-]{8,}$/i,Fi=/^[0-9a-z]+$/,Wi=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Bi=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Ji=/^[a-z0-9_-]{21}$/i,Hi=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,Gi=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,zi=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Yi="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",Zi=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Xi=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Qi=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,qi=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ec=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,tc=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ga="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",sc=new RegExp(`^${Ga}$`);u(za,"timeRegexSource");u(ac,"timeRegex");u(Ya,"datetimeRegex");u(nc,"isValidIP");u(rc,"isValidJWT");u(oc,"isValidCidr");xe=class t extends M{static{u(this,"ZodString")}_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==R.string){let o=this._getOrReturnCtx(e);return I(o,{code:T.invalid_type,expected:R.string,received:o.parsedType}),k}let a=new z,n;for(let o of this._def.checks)if(o.kind==="min")e.data.length<o.value&&(n=this._getOrReturnCtx(e,n),I(n,{code:T.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),a.dirty());else if(o.kind==="max")e.data.length>o.value&&(n=this._getOrReturnCtx(e,n),I(n,{code:T.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!1,message:o.message}),a.dirty());else if(o.kind==="length"){let m=e.data.length>o.value,r=e.data.length<o.value;(m||r)&&(n=this._getOrReturnCtx(e,n),m?I(n,{code:T.too_big,maximum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}):r&&I(n,{code:T.too_small,minimum:o.value,type:"string",inclusive:!0,exact:!0,message:o.message}),a.dirty())}else if(o.kind==="email")zi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"email",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="emoji")Cs||(Cs=new RegExp(Yi,"u")),Cs.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"emoji",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="uuid")Bi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"uuid",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="nanoid")Ji.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"nanoid",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="cuid")Vi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"cuid",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="cuid2")Fi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"cuid2",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="ulid")Wi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"ulid",code:T.invalid_string,message:o.message}),a.dirty());else if(o.kind==="url")try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),I(n,{validation:"url",code:T.invalid_string,message:o.message}),a.dirty()}else o.kind==="regex"?(o.regex.lastIndex=0,o.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"regex",code:T.invalid_string,message:o.message}),a.dirty())):o.kind==="trim"?e.data=e.data.trim():o.kind==="includes"?e.data.includes(o.value,o.position)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:{includes:o.value,position:o.position},message:o.message}),a.dirty()):o.kind==="toLowerCase"?e.data=e.data.toLowerCase():o.kind==="toUpperCase"?e.data=e.data.toUpperCase():o.kind==="startsWith"?e.data.startsWith(o.value)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:{startsWith:o.value},message:o.message}),a.dirty()):o.kind==="endsWith"?e.data.endsWith(o.value)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:{endsWith:o.value},message:o.message}),a.dirty()):o.kind==="datetime"?Ya(o).test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:"datetime",message:o.message}),a.dirty()):o.kind==="date"?sc.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:"date",message:o.message}),a.dirty()):o.kind==="time"?ac(o).test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{code:T.invalid_string,validation:"time",message:o.message}),a.dirty()):o.kind==="duration"?Gi.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"duration",code:T.invalid_string,message:o.message}),a.dirty()):o.kind==="ip"?nc(e.data,o.version)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"ip",code:T.invalid_string,message:o.message}),a.dirty()):o.kind==="jwt"?rc(e.data,o.alg)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"jwt",code:T.invalid_string,message:o.message}),a.dirty()):o.kind==="cidr"?oc(e.data,o.version)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"cidr",code:T.invalid_string,message:o.message}),a.dirty()):o.kind==="base64"?ec.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"base64",code:T.invalid_string,message:o.message}),a.dirty()):o.kind==="base64url"?tc.test(e.data)||(n=this._getOrReturnCtx(e,n),I(n,{validation:"base64url",code:T.invalid_string,message:o.message}),a.dirty()):U.assertNever(o);return{status:a.value,value:e.data}}_regex(e,s,a){return this.refinement(n=>e.test(n),{validation:s,code:T.invalid_string,...A.errToObj(a)})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...A.errToObj(e)})}url(e){return this._addCheck({kind:"url",...A.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...A.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...A.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...A.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...A.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...A.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...A.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...A.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...A.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...A.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...A.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...A.errToObj(e)})}datetime(e){return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof e?.precision>"u"?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...A.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof e?.precision>"u"?null:e?.precision,...A.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...A.errToObj(e)})}regex(e,s){return this._addCheck({kind:"regex",regex:e,...A.errToObj(s)})}includes(e,s){return this._addCheck({kind:"includes",value:e,position:s?.position,...A.errToObj(s?.message)})}startsWith(e,s){return this._addCheck({kind:"startsWith",value:e,...A.errToObj(s)})}endsWith(e,s){return this._addCheck({kind:"endsWith",value:e,...A.errToObj(s)})}min(e,s){return this._addCheck({kind:"min",value:e,...A.errToObj(s)})}max(e,s){return this._addCheck({kind:"max",value:e,...A.errToObj(s)})}length(e,s){return this._addCheck({kind:"length",value:e,...A.errToObj(s)})}nonempty(e){return this.min(1,A.errToObj(e))}trim(){return new t({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new t({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(let s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxLength(){let e=null;for(let s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}};xe.create=t=>new xe({checks:[],typeName:C.ZodString,coerce:t?.coerce??!1,...$(t)});u(ic,"floatSafeRemainder");De=class t extends M{static{u(this,"ZodNumber")}constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==R.number){let o=this._getOrReturnCtx(e);return I(o,{code:T.invalid_type,expected:R.number,received:o.parsedType}),k}let a,n=new z;for(let o of this._def.checks)o.kind==="int"?U.isInteger(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:T.invalid_type,expected:"integer",received:"float",message:o.message}),n.dirty()):o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.too_small,minimum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.too_big,maximum:o.value,type:"number",inclusive:o.inclusive,exact:!1,message:o.message}),n.dirty()):o.kind==="multipleOf"?ic(e.data,o.value)!==0&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):o.kind==="finite"?Number.isFinite(e.data)||(a=this._getOrReturnCtx(e,a),I(a,{code:T.not_finite,message:o.message}),n.dirty()):U.assertNever(o);return{status:n.value,value:e.data}}gte(e,s){return this.setLimit("min",e,!0,A.toString(s))}gt(e,s){return this.setLimit("min",e,!1,A.toString(s))}lte(e,s){return this.setLimit("max",e,!0,A.toString(s))}lt(e,s){return this.setLimit("max",e,!1,A.toString(s))}setLimit(e,s,a,n){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:a,message:A.toString(n)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:A.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:A.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:A.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:A.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:A.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:A.toString(s)})}finite(e){return this._addCheck({kind:"finite",message:A.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:A.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:A.toString(e)})}get minValue(){let e=null;for(let s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(let s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&U.isInteger(e.value))}get isFinite(){let e=null,s=null;for(let a of this._def.checks){if(a.kind==="finite"||a.kind==="int"||a.kind==="multipleOf")return!0;a.kind==="min"?(s===null||a.value>s)&&(s=a.value):a.kind==="max"&&(e===null||a.value<e)&&(e=a.value)}return Number.isFinite(s)&&Number.isFinite(e)}};De.create=t=>new De({checks:[],typeName:C.ZodNumber,coerce:t?.coerce||!1,...$(t)});Ne=class t extends M{static{u(this,"ZodBigInt")}constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==R.bigint)return this._getInvalidInput(e);let a,n=new z;for(let o of this._def.checks)o.kind==="min"?(o.inclusive?e.data<o.value:e.data<=o.value)&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.too_small,type:"bigint",minimum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="max"?(o.inclusive?e.data>o.value:e.data>=o.value)&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.too_big,type:"bigint",maximum:o.value,inclusive:o.inclusive,message:o.message}),n.dirty()):o.kind==="multipleOf"?e.data%o.value!==BigInt(0)&&(a=this._getOrReturnCtx(e,a),I(a,{code:T.not_multiple_of,multipleOf:o.value,message:o.message}),n.dirty()):U.assertNever(o);return{status:n.value,value:e.data}}_getInvalidInput(e){let s=this._getOrReturnCtx(e);return I(s,{code:T.invalid_type,expected:R.bigint,received:s.parsedType}),k}gte(e,s){return this.setLimit("min",e,!0,A.toString(s))}gt(e,s){return this.setLimit("min",e,!1,A.toString(s))}lte(e,s){return this.setLimit("max",e,!0,A.toString(s))}lt(e,s){return this.setLimit("max",e,!1,A.toString(s))}setLimit(e,s,a,n){return new t({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:a,message:A.toString(n)}]})}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:A.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:A.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:A.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:A.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:A.toString(s)})}get minValue(){let e=null;for(let s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(let s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e}};Ne.create=t=>new Ne({checks:[],typeName:C.ZodBigInt,coerce:t?.coerce??!1,...$(t)});$e=class extends M{static{u(this,"ZodBoolean")}_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==R.boolean){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.boolean,received:a.parsedType}),k}return Y(e.data)}};$e.create=t=>new $e({typeName:C.ZodBoolean,coerce:t?.coerce||!1,...$(t)});Me=class t extends M{static{u(this,"ZodDate")}_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==R.date){let o=this._getOrReturnCtx(e);return I(o,{code:T.invalid_type,expected:R.date,received:o.parsedType}),k}if(Number.isNaN(e.data.getTime())){let o=this._getOrReturnCtx(e);return I(o,{code:T.invalid_date}),k}let a=new z,n;for(let o of this._def.checks)o.kind==="min"?e.data.getTime()<o.value&&(n=this._getOrReturnCtx(e,n),I(n,{code:T.too_small,message:o.message,inclusive:!0,exact:!1,minimum:o.value,type:"date"}),a.dirty()):o.kind==="max"?e.data.getTime()>o.value&&(n=this._getOrReturnCtx(e,n),I(n,{code:T.too_big,message:o.message,inclusive:!0,exact:!1,maximum:o.value,type:"date"}),a.dirty()):U.assertNever(o);return{status:a.value,value:new Date(e.data.getTime())}}_addCheck(e){return new t({...this._def,checks:[...this._def.checks,e]})}min(e,s){return this._addCheck({kind:"min",value:e.getTime(),message:A.toString(s)})}max(e,s){return this._addCheck({kind:"max",value:e.getTime(),message:A.toString(s)})}get minDate(){let e=null;for(let s of this._def.checks)s.kind==="min"&&(e===null||s.value>e)&&(e=s.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let s of this._def.checks)s.kind==="max"&&(e===null||s.value<e)&&(e=s.value);return e!=null?new Date(e):null}};Me.create=t=>new Me({checks:[],coerce:t?.coerce||!1,typeName:C.ZodDate,...$(t)});it=class extends M{static{u(this,"ZodSymbol")}_parse(e){if(this._getType(e)!==R.symbol){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.symbol,received:a.parsedType}),k}return Y(e.data)}};it.create=t=>new it({typeName:C.ZodSymbol,...$(t)});Le=class extends M{static{u(this,"ZodUndefined")}_parse(e){if(this._getType(e)!==R.undefined){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.undefined,received:a.parsedType}),k}return Y(e.data)}};Le.create=t=>new Le({typeName:C.ZodUndefined,...$(t)});Ue=class extends M{static{u(this,"ZodNull")}_parse(e){if(this._getType(e)!==R.null){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.null,received:a.parsedType}),k}return Y(e.data)}};Ue.create=t=>new Ue({typeName:C.ZodNull,...$(t)});Ie=class extends M{static{u(this,"ZodAny")}constructor(){super(...arguments),this._any=!0}_parse(e){return Y(e.data)}};Ie.create=t=>new Ie({typeName:C.ZodAny,...$(t)});ye=class extends M{static{u(this,"ZodUnknown")}constructor(){super(...arguments),this._unknown=!0}_parse(e){return Y(e.data)}};ye.create=t=>new ye({typeName:C.ZodUnknown,...$(t)});ce=class extends M{static{u(this,"ZodNever")}_parse(e){let s=this._getOrReturnCtx(e);return I(s,{code:T.invalid_type,expected:R.never,received:s.parsedType}),k}};ce.create=t=>new ce({typeName:C.ZodNever,...$(t)});ct=class extends M{static{u(this,"ZodVoid")}_parse(e){if(this._getType(e)!==R.undefined){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.void,received:a.parsedType}),k}return Y(e.data)}};ct.create=t=>new ct({typeName:C.ZodVoid,...$(t)});we=class t extends M{static{u(this,"ZodArray")}_parse(e){let{ctx:s,status:a}=this._processInputParams(e),n=this._def;if(s.parsedType!==R.array)return I(s,{code:T.invalid_type,expected:R.array,received:s.parsedType}),k;if(n.exactLength!==null){let m=s.data.length>n.exactLength.value,r=s.data.length<n.exactLength.value;(m||r)&&(I(s,{code:m?T.too_big:T.too_small,minimum:r?n.exactLength.value:void 0,maximum:m?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),a.dirty())}if(n.minLength!==null&&s.data.length<n.minLength.value&&(I(s,{code:T.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),a.dirty()),n.maxLength!==null&&s.data.length>n.maxLength.value&&(I(s,{code:T.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),a.dirty()),s.common.async)return Promise.all([...s.data].map((m,r)=>n.type._parseAsync(new te(s,m,s.path,r)))).then(m=>z.mergeArray(a,m));let o=[...s.data].map((m,r)=>n.type._parseSync(new te(s,m,s.path,r)));return z.mergeArray(a,o)}get element(){return this._def.type}min(e,s){return new t({...this._def,minLength:{value:e,message:A.toString(s)}})}max(e,s){return new t({...this._def,maxLength:{value:e,message:A.toString(s)}})}length(e,s){return new t({...this._def,exactLength:{value:e,message:A.toString(s)}})}nonempty(e){return this.min(1,e)}};we.create=(t,e)=>new we({type:t,minLength:null,maxLength:null,exactLength:null,typeName:C.ZodArray,...$(e)});u(ot,"deepPartialify");X=class t extends M{static{u(this,"ZodObject")}constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),s=U.objectKeys(e);return this._cached={shape:e,keys:s},this._cached}_parse(e){if(this._getType(e)!==R.object){let h=this._getOrReturnCtx(e);return I(h,{code:T.invalid_type,expected:R.object,received:h.parsedType}),k}let{status:a,ctx:n}=this._processInputParams(e),{shape:o,keys:m}=this._getCached(),r=[];if(!(this._def.catchall instanceof ce&&this._def.unknownKeys==="strip"))for(let h in n.data)m.includes(h)||r.push(h);let c=[];for(let h of m){let x=o[h],P=n.data[h];c.push({key:{status:"valid",value:h},value:x._parse(new te(n,P,n.path,h)),alwaysSet:h in n.data})}if(this._def.catchall instanceof ce){let h=this._def.unknownKeys;if(h==="passthrough")for(let x of r)c.push({key:{status:"valid",value:x},value:{status:"valid",value:n.data[x]}});else if(h==="strict")r.length>0&&(I(n,{code:T.unrecognized_keys,keys:r}),a.dirty());else if(h!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let h=this._def.catchall;for(let x of r){let P=n.data[x];c.push({key:{status:"valid",value:x},value:h._parse(new te(n,P,n.path,x)),alwaysSet:x in n.data})}}return n.common.async?Promise.resolve().then(async()=>{let h=[];for(let x of c){let P=await x.key,N=await x.value;h.push({key:P,value:N,alwaysSet:x.alwaysSet})}return h}).then(h=>z.mergeObjectSync(a,h)):z.mergeObjectSync(a,c)}get shape(){return this._def.shape()}strict(e){return A.errToObj,new t({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:u((s,a)=>{let n=this._def.errorMap?.(s,a).message??a.defaultError;return s.code==="unrecognized_keys"?{message:A.errToObj(e).message??n}:{message:n}},"errorMap")}:{}})}strip(){return new t({...this._def,unknownKeys:"strip"})}passthrough(){return new t({...this._def,unknownKeys:"passthrough"})}extend(e){return new t({...this._def,shape:u(()=>({...this._def.shape(),...e}),"shape")})}merge(e){return new t({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:u(()=>({...this._def.shape(),...e._def.shape()}),"shape"),typeName:C.ZodObject})}setKey(e,s){return this.augment({[e]:s})}catchall(e){return new t({...this._def,catchall:e})}pick(e){let s={};for(let a of U.objectKeys(e))e[a]&&this.shape[a]&&(s[a]=this.shape[a]);return new t({...this._def,shape:u(()=>s,"shape")})}omit(e){let s={};for(let a of U.objectKeys(this.shape))e[a]||(s[a]=this.shape[a]);return new t({...this._def,shape:u(()=>s,"shape")})}deepPartial(){return ot(this)}partial(e){let s={};for(let a of U.objectKeys(this.shape)){let n=this.shape[a];e&&!e[a]?s[a]=n:s[a]=n.optional()}return new t({...this._def,shape:u(()=>s,"shape")})}required(e){let s={};for(let a of U.objectKeys(this.shape))if(e&&!e[a])s[a]=this.shape[a];else{let o=this.shape[a];for(;o instanceof ee;)o=o._def.innerType;s[a]=o}return new t({...this._def,shape:u(()=>s,"shape")})}keyof(){return Za(U.objectKeys(this.shape))}};X.create=(t,e)=>new X({shape:u(()=>t,"shape"),unknownKeys:"strip",catchall:ce.create(),typeName:C.ZodObject,...$(e)});X.strictCreate=(t,e)=>new X({shape:u(()=>t,"shape"),unknownKeys:"strict",catchall:ce.create(),typeName:C.ZodObject,...$(e)});X.lazycreate=(t,e)=>new X({shape:t,unknownKeys:"strip",catchall:ce.create(),typeName:C.ZodObject,...$(e)});je=class extends M{static{u(this,"ZodUnion")}_parse(e){let{ctx:s}=this._processInputParams(e),a=this._def.options;function n(o){for(let r of o)if(r.result.status==="valid")return r.result;for(let r of o)if(r.result.status==="dirty")return s.common.issues.push(...r.ctx.common.issues),r.result;let m=o.map(r=>new Z(r.ctx.common.issues));return I(s,{code:T.invalid_union,unionErrors:m}),k}if(u(n,"handleResults"),s.common.async)return Promise.all(a.map(async o=>{let m={...s,common:{...s.common,issues:[]},parent:null};return{result:await o._parseAsync({data:s.data,path:s.path,parent:m}),ctx:m}})).then(n);{let o,m=[];for(let c of a){let h={...s,common:{...s.common,issues:[]},parent:null},x=c._parseSync({data:s.data,path:s.path,parent:h});if(x.status==="valid")return x;x.status==="dirty"&&!o&&(o={result:x,ctx:h}),h.common.issues.length&&m.push(h.common.issues)}if(o)return s.common.issues.push(...o.ctx.common.issues),o.result;let r=m.map(c=>new Z(c));return I(s,{code:T.invalid_union,unionErrors:r}),k}}get options(){return this._def.options}};je.create=(t,e)=>new je({options:t,typeName:C.ZodUnion,...$(e)});ge=u(t=>t instanceof Ve?ge(t.schema):t instanceof se?ge(t.innerType()):t instanceof Fe?[t.value]:t instanceof We?t.options:t instanceof Be?U.objectValues(t.enum):t instanceof Je?ge(t._def.innerType):t instanceof Le?[void 0]:t instanceof Ue?[null]:t instanceof ee?[void 0,...ge(t.unwrap())]:t instanceof pe?[null,...ge(t.unwrap())]:t instanceof kt||t instanceof Ge?ge(t.unwrap()):t instanceof He?ge(t._def.innerType):[],"getDiscriminator"),Zt=class t extends M{static{u(this,"ZodDiscriminatedUnion")}_parse(e){let{ctx:s}=this._processInputParams(e);if(s.parsedType!==R.object)return I(s,{code:T.invalid_type,expected:R.object,received:s.parsedType}),k;let a=this.discriminator,n=s.data[a],o=this.optionsMap.get(n);return o?s.common.async?o._parseAsync({data:s.data,path:s.path,parent:s}):o._parseSync({data:s.data,path:s.path,parent:s}):(I(s,{code:T.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[a]}),k)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,s,a){let n=new Map;for(let o of s){let m=ge(o.shape[e]);if(!m.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let r of m){if(n.has(r))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(r)}`);n.set(r,o)}}return new t({typeName:C.ZodDiscriminatedUnion,discriminator:e,options:s,optionsMap:n,...$(a)})}};u(Ds,"mergeValues");Ke=class extends M{static{u(this,"ZodIntersection")}_parse(e){let{status:s,ctx:a}=this._processInputParams(e),n=u((o,m)=>{if(zt(o)||zt(m))return k;let r=Ds(o.value,m.value);return r.valid?((Yt(o)||Yt(m))&&s.dirty(),{status:s.value,value:r.data}):(I(a,{code:T.invalid_intersection_types}),k)},"handleParsed");return a.common.async?Promise.all([this._def.left._parseAsync({data:a.data,path:a.path,parent:a}),this._def.right._parseAsync({data:a.data,path:a.path,parent:a})]).then(([o,m])=>n(o,m)):n(this._def.left._parseSync({data:a.data,path:a.path,parent:a}),this._def.right._parseSync({data:a.data,path:a.path,parent:a}))}};Ke.create=(t,e,s)=>new Ke({left:t,right:e,typeName:C.ZodIntersection,...$(s)});le=class t extends M{static{u(this,"ZodTuple")}_parse(e){let{status:s,ctx:a}=this._processInputParams(e);if(a.parsedType!==R.array)return I(a,{code:T.invalid_type,expected:R.array,received:a.parsedType}),k;if(a.data.length<this._def.items.length)return I(a,{code:T.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),k;!this._def.rest&&a.data.length>this._def.items.length&&(I(a,{code:T.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),s.dirty());let o=[...a.data].map((m,r)=>{let c=this._def.items[r]||this._def.rest;return c?c._parse(new te(a,m,a.path,r)):null}).filter(m=>!!m);return a.common.async?Promise.all(o).then(m=>z.mergeArray(s,m)):z.mergeArray(s,o)}get items(){return this._def.items}rest(e){return new t({...this._def,rest:e})}};le.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new le({items:t,typeName:C.ZodTuple,rest:null,...$(e)})};Xt=class t extends M{static{u(this,"ZodRecord")}get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:s,ctx:a}=this._processInputParams(e);if(a.parsedType!==R.object)return I(a,{code:T.invalid_type,expected:R.object,received:a.parsedType}),k;let n=[],o=this._def.keyType,m=this._def.valueType;for(let r in a.data)n.push({key:o._parse(new te(a,r,a.path,r)),value:m._parse(new te(a,a.data[r],a.path,r)),alwaysSet:r in a.data});return a.common.async?z.mergeObjectAsync(s,n):z.mergeObjectSync(s,n)}get element(){return this._def.valueType}static create(e,s,a){return s instanceof M?new t({keyType:e,valueType:s,typeName:C.ZodRecord,...$(a)}):new t({keyType:xe.create(),valueType:e,typeName:C.ZodRecord,...$(s)})}},ut=class extends M{static{u(this,"ZodMap")}get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:s,ctx:a}=this._processInputParams(e);if(a.parsedType!==R.map)return I(a,{code:T.invalid_type,expected:R.map,received:a.parsedType}),k;let n=this._def.keyType,o=this._def.valueType,m=[...a.data.entries()].map(([r,c],h)=>({key:n._parse(new te(a,r,a.path,[h,"key"])),value:o._parse(new te(a,c,a.path,[h,"value"]))}));if(a.common.async){let r=new Map;return Promise.resolve().then(async()=>{for(let c of m){let h=await c.key,x=await c.value;if(h.status==="aborted"||x.status==="aborted")return k;(h.status==="dirty"||x.status==="dirty")&&s.dirty(),r.set(h.value,x.value)}return{status:s.value,value:r}})}else{let r=new Map;for(let c of m){let h=c.key,x=c.value;if(h.status==="aborted"||x.status==="aborted")return k;(h.status==="dirty"||x.status==="dirty")&&s.dirty(),r.set(h.value,x.value)}return{status:s.value,value:r}}}};ut.create=(t,e,s)=>new ut({valueType:e,keyType:t,typeName:C.ZodMap,...$(s)});dt=class t extends M{static{u(this,"ZodSet")}_parse(e){let{status:s,ctx:a}=this._processInputParams(e);if(a.parsedType!==R.set)return I(a,{code:T.invalid_type,expected:R.set,received:a.parsedType}),k;let n=this._def;n.minSize!==null&&a.data.size<n.minSize.value&&(I(a,{code:T.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),s.dirty()),n.maxSize!==null&&a.data.size>n.maxSize.value&&(I(a,{code:T.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),s.dirty());let o=this._def.valueType;function m(c){let h=new Set;for(let x of c){if(x.status==="aborted")return k;x.status==="dirty"&&s.dirty(),h.add(x.value)}return{status:s.value,value:h}}u(m,"finalizeSet");let r=[...a.data.values()].map((c,h)=>o._parse(new te(a,c,a.path,h)));return a.common.async?Promise.all(r).then(c=>m(c)):m(r)}min(e,s){return new t({...this._def,minSize:{value:e,message:A.toString(s)}})}max(e,s){return new t({...this._def,maxSize:{value:e,message:A.toString(s)}})}size(e,s){return this.min(e,s).max(e,s)}nonempty(e){return this.min(1,e)}};dt.create=(t,e)=>new dt({valueType:t,minSize:null,maxSize:null,typeName:C.ZodSet,...$(e)});Qt=class t extends M{static{u(this,"ZodFunction")}constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:s}=this._processInputParams(e);if(s.parsedType!==R.function)return I(s,{code:T.invalid_type,expected:R.function,received:s.parsedType}),k;function a(r,c){return Ot({data:r,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,nt(),he].filter(h=>!!h),issueData:{code:T.invalid_arguments,argumentsError:c}})}u(a,"makeArgsIssue");function n(r,c){return Ot({data:r,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,nt(),he].filter(h=>!!h),issueData:{code:T.invalid_return_type,returnTypeError:c}})}u(n,"makeReturnsIssue");let o={errorMap:s.common.contextualErrorMap},m=s.data;if(this._def.returns instanceof Re){let r=this;return Y(async function(...c){let h=new Z([]),x=await r._def.args.parseAsync(c,o).catch(i=>{throw h.addIssue(a(c,i)),h}),P=await Reflect.apply(m,this,x);return await r._def.returns._def.type.parseAsync(P,o).catch(i=>{throw h.addIssue(n(P,i)),h})})}else{let r=this;return Y(function(...c){let h=r._def.args.safeParse(c,o);if(!h.success)throw new Z([a(c,h.error)]);let x=Reflect.apply(m,this,h.data),P=r._def.returns.safeParse(x,o);if(!P.success)throw new Z([n(x,P.error)]);return P.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new t({...this._def,args:le.create(e).rest(ye.create())})}returns(e){return new t({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,s,a){return new t({args:e||le.create([]).rest(ye.create()),returns:s||ye.create(),typeName:C.ZodFunction,...$(a)})}},Ve=class extends M{static{u(this,"ZodLazy")}get schema(){return this._def.getter()}_parse(e){let{ctx:s}=this._processInputParams(e);return this._def.getter()._parse({data:s.data,path:s.path,parent:s})}};Ve.create=(t,e)=>new Ve({getter:t,typeName:C.ZodLazy,...$(e)});Fe=class extends M{static{u(this,"ZodLiteral")}_parse(e){if(e.data!==this._def.value){let s=this._getOrReturnCtx(e);return I(s,{received:s.data,code:T.invalid_literal,expected:this._def.value}),k}return{status:"valid",value:e.data}}get value(){return this._def.value}};Fe.create=(t,e)=>new Fe({value:t,typeName:C.ZodLiteral,...$(e)});u(Za,"createZodEnum");We=class t extends M{static{u(this,"ZodEnum")}_parse(e){if(typeof e.data!="string"){let s=this._getOrReturnCtx(e),a=this._def.values;return I(s,{expected:U.joinValues(a),received:s.parsedType,code:T.invalid_type}),k}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){let s=this._getOrReturnCtx(e),a=this._def.values;return I(s,{received:s.data,code:T.invalid_enum_value,options:a}),k}return Y(e.data)}get options(){return this._def.values}get enum(){let e={};for(let s of this._def.values)e[s]=s;return e}get Values(){let e={};for(let s of this._def.values)e[s]=s;return e}get Enum(){let e={};for(let s of this._def.values)e[s]=s;return e}extract(e,s=this._def){return t.create(e,{...this._def,...s})}exclude(e,s=this._def){return t.create(this.options.filter(a=>!e.includes(a)),{...this._def,...s})}};We.create=Za;Be=class extends M{static{u(this,"ZodNativeEnum")}_parse(e){let s=U.getValidEnumValues(this._def.values),a=this._getOrReturnCtx(e);if(a.parsedType!==R.string&&a.parsedType!==R.number){let n=U.objectValues(s);return I(a,{expected:U.joinValues(n),received:a.parsedType,code:T.invalid_type}),k}if(this._cache||(this._cache=new Set(U.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){let n=U.objectValues(s);return I(a,{received:a.data,code:T.invalid_enum_value,options:n}),k}return Y(e.data)}get enum(){return this._def.values}};Be.create=(t,e)=>new Be({values:t,typeName:C.ZodNativeEnum,...$(e)});Re=class extends M{static{u(this,"ZodPromise")}unwrap(){return this._def.type}_parse(e){let{ctx:s}=this._processInputParams(e);if(s.parsedType!==R.promise&&s.common.async===!1)return I(s,{code:T.invalid_type,expected:R.promise,received:s.parsedType}),k;let a=s.parsedType===R.promise?s.data:Promise.resolve(s.data);return Y(a.then(n=>this._def.type.parseAsync(n,{path:s.path,errorMap:s.common.contextualErrorMap})))}};Re.create=(t,e)=>new Re({type:t,typeName:C.ZodPromise,...$(e)});se=class extends M{static{u(this,"ZodEffects")}innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===C.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:s,ctx:a}=this._processInputParams(e),n=this._def.effect||null,o={addIssue:u(m=>{I(a,m),m.fatal?s.abort():s.dirty()},"addIssue"),get path(){return a.path}};if(o.addIssue=o.addIssue.bind(o),n.type==="preprocess"){let m=n.transform(a.data,o);if(a.common.async)return Promise.resolve(m).then(async r=>{if(s.value==="aborted")return k;let c=await this._def.schema._parseAsync({data:r,path:a.path,parent:a});return c.status==="aborted"?k:c.status==="dirty"?Ce(c.value):s.value==="dirty"?Ce(c.value):c});{if(s.value==="aborted")return k;let r=this._def.schema._parseSync({data:m,path:a.path,parent:a});return r.status==="aborted"?k:r.status==="dirty"?Ce(r.value):s.value==="dirty"?Ce(r.value):r}}if(n.type==="refinement"){let m=u(r=>{let c=n.refinement(r,o);if(a.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return r},"executeRefinement");if(a.common.async===!1){let r=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});return r.status==="aborted"?k:(r.status==="dirty"&&s.dirty(),m(r.value),{status:s.value,value:r.value})}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(r=>r.status==="aborted"?k:(r.status==="dirty"&&s.dirty(),m(r.value).then(()=>({status:s.value,value:r.value}))))}if(n.type==="transform")if(a.common.async===!1){let m=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});if(!Te(m))return k;let r=n.transform(m.value,o);if(r instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:s.value,value:r}}else return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then(m=>Te(m)?Promise.resolve(n.transform(m.value,o)).then(r=>({status:s.value,value:r})):k);U.assertNever(n)}};se.create=(t,e,s)=>new se({schema:t,typeName:C.ZodEffects,effect:e,...$(s)});se.createWithPreprocess=(t,e,s)=>new se({schema:e,effect:{type:"preprocess",transform:t},typeName:C.ZodEffects,...$(s)});ee=class extends M{static{u(this,"ZodOptional")}_parse(e){return this._getType(e)===R.undefined?Y(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};ee.create=(t,e)=>new ee({innerType:t,typeName:C.ZodOptional,...$(e)});pe=class extends M{static{u(this,"ZodNullable")}_parse(e){return this._getType(e)===R.null?Y(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};pe.create=(t,e)=>new pe({innerType:t,typeName:C.ZodNullable,...$(e)});Je=class extends M{static{u(this,"ZodDefault")}_parse(e){let{ctx:s}=this._processInputParams(e),a=s.data;return s.parsedType===R.undefined&&(a=this._def.defaultValue()),this._def.innerType._parse({data:a,path:s.path,parent:s})}removeDefault(){return this._def.innerType}};Je.create=(t,e)=>new Je({innerType:t,typeName:C.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...$(e)});He=class extends M{static{u(this,"ZodCatch")}_parse(e){let{ctx:s}=this._processInputParams(e),a={...s,common:{...s.common,issues:[]}},n=this._def.innerType._parse({data:a.data,path:a.path,parent:{...a}});return rt(n)?n.then(o=>({status:"valid",value:o.status==="valid"?o.value:this._def.catchValue({get error(){return new Z(a.common.issues)},input:a.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new Z(a.common.issues)},input:a.data})}}removeCatch(){return this._def.innerType}};He.create=(t,e)=>new He({innerType:t,typeName:C.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...$(e)});lt=class extends M{static{u(this,"ZodNaN")}_parse(e){if(this._getType(e)!==R.nan){let a=this._getOrReturnCtx(e);return I(a,{code:T.invalid_type,expected:R.nan,received:a.parsedType}),k}return{status:"valid",value:e.data}}};lt.create=t=>new lt({typeName:C.ZodNaN,...$(t)});cc=Symbol("zod_brand"),kt=class extends M{static{u(this,"ZodBranded")}_parse(e){let{ctx:s}=this._processInputParams(e),a=s.data;return this._def.type._parse({data:a,path:s.path,parent:s})}unwrap(){return this._def.type}},Ct=class t extends M{static{u(this,"ZodPipeline")}_parse(e){let{status:s,ctx:a}=this._processInputParams(e);if(a.common.async)return u(async()=>{let o=await this._def.in._parseAsync({data:a.data,path:a.path,parent:a});return o.status==="aborted"?k:o.status==="dirty"?(s.dirty(),Ce(o.value)):this._def.out._parseAsync({data:o.value,path:a.path,parent:a})},"handleAsync")();{let n=this._def.in._parseSync({data:a.data,path:a.path,parent:a});return n.status==="aborted"?k:n.status==="dirty"?(s.dirty(),{status:"dirty",value:n.value}):this._def.out._parseSync({data:n.value,path:a.path,parent:a})}}static create(e,s){return new t({in:e,out:s,typeName:C.ZodPipeline})}},Ge=class extends M{static{u(this,"ZodReadonly")}_parse(e){let s=this._def.innerType._parse(e),a=u(n=>(Te(n)&&(n.value=Object.freeze(n.value)),n),"freeze");return rt(s)?s.then(n=>a(n)):a(s)}unwrap(){return this._def.innerType}};Ge.create=(t,e)=>new Ge({innerType:t,typeName:C.ZodReadonly,...$(e)});u(Ha,"cleanParams");u(Xa,"custom");uc={object:X.lazycreate};(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(C||(C={}));dc=u((t,e={message:`Input not instance of ${t.name}`})=>Xa(s=>s instanceof t,e),"instanceOfType"),Qa=xe.create,qa=De.create,lc=lt.create,pc=Ne.create,en=$e.create,mc=Me.create,fc=it.create,hc=Le.create,gc=Ue.create,yc=Ie.create,wc=ye.create,_c=ce.create,Ec=ct.create,bc=we.create,Sc=X.create,Tc=X.strictCreate,xc=je.create,Ic=Zt.create,Rc=Ke.create,vc=le.create,Pc=Xt.create,Ac=ut.create,Oc=dt.create,kc=Qt.create,Cc=Ve.create,Dc=Fe.create,Nc=We.create,$c=Be.create,Mc=Re.create,Lc=se.create,Uc=ee.create,jc=pe.create,Kc=se.createWithPreprocess,Vc=Ct.create,Fc=u(()=>Qa().optional(),"ostring"),Wc=u(()=>qa().optional(),"onumber"),Bc=u(()=>en().optional(),"oboolean"),Jc={string:u(t=>xe.create({...t,coerce:!0}),"string"),number:u(t=>De.create({...t,coerce:!0}),"number"),boolean:u(t=>$e.create({...t,coerce:!0}),"boolean"),bigint:u(t=>Ne.create({...t,coerce:!0}),"bigint"),date:u(t=>Me.create({...t,coerce:!0}),"date")},Hc=k});var E={};Oe(E,{BRAND:()=>cc,DIRTY:()=>Ce,EMPTY_PATH:()=>Ki,INVALID:()=>k,NEVER:()=>Hc,OK:()=>Y,ParseStatus:()=>z,Schema:()=>M,ZodAny:()=>Ie,ZodArray:()=>we,ZodBigInt:()=>Ne,ZodBoolean:()=>$e,ZodBranded:()=>kt,ZodCatch:()=>He,ZodDate:()=>Me,ZodDefault:()=>Je,ZodDiscriminatedUnion:()=>Zt,ZodEffects:()=>se,ZodEnum:()=>We,ZodError:()=>Z,ZodFirstPartyTypeKind:()=>C,ZodFunction:()=>Qt,ZodIntersection:()=>Ke,ZodIssueCode:()=>T,ZodLazy:()=>Ve,ZodLiteral:()=>Fe,ZodMap:()=>ut,ZodNaN:()=>lt,ZodNativeEnum:()=>Be,ZodNever:()=>ce,ZodNull:()=>Ue,ZodNullable:()=>pe,ZodNumber:()=>De,ZodObject:()=>X,ZodOptional:()=>ee,ZodParsedType:()=>R,ZodPipeline:()=>Ct,ZodPromise:()=>Re,ZodReadonly:()=>Ge,ZodRecord:()=>Xt,ZodSchema:()=>M,ZodSet:()=>dt,ZodString:()=>xe,ZodSymbol:()=>it,ZodTransformer:()=>se,ZodTuple:()=>le,ZodType:()=>M,ZodUndefined:()=>Le,ZodUnion:()=>je,ZodUnknown:()=>ye,ZodVoid:()=>ct,addIssueToContext:()=>I,any:()=>yc,array:()=>bc,bigint:()=>pc,boolean:()=>en,coerce:()=>Jc,custom:()=>Xa,date:()=>mc,datetimeRegex:()=>Ya,defaultErrorMap:()=>he,discriminatedUnion:()=>Ic,effect:()=>Lc,enum:()=>Nc,function:()=>kc,getErrorMap:()=>nt,getParsedType:()=>de,instanceof:()=>dc,intersection:()=>Rc,isAborted:()=>zt,isAsync:()=>rt,isDirty:()=>Yt,isValid:()=>Te,late:()=>uc,lazy:()=>Cc,literal:()=>Dc,makeIssue:()=>Ot,map:()=>Ac,nan:()=>lc,nativeEnum:()=>$c,never:()=>_c,null:()=>gc,nullable:()=>jc,number:()=>qa,object:()=>Sc,objectUtil:()=>As,oboolean:()=>Bc,onumber:()=>Wc,optional:()=>Uc,ostring:()=>Fc,pipeline:()=>Vc,preprocess:()=>Kc,promise:()=>Mc,quotelessJson:()=>Li,record:()=>Pc,set:()=>Oc,setErrorMap:()=>ji,strictObject:()=>Tc,string:()=>Qa,symbol:()=>fc,transformer:()=>Lc,tuple:()=>vc,undefined:()=>hc,union:()=>xc,unknown:()=>wc,util:()=>U,void:()=>Ec});var Ns=K(()=>{_();w();y();Gt();ks();Wa();At();tn();Ht()});var ve=K(()=>{_();w();y();Ns();Ns()});var Lt={};Oe(Lt,{PromoCodeService:()=>Qs});var Qs,Ut=K(()=>{"use strict";_();w();y();Qs=class{static{u(this,"PromoCodeService")}env;constructor(e){this.env=e}async createPromoCode(e){try{let s=e.code.toUpperCase().replace(/[^A-Z0-9-]/g,"");if(s!==e.code.toUpperCase())return{success:!1,error:"Invalid code format. Use uppercase letters, numbers, and hyphens only."};if(await this.getPromoCode(s))return{success:!1,error:`Promo code '${s}' already exists`};let n={...e,code:s,usedCount:0,createdAt:new Date().toISOString()};return await this.env.KV_IDEMP.put(`promo:${s}`,JSON.stringify(n)),console.log(`[PromoCode] Created: ${s}`,n),{success:!0,code:n}}catch(s){return console.error("[PromoCode] Creation failed:",s),{success:!1,error:s.message||"Failed to create promo code"}}}async getPromoCode(e){try{let s=e.toUpperCase(),a=await this.env.KV_IDEMP.get(`promo:${s}`);return a?JSON.parse(a):null}catch(s){return console.error("[PromoCode] Retrieval failed:",s),null}}async validatePromoCode(e,s){try{let a=await this.getPromoCode(e);return a?a.active?a.expiresAt&&new Date(a.expiresAt)<new Date?{valid:!1,error:"Promo code has expired"}:a.maxUses&&a.usedCount>=a.maxUses?{valid:!1,error:"Promo code has reached maximum uses"}:await this.hasUsedPromoCode(s,e)?{valid:!1,error:"You have already used this promo code"}:a.metadata?.targetTenant&&a.metadata.targetTenant!==s?{valid:!1,error:"This promo code is not valid for your account"}:{valid:!0,promoCode:a}:{valid:!1,error:"Promo code is no longer active"}:{valid:!1,error:"Invalid promo code"}}catch(a){return console.error("[PromoCode] Validation failed:",a),{valid:!1,error:a.message||"Validation failed"}}}async applyPromoCode(e,s){try{let a=await this.validatePromoCode(e,s);if(!a.valid||!a.promoCode)return{success:!1,error:a.error};let n=a.promoCode,o={code:n.code,tenantId:s,redeemedAt:new Date().toISOString(),appliedDiscount:{type:n.type,value:n.value,durationMonths:n.durationMonths}};await this.env.KV_IDEMP.put(`promo-redemption:${s}:${n.code}`,JSON.stringify(o)),n.usedCount++,await this.env.KV_IDEMP.put(`promo:${n.code}`,JSON.stringify(n)),console.log(`[PromoCode] Applied: ${n.code} to ${s}`);let m={type:n.type,value:n.value,durationMonths:n.durationMonths};return n.type==="plan_upgrade"&&(m.plan=n.value),{success:!0,discount:m}}catch(a){return console.error("[PromoCode] Application failed:",a),{success:!1,error:a.message||"Failed to apply promo code"}}}async hasUsedPromoCode(e,s){try{let a=s.toUpperCase();return!!await this.env.KV_IDEMP.get(`promo-redemption:${e}:${a}`)}catch(a){return console.error("[PromoCode] Usage check failed:",a),!1}}async deactivatePromoCode(e){try{let s=await this.getPromoCode(e);return s?(s.active=!1,await this.env.KV_IDEMP.put(`promo:${s.code}`,JSON.stringify(s)),console.log(`[PromoCode] Deactivated: ${s.code}`),{success:!0}):{success:!1,error:"Promo code not found"}}catch(s){return console.error("[PromoCode] Deactivation failed:",s),{success:!1,error:s.message||"Failed to deactivate promo code"}}}async listPromoCodes(){try{let e=await this.env.KV_IDEMP.list({prefix:"promo:"}),s=[];for(let a of e.keys){let n=await this.env.KV_IDEMP.get(a.name);n&&s.push(JSON.parse(n))}return s.sort((a,n)=>new Date(n.createdAt).getTime()-new Date(a.createdAt).getTime())}catch(e){return console.error("[PromoCode] List failed:",e),[]}}async createReferralCode(e,s=3){try{let a=`REFER-${e.toUpperCase().substring(0,8)}-${Date.now().toString(36).toUpperCase()}`,n={code:a,type:"referral_reward",value:s,durationMonths:s,maxUses:null,active:!0,expiresAt:void 0,createdBy:e,metadata:{description:`Referral reward: ${s} months free`,referredBy:e}},o=await this.createPromoCode(n);return o.success?{success:!0,code:a}:{success:!1,error:o.error}}catch(a){return console.error("[PromoCode] Referral code creation failed:",a),{success:!1,error:a.message||"Failed to create referral code"}}}}});async function vu(t,e){let a=qs(JSON.stringify({alg:"RS256",typ:"JWT"})),n=qs(JSON.stringify(t)),o=`${a}.${n}`,m=await Pu(e),c=new TextEncoder().encode(o),h=await crypto.subtle.sign({name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},m,c),x=qs(h);return`${o}.${x}`}async function Pu(t){let e=t.replace(/-----BEGIN PRIVATE KEY-----/,"").replace(/-----END PRIVATE KEY-----/,"").replace(/\s/g,""),s=atob(e),a=new Uint8Array(s.length);for(let n=0;n<s.length;n++)a[n]=s.charCodeAt(n);return await crypto.subtle.importKey("pkcs8",a.buffer,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!1,["sign"])}function qs(t){let e;if(typeof t=="string")e=btoa(t);else{let s=new Uint8Array(t),a=Array.from(s).map(n=>String.fromCharCode(n)).join("");e=btoa(a)}return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}async function Au(t,e){let s=Math.floor(Date.now()/1e3),a={iss:t.client_email,scope:e.join(" "),aud:t.token_uri,exp:s+3600,iat:s},n=await vu(a,t.private_key),o=await fetch(t.token_uri,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:n})});if(!o.ok){let m=await o.text();throw new Error(`Failed to get access token: ${o.status} ${m}`)}return await o.json()}function Ou(t){try{let e=atob(t);return JSON.parse(e)}catch(e){throw new Error(`Failed to parse service account key: ${e}`)}}async function rr(t,e){let s=Ou(t);return{Authorization:`Bearer ${(await Au(s,e)).access_token}`,"Content-Type":"application/json"}}var or=K(()=>{"use strict";_();w();y();u(vu,"signJWT");u(Pu,"importPrivateKey");u(qs,"base64UrlEncode");u(Au,"getAccessToken");u(Ou,"parseServiceAccountKey");u(rr,"getGoogleAPIHeaders")});var ir={};Oe(ir,{AppsScriptDeployer:()=>gs,deployAppsScriptForTenant:()=>ku});async function ku(t,e,s,a){let n=new gs(t),o=t.BACKEND_URL||"https://syston-postbus.team-platform-2025.workers.dev";return await n.deployForTenant(e,s,a,o)}var gs,cr=K(()=>{"use strict";_();w();y();or();gs=class{static{u(this,"AppsScriptDeployer")}env;headers=null;constructor(e){this.env=e}async deployForTenant(e,s,a,n){try{console.log(`[AppsScriptDeployer] Starting deployment for tenant: ${e}`),await this.authenticate();let o=await this.createProjectFromTemplate(e,s);console.log(`[AppsScriptDeployer] Created project: ${o}`),await this.configureScript(o,e,a,n),console.log("[AppsScriptDeployer] Configured script with tenant settings");let m=await this.createVersion(o);console.log(`[AppsScriptDeployer] Created version: ${m}`);let r=await this.deployAsWebApp(o,m);console.log(`[AppsScriptDeployer] Deployed web app: ${r}`);let c=`https://script.google.com/d/${o}/edit`;return{success:!0,scriptId:o,scriptUrl:c,webAppUrl:r}}catch(o){return console.error(`[AppsScriptDeployer] Deployment failed for ${e}:`,o),{success:!1,error:o.message||"Deployment failed"}}}async authenticate(){if(!this.env.GOOGLE_SERVICE_ACCOUNT_KEY)throw new Error("GOOGLE_SERVICE_ACCOUNT_KEY not configured");let e=["https://www.googleapis.com/auth/script.projects","https://www.googleapis.com/auth/script.deployments"];this.headers=await rr(this.env.GOOGLE_SERVICE_ACCOUNT_KEY,e)}async createProjectFromTemplate(e,s){if(!this.env.APPS_SCRIPT_TEMPLATE_ID)throw new Error("APPS_SCRIPT_TEMPLATE_ID not configured");let a=await this.getScriptContent(this.env.APPS_SCRIPT_TEMPLATE_ID),n=await fetch("https://script.googleapis.com/v1/projects",{method:"POST",headers:this.headers,body:JSON.stringify({title:`${s} - Football Automation`})});if(!n.ok){let r=await n.text();throw new Error(`Failed to create project: ${n.status} ${r}`)}let m=(await n.json()).scriptId;return await this.updateScriptContent(m,a),m}async getScriptContent(e){let s=await fetch(`https://script.googleapis.com/v1/projects/${e}/content`,{headers:this.headers});if(!s.ok){let a=await s.text();throw new Error(`Failed to get script content: ${s.status} ${a}`)}return await s.json()}async updateScriptContent(e,s){let a=await fetch(`https://script.googleapis.com/v1/projects/${e}/content`,{method:"PUT",headers:this.headers,body:JSON.stringify({files:s.files})});if(!a.ok){let n=await a.text();throw new Error(`Failed to update script content: ${a.status} ${n}`)}}async configureScript(e,s,a,n){let o=await this.getScriptContent(e),m=o.files.find(c=>c.name==="config");m&&(m.source=this.injectTenantConfig(m.source,s,a,n));let r={name:"auto_init",type:"SERVER_JS",source:this.generateAutoInitCode(s,a,n)};o.files.push(r),await this.updateScriptContent(e,o),await this.executeFunction(e,"_autoInitTenant")}injectTenantConfig(e,s,a,n){return e=e.replace(/TENANT_ID:\s*['"][^'"]*['"]/,`TENANT_ID: '${s}'`),e=e.replace(/API_URL:\s*['"][^'"]*['"]/,`API_URL: '${n}'`),e}generateAutoInitCode(e,s,a){return`
/**
 * Auto-initialization function
 * Sets Script Properties for tenant configuration
 * This runs once on first deployment
 */
function _autoInitTenant() {
  const props = PropertiesService.getScriptProperties();

  // Set tenant configuration
  props.setProperties({
    'TENANT_ID': '${e}',
    'BACKEND_JWT': '${s}',
    'BACKEND_API_URL': '${a}',
    'INITIALIZED': 'true',
    'INITIALIZED_AT': new Date().toISOString()
  });

  Logger.log('Tenant configuration initialized for: ${e}');

  return {
    success: true,
    tenantId: '${e}',
    timestamp: new Date().toISOString()
  };
}
`.trim()}async createVersion(e){let s=await fetch(`https://script.googleapis.com/v1/projects/${e}/versions`,{method:"POST",headers:this.headers,body:JSON.stringify({description:"Automated deployment"})});if(!s.ok){let n=await s.text();throw new Error(`Failed to create version: ${s.status} ${n}`)}return(await s.json()).versionNumber}async deployAsWebApp(e,s){let a=await fetch(`https://script.googleapis.com/v1/projects/${e}/deployments`,{method:"POST",headers:this.headers,body:JSON.stringify({versionNumber:s,description:"Production deployment",manifestFileName:"appsscript"})});if(!a.ok){let r=await a.text();throw new Error(`Failed to deploy: ${a.status} ${r}`)}return`https://script.google.com/macros/s/${(await a.json()).deploymentId}/exec`}async executeFunction(e,s){try{let a=await fetch(`https://script.googleapis.com/v1/scripts/${e}:run`,{method:"POST",headers:this.headers,body:JSON.stringify({function:s,devMode:!1})});return a.ok||console.warn(`Function execution warning (non-critical): ${a.status}`),await a.json()}catch(a){console.warn("Function execution failed (non-critical):",a)}}};u(ku,"deployAppsScriptForTenant")});var _t={};Oe(_t,{createPlayerImage:()=>Wu,deletePlayerImage:()=>Hu,getPlayerImage:()=>oa,getPlayerImageUploadUrl:()=>Gu,listPlayerImages:()=>Bu,updatePlayerImage:()=>Ju});async function Wu(t,e,s){let a=`img_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,n={id:a,...s,uploadedAt:new Date().toISOString()},o=`tenants:${e}:player-images:${a}`;await t.KV_IDEMP.put(o,JSON.stringify(n));let m=`tenants:${e}:player-images:index`,r=await t.KV_IDEMP.get(m,"json")||[],c=[n,...r.filter(h=>h.id!==a)];return await t.KV_IDEMP.put(m,JSON.stringify(c.slice(0,1e3))),n}async function oa(t,e,s){let a=`tenants:${e}:player-images:${s}`;return await t.KV_IDEMP.get(a,"json")}async function Bu(t,e,s){let a=`tenants:${e}:player-images:index`,n=await t.KV_IDEMP.get(a,"json")||[];return s?.playerId&&(n=n.filter(o=>o.playerId===s.playerId)),s?.type&&(n=n.filter(o=>o.type===s.type)),n}async function Ju(t,e,s,a){let n=await oa(t,e,s);if(!n)return null;let o={...n,...a},m=`tenants:${e}:player-images:${s}`;await t.KV_IDEMP.put(m,JSON.stringify(o));let r=`tenants:${e}:player-images:index`,h=(await t.KV_IDEMP.get(r,"json")||[]).map(x=>x.id===s?o:x);return await t.KV_IDEMP.put(r,JSON.stringify(h.slice(0,1e3))),o}async function Hu(t,e,s){let a=await oa(t,e,s);if(!a)return!1;if(a.r2Key)try{await t.R2_MEDIA.delete(a.r2Key)}catch(c){console.error("Failed to delete R2 object",a.r2Key,c)}let n=`tenants:${e}:player-images:${s}`;await t.KV_IDEMP.delete(n);let o=`tenants:${e}:player-images:index`,r=(await t.KV_IDEMP.get(o,"json")||[]).filter(c=>c.id!==s);return await t.KV_IDEMP.put(o,JSON.stringify(r)),!0}async function Gu(t,e,s,a,n="image/jpeg"){let o=`img_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,m=`tenants/${e}/player-images/${s}/${a}/${o}.jpg`;return{uploadUrl:`/api/v1/admin/player-images/upload/${o}`,r2Key:m,imageId:o}}var Ib,Et=K(()=>{"use strict";_();w();y();ve();Ib=E.object({playerId:E.string().min(1),playerName:E.string().min(1),type:E.enum(["headshot","action"]),imageUrl:E.string().url().optional(),r2Key:E.string().min(1),uploadedBy:E.string().min(1),metadata:E.object({aspectRatio:E.string().optional(),width:E.number().optional(),height:E.number().optional()}).optional()});u(Wu,"createPlayerImage");u(oa,"getPlayerImage");u(Bu,"listPlayerImages");u(Ju,"updatePlayerImage");u(Hu,"deletePlayerImage");u(Gu,"getPlayerImageUploadUrl")});var Es={};Oe(Es,{getAutoPostsMatrix:()=>ws,getDefaultAutoPostsMatrix:()=>ia,resetAutoPostsMatrix:()=>Qu,shouldPostToChannel:()=>qu,togglePostTypeChannel:()=>Xu,updateAutoPostsMatrix:()=>_s,updatePostTypeConfig:()=>Zu});function ia(){let t={app:!0,x:!1,instagram:!1,facebook:!1,tiktok:!1},e=["COUNTDOWN_T3","COUNTDOWN_T2","COUNTDOWN_T1","MATCHDAY","LIVE_UPDATE","HALFTIME","FULLTIME","LEAGUE_FIXTURES","RESULTS_SUMMARY","TABLE_UPDATE","POSTPONEMENT","BIRTHDAY","QUOTE","MOTM_RESULT","HIGHLIGHTS"],s={};return e.forEach(a=>{s[a]={channels:{...t},sponsorOverlay:!1}}),s}async function ws(t,e){let s=`tenants:${e}:auto-posts-matrix`,a=await t.KV_IDEMP.get(s,"json");return a||ia()}async function _s(t,e,s){let a=`tenants:${e}:auto-posts-matrix`;return await t.KV_IDEMP.put(a,JSON.stringify(s)),s}async function Zu(t,e,s,a){let n=await ws(t,e);return n[s]=a,await _s(t,e,n)}async function Xu(t,e,s,a){let n=await ws(t,e);return n[s]||(n[s]={channels:{app:!1,x:!1,instagram:!1,facebook:!1,tiktok:!1},sponsorOverlay:!1}),n[s].channels[a]=!n[s].channels[a],await _s(t,e,n)}async function Qu(t,e){let s=ia();return await _s(t,e,s)}async function qu(t,e,s,a){return(await ws(t,e))[s]?.channels[a]||!1}var zu,Yu,kb,bs=K(()=>{"use strict";_();w();y();ve();zu=E.object({app:E.boolean(),x:E.boolean(),instagram:E.boolean(),facebook:E.boolean(),tiktok:E.boolean()}),Yu=E.object({channels:zu,scheduleTime:E.string().optional(),sponsorOverlay:E.boolean()}),kb=E.record(Yu);u(ia,"getDefaultAutoPostsMatrix");u(ws,"getAutoPostsMatrix");u(_s,"updateAutoPostsMatrix");u(Zu,"updatePostTypeConfig");u(Xu,"togglePostTypeChannel");u(Qu,"resetAutoPostsMatrix");u(qu,"shouldPostToChannel")});var St={};Oe(St,{getClubConfig:()=>bt,getDefaultClubConfig:()=>Or,updateClubConfig:()=>ca,updateClubConfigSection:()=>Ss,updateFeatureFlags:()=>ed,uploadClubBadge:()=>td,uploadSponsorLogo:()=>sd});function Or(t,e){return{clubDetails:{name:t,shortName:e,founded:"",venue:"",email:"",phone:""},branding:{primaryColor:"#6CC5FF",secondaryColor:"#9AA1AC",clubBadge:void 0,sponsorLogos:[]},externalIds:{faFullTime:void 0,youtubeChannelId:void 0,printifyStoreId:void 0,paymentPlatformId:void 0},featureFlags:{enableGallery:!0,enableShop:!1,enablePayments:!1,enableHighlights:!0,enableMOTMVoting:!0,enableTrainingPlans:!1,enableAwards:!1},policies:{quietHoursStart:"22:00",quietHoursEnd:"08:00",allowUrgentBypass:!0,maxUploadSizeMB:10,photoConsentRequired:!0},navLinks:{websiteUrl:void 0,facebookUrl:void 0,instagramUrl:void 0,twitterUrl:void 0,tiktokUrl:void 0}}}async function bt(t,e){let s=`tenants:${e}:club-config`,a=await t.KV_IDEMP.get(s,"json");if(a)return a;let n=`tenants:${e}:config`,o=await t.KV_IDEMP.get(n,"json"),m=o?.name||"My Club",r=o?.id||e;return Or(m,r)}async function ca(t,e,s){let a=`tenants:${e}:club-config`;return await t.KV_IDEMP.put(a,JSON.stringify(s)),s}async function Ss(t,e,s,a){let n=await bt(t,e);return n[s]={...n[s],...a},await ca(t,e,n)}async function ed(t,e,s){let a=await bt(t,e);return a.featureFlags={...a.featureFlags,...s},await ca(t,e,a)}async function td(t,e,s,a){let n=`tenants/${e}/branding/badge_${Date.now()}.jpg`;await t.R2_MEDIA.put(n,s,{httpMetadata:{contentType:a||"image/jpeg"}});let o=`/api/v1/media/photo/${encodeURIComponent(n)}`;return{r2Key:n,url:o}}async function sd(t,e,s,a){let n=`tenants/${e}/branding/sponsor_${Date.now()}.jpg`;await t.R2_MEDIA.put(n,s,{httpMetadata:{contentType:a||"image/jpeg"}});let o=`/api/v1/media/photo/${encodeURIComponent(n)}`;return{r2Key:n,url:o}}var Lb,st=K(()=>{"use strict";_();w();y();ve();Lb=E.object({clubDetails:E.object({name:E.string().min(1),shortName:E.string().min(1),founded:E.string().optional(),venue:E.string().optional(),email:E.string().email().optional(),phone:E.string().optional()}),branding:E.object({primaryColor:E.string(),secondaryColor:E.string(),clubBadge:E.string().optional(),sponsorLogos:E.array(E.string())}),externalIds:E.object({faFullTime:E.string().optional(),youtubeChannelId:E.string().optional(),printifyStoreId:E.string().optional(),paymentPlatformId:E.string().optional()}),featureFlags:E.object({enableGallery:E.boolean(),enableShop:E.boolean(),enablePayments:E.boolean(),enableHighlights:E.boolean(),enableMOTMVoting:E.boolean(),enableTrainingPlans:E.boolean(),enableAwards:E.boolean()}),policies:E.object({quietHoursStart:E.string(),quietHoursEnd:E.string(),allowUrgentBypass:E.boolean(),maxUploadSizeMB:E.number().min(1).max(100),photoConsentRequired:E.boolean()}),navLinks:E.object({websiteUrl:E.string().url().optional(),facebookUrl:E.string().url().optional(),instagramUrl:E.string().url().optional(),twitterUrl:E.string().url().optional(),tiktokUrl:E.string().url().optional()})});u(Or,"getDefaultClubConfig");u(bt,"getClubConfig");u(ca,"updateClubConfig");u(Ss,"updateClubConfigSection");u(ed,"updateFeatureFlags");u(td,"uploadClubBadge");u(sd,"uploadSponsorLogo")});var ua={};Oe(ua,{BrandKitSchema:()=>Cr,getBrand:()=>Dr,setBrand:()=>ad});function kr(t){let e=t.replace("#",""),s=parseInt(e.substring(0,2),16),a=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);return(.299*s+.587*a+.114*n)/255>.5?"#000000":"#FFFFFF"}async function Dr(t,e){let s=await bt(t,e);return{primaryColor:s.branding.primaryColor,secondaryColor:s.branding.secondaryColor,onPrimary:kr(s.branding.primaryColor),onSecondary:kr(s.branding.secondaryColor),clubBadge:s.branding.clubBadge,sponsorLogos:s.branding.sponsorLogos,clubName:s.clubDetails.name,clubShortName:s.clubDetails.shortName}}async function ad(t,e,s){let a=Cr.partial().parse(s),n=await bt(t,e);return a.primaryColor!==void 0&&(n.branding.primaryColor=a.primaryColor),a.secondaryColor!==void 0&&(n.branding.secondaryColor=a.secondaryColor),a.clubBadge!==void 0&&(n.branding.clubBadge=a.clubBadge),a.sponsorLogos!==void 0&&(n.branding.sponsorLogos=a.sponsorLogos),a.clubName!==void 0&&(n.clubDetails.name=a.clubName),a.clubShortName!==void 0&&(n.clubDetails.shortName=a.clubShortName),await Ss(t,e,"branding",n.branding),(a.clubName||a.clubShortName)&&await Ss(t,e,"clubDetails",n.clubDetails),Dr(t,e)}var Cr,da=K(()=>{"use strict";_();w();y();ve();st();Cr=E.object({primaryColor:E.string().regex(/^#[0-9A-Fa-f]{6}$/),secondaryColor:E.string().regex(/^#[0-9A-Fa-f]{6}$/),onPrimary:E.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),onSecondary:E.string().regex(/^#[0-9A-Fa-f]{6}$/).optional(),clubBadge:E.string().url().optional(),sponsorLogos:E.array(E.string().url()).optional(),clubName:E.string().optional(),clubShortName:E.string().optional()});u(kr,"getContrastTextColor");u(Dr,"getBrand");u(ad,"setBrand")});_();w();y();ve();_();w();y();_();w();y();_();w();y();var Q=new TextEncoder,ae=new TextDecoder,$m=2**32;function qt(...t){let e=t.reduce((n,{length:o})=>n+o,0),s=new Uint8Array(e),a=0;for(let n of t)s.set(n,a),a+=n.length;return s}u(qt,"concat");_();w();y();function sn(t){if(Uint8Array.prototype.toBase64)return t.toBase64();let e=32768,s=[];for(let a=0;a<t.length;a+=e)s.push(String.fromCharCode.apply(null,t.subarray(a,a+e)));return btoa(s.join(""))}u(sn,"encodeBase64");function an(t){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(t);let e=atob(t),s=new Uint8Array(e.length);for(let a=0;a<e.length;a++)s[a]=e.charCodeAt(a);return s}u(an,"decodeBase64");function pt(t){if(Uint8Array.fromBase64)return Uint8Array.fromBase64(typeof t=="string"?t:ae.decode(t),{alphabet:"base64url"});let e=t;e instanceof Uint8Array&&(e=ae.decode(e)),e=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return an(e)}catch{throw new TypeError("The input to be decoded is not correctly encoded.")}}u(pt,"decode");function es(t){let e=t;return typeof e=="string"&&(e=Q.encode(e)),Uint8Array.prototype.toBase64?e.toBase64({alphabet:"base64url",omitPadding:!0}):sn(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}u(es,"encode");_();w();y();var _e=class extends Error{static{u(this,"JOSEError")}static code="ERR_JOSE_GENERIC";code="ERR_JOSE_GENERIC";constructor(e,s){super(e,s),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}},q=class extends _e{static{u(this,"JWTClaimValidationFailed")}static code="ERR_JWT_CLAIM_VALIDATION_FAILED";code="ERR_JWT_CLAIM_VALIDATION_FAILED";claim;reason;payload;constructor(e,s,a="unspecified",n="unspecified"){super(e,{cause:{claim:a,reason:n,payload:s}}),this.claim=a,this.reason=n,this.payload=s}},Dt=class extends _e{static{u(this,"JWTExpired")}static code="ERR_JWT_EXPIRED";code="ERR_JWT_EXPIRED";claim;reason;payload;constructor(e,s,a="unspecified",n="unspecified"){super(e,{cause:{claim:a,reason:n,payload:s}}),this.claim=a,this.reason=n,this.payload=s}},ts=class extends _e{static{u(this,"JOSEAlgNotAllowed")}static code="ERR_JOSE_ALG_NOT_ALLOWED";code="ERR_JOSE_ALG_NOT_ALLOWED"},ne=class extends _e{static{u(this,"JOSENotSupported")}static code="ERR_JOSE_NOT_SUPPORTED";code="ERR_JOSE_NOT_SUPPORTED"};var V=class extends _e{static{u(this,"JWSInvalid")}static code="ERR_JWS_INVALID";code="ERR_JWS_INVALID"},Pe=class extends _e{static{u(this,"JWTInvalid")}static code="ERR_JWT_INVALID";code="ERR_JWT_INVALID"};var ss=class extends _e{static{u(this,"JWSSignatureVerificationFailed")}static code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED";constructor(e="signature verification failed",s){super(e,s)}};_();w();y();function me(t,e="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${e} must be ${t}`)}u(me,"unusable");function mt(t,e){return t.name===e}u(mt,"isAlgorithm");function $s(t){return parseInt(t.name.slice(4),10)}u($s,"getHashLength");function Yc(t){switch(t){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}u(Yc,"getNamedCurve");function Zc(t,e){if(e&&!t.usages.includes(e))throw new TypeError(`CryptoKey does not support this operation, its usages must include ${e}.`)}u(Zc,"checkUsage");function nn(t,e,s){switch(e){case"HS256":case"HS384":case"HS512":{if(!mt(t.algorithm,"HMAC"))throw me("HMAC");let a=parseInt(e.slice(2),10);if($s(t.algorithm.hash)!==a)throw me(`SHA-${a}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!mt(t.algorithm,"RSASSA-PKCS1-v1_5"))throw me("RSASSA-PKCS1-v1_5");let a=parseInt(e.slice(2),10);if($s(t.algorithm.hash)!==a)throw me(`SHA-${a}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!mt(t.algorithm,"RSA-PSS"))throw me("RSA-PSS");let a=parseInt(e.slice(2),10);if($s(t.algorithm.hash)!==a)throw me(`SHA-${a}`,"algorithm.hash");break}case"Ed25519":case"EdDSA":{if(!mt(t.algorithm,"Ed25519"))throw me("Ed25519");break}case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":{if(!mt(t.algorithm,e))throw me(e);break}case"ES256":case"ES384":case"ES512":{if(!mt(t.algorithm,"ECDSA"))throw me("ECDSA");let a=Yc(e);if(t.algorithm.namedCurve!==a)throw me(a,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}Zc(t,s)}u(nn,"checkSigCryptoKey");_();w();y();function rn(t,e,...s){if(s=s.filter(Boolean),s.length>2){let a=s.pop();t+=`one of type ${s.join(", ")}, or ${a}.`}else s.length===2?t+=`one of type ${s[0]} or ${s[1]}.`:t+=`of type ${s[0]}.`;return e==null?t+=` Received ${e}`:typeof e=="function"&&e.name?t+=` Received function ${e.name}`:typeof e=="object"&&e!=null&&e.constructor?.name&&(t+=` Received an instance of ${e.constructor.name}`),t}u(rn,"message");var on=u((t,...e)=>rn("Key must be ",t,...e),"default");function Ms(t,e,...s){return rn(`Key for the ${t} algorithm must be `,e,...s)}u(Ms,"withAlg");_();w();y();function Ls(t){return t?.[Symbol.toStringTag]==="CryptoKey"}u(Ls,"isCryptoKey");function Us(t){return t?.[Symbol.toStringTag]==="KeyObject"}u(Us,"isKeyObject");var js=u(t=>Ls(t)||Us(t),"default");_();w();y();var as=u((...t)=>{let e=t.filter(Boolean);if(e.length===0||e.length===1)return!0;let s;for(let a of e){let n=Object.keys(a);if(!s||s.size===0){s=new Set(n);continue}for(let o of n){if(s.has(o))return!1;s.add(o)}}return!0},"default");_();w();y();function Xc(t){return typeof t=="object"&&t!==null}u(Xc,"isObjectLike");var Ae=u(t=>{if(!Xc(t)||Object.prototype.toString.call(t)!=="[object Object]")return!1;if(Object.getPrototypeOf(t)===null)return!0;let e=t;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e},"default");_();w();y();var ns=u((t,e)=>{if(t.startsWith("RS")||t.startsWith("PS")){let{modulusLength:s}=e.algorithm;if(typeof s!="number"||s<2048)throw new TypeError(`${t} requires key modulusLength to be 2048 bits or larger`)}},"default");_();w();y();function Qc(t){let e,s;switch(t.kty){case"AKP":{switch(t.alg){case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":e={name:t.alg},s=t.priv?["sign"]:["verify"];break;default:throw new ne('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"RSA":{switch(t.alg){case"PS256":case"PS384":case"PS512":e={name:"RSA-PSS",hash:`SHA-${t.alg.slice(-3)}`},s=t.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":e={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${t.alg.slice(-3)}`},s=t.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":e={name:"RSA-OAEP",hash:`SHA-${parseInt(t.alg.slice(-3),10)||1}`},s=t.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new ne('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"EC":{switch(t.alg){case"ES256":e={name:"ECDSA",namedCurve:"P-256"},s=t.d?["sign"]:["verify"];break;case"ES384":e={name:"ECDSA",namedCurve:"P-384"},s=t.d?["sign"]:["verify"];break;case"ES512":e={name:"ECDSA",namedCurve:"P-521"},s=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:"ECDH",namedCurve:t.crv},s=t.d?["deriveBits"]:[];break;default:throw new ne('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}case"OKP":{switch(t.alg){case"Ed25519":case"EdDSA":e={name:"Ed25519"},s=t.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":e={name:t.crv},s=t.d?["deriveBits"]:[];break;default:throw new ne('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break}default:throw new ne('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:e,keyUsages:s}}u(Qc,"subtleMapping");var cn=u(async t=>{if(!t.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');let{algorithm:e,keyUsages:s}=Qc(t),a={...t};return a.kty!=="AKP"&&delete a.alg,delete a.use,crypto.subtle.importKey("jwk",a,e,t.ext??!(t.d||t.priv),t.key_ops??s)},"default");_();w();y();var rs=u((t,e,s,a,n)=>{if(n.crit!==void 0&&a?.crit===void 0)throw new t('"crit" (Critical) Header Parameter MUST be integrity protected');if(!a||a.crit===void 0)return new Set;if(!Array.isArray(a.crit)||a.crit.length===0||a.crit.some(m=>typeof m!="string"||m.length===0))throw new t('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let o;s!==void 0?o=new Map([...Object.entries(s),...e.entries()]):o=e;for(let m of a.crit){if(!o.has(m))throw new ne(`Extension Header Parameter "${m}" is not recognized`);if(n[m]===void 0)throw new t(`Extension Header Parameter "${m}" is missing`);if(o.get(m)&&a[m]===void 0)throw new t(`Extension Header Parameter "${m}" MUST be integrity protected`)}return new Set(a.crit)},"default");_();w();y();var un=u((t,e)=>{if(e!==void 0&&(!Array.isArray(e)||e.some(s=>typeof s!="string")))throw new TypeError(`"${t}" option must be an array of strings`);if(e)return new Set(e)},"default");_();w();y();_();w();y();function Nt(t){return Ae(t)&&typeof t.kty=="string"}u(Nt,"isJWK");function dn(t){return t.kty!=="oct"&&(t.kty==="AKP"&&typeof t.priv=="string"||typeof t.d=="string")}u(dn,"isPrivateJWK");function ln(t){return t.kty!=="oct"&&typeof t.d>"u"&&typeof t.priv>"u"}u(ln,"isPublicJWK");function pn(t){return t.kty==="oct"&&typeof t.k=="string"}u(pn,"isSecretJWK");var ft,mn=u(async(t,e,s,a=!1)=>{ft||=new WeakMap;let n=ft.get(t);if(n?.[s])return n[s];let o=await cn({...e,alg:s});return a&&Object.freeze(t),n?n[s]=o:ft.set(t,{[s]:o}),o},"handleJWK"),eu=u((t,e)=>{ft||=new WeakMap;let s=ft.get(t);if(s?.[e])return s[e];let a=t.type==="public",n=!!a,o;if(t.asymmetricKeyType==="x25519"){switch(e){case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}o=t.toCryptoKey(t.asymmetricKeyType,n,a?[]:["deriveBits"])}if(t.asymmetricKeyType==="ed25519"){if(e!=="EdDSA"&&e!=="Ed25519")throw new TypeError("given KeyObject instance cannot be used for this algorithm");o=t.toCryptoKey(t.asymmetricKeyType,n,[a?"verify":"sign"])}switch(t.asymmetricKeyType){case"ml-dsa-44":case"ml-dsa-65":case"ml-dsa-87":{if(e!==t.asymmetricKeyType.toUpperCase())throw new TypeError("given KeyObject instance cannot be used for this algorithm");o=t.toCryptoKey(t.asymmetricKeyType,n,[a?"verify":"sign"])}}if(t.asymmetricKeyType==="rsa"){let m;switch(e){case"RSA-OAEP":m="SHA-1";break;case"RS256":case"PS256":case"RSA-OAEP-256":m="SHA-256";break;case"RS384":case"PS384":case"RSA-OAEP-384":m="SHA-384";break;case"RS512":case"PS512":case"RSA-OAEP-512":m="SHA-512";break;default:throw new TypeError("given KeyObject instance cannot be used for this algorithm")}if(e.startsWith("RSA-OAEP"))return t.toCryptoKey({name:"RSA-OAEP",hash:m},n,a?["encrypt"]:["decrypt"]);o=t.toCryptoKey({name:e.startsWith("PS")?"RSA-PSS":"RSASSA-PKCS1-v1_5",hash:m},n,[a?"verify":"sign"])}if(t.asymmetricKeyType==="ec"){let r=new Map([["prime256v1","P-256"],["secp384r1","P-384"],["secp521r1","P-521"]]).get(t.asymmetricKeyDetails?.namedCurve);if(!r)throw new TypeError("given KeyObject instance cannot be used for this algorithm");e==="ES256"&&r==="P-256"&&(o=t.toCryptoKey({name:"ECDSA",namedCurve:r},n,[a?"verify":"sign"])),e==="ES384"&&r==="P-384"&&(o=t.toCryptoKey({name:"ECDSA",namedCurve:r},n,[a?"verify":"sign"])),e==="ES512"&&r==="P-521"&&(o=t.toCryptoKey({name:"ECDSA",namedCurve:r},n,[a?"verify":"sign"])),e.startsWith("ECDH-ES")&&(o=t.toCryptoKey({name:"ECDH",namedCurve:r},n,a?[]:["deriveBits"]))}if(!o)throw new TypeError("given KeyObject instance cannot be used for this algorithm");return s?s[e]=o:ft.set(t,{[e]:o}),o},"handleKeyObject"),os=u(async(t,e)=>{if(t instanceof Uint8Array||Ls(t))return t;if(Us(t)){if(t.type==="secret")return t.export();if("toCryptoKey"in t&&typeof t.toCryptoKey=="function")try{return eu(t,e)}catch(a){if(a instanceof TypeError)throw a}let s=t.export({format:"jwk"});return mn(t,s,e)}if(Nt(t))return t.k?pt(t.k):mn(t,t,e,!0);throw new Error("unreachable")},"default");_();w();y();var ht=u(t=>t?.[Symbol.toStringTag],"tag"),Ks=u((t,e,s)=>{if(e.use!==void 0){let a;switch(s){case"sign":case"verify":a="sig";break;case"encrypt":case"decrypt":a="enc";break}if(e.use!==a)throw new TypeError(`Invalid key for this operation, its "use" must be "${a}" when present`)}if(e.alg!==void 0&&e.alg!==t)throw new TypeError(`Invalid key for this operation, its "alg" must be "${t}" when present`);if(Array.isArray(e.key_ops)){let a;switch(!0){case(s==="sign"||s==="verify"):case t==="dir":case t.includes("CBC-HS"):a=s;break;case t.startsWith("PBES2"):a="deriveBits";break;case/^A\d{3}(?:GCM)?(?:KW)?$/.test(t):!t.includes("GCM")&&t.endsWith("KW")?a=s==="encrypt"?"wrapKey":"unwrapKey":a=s;break;case(s==="encrypt"&&t.startsWith("RSA")):a="wrapKey";break;case s==="decrypt":a=t.startsWith("RSA")?"unwrapKey":"deriveBits";break}if(a&&e.key_ops?.includes?.(a)===!1)throw new TypeError(`Invalid key for this operation, its "key_ops" must include "${a}" when present`)}return!0},"jwkMatchesOp"),tu=u((t,e,s)=>{if(!(e instanceof Uint8Array)){if(Nt(e)){if(pn(e)&&Ks(t,e,s))return;throw new TypeError('JSON Web Key for symmetric algorithms must have JWK "kty" (Key Type) equal to "oct" and the JWK "k" (Key Value) present')}if(!js(e))throw new TypeError(Ms(t,e,"CryptoKey","KeyObject","JSON Web Key","Uint8Array"));if(e.type!=="secret")throw new TypeError(`${ht(e)} instances for symmetric algorithms must be of type "secret"`)}},"symmetricTypeCheck"),su=u((t,e,s)=>{if(Nt(e))switch(s){case"decrypt":case"sign":if(dn(e)&&Ks(t,e,s))return;throw new TypeError("JSON Web Key for this operation be a private JWK");case"encrypt":case"verify":if(ln(e)&&Ks(t,e,s))return;throw new TypeError("JSON Web Key for this operation be a public JWK")}if(!js(e))throw new TypeError(Ms(t,e,"CryptoKey","KeyObject","JSON Web Key"));if(e.type==="secret")throw new TypeError(`${ht(e)} instances for asymmetric algorithms must not be of type "secret"`);if(e.type==="public")switch(s){case"sign":throw new TypeError(`${ht(e)} instances for asymmetric algorithm signing must be of type "private"`);case"decrypt":throw new TypeError(`${ht(e)} instances for asymmetric algorithm decryption must be of type "private"`);default:break}if(e.type==="private")switch(s){case"verify":throw new TypeError(`${ht(e)} instances for asymmetric algorithm verifying must be of type "public"`);case"encrypt":throw new TypeError(`${ht(e)} instances for asymmetric algorithm encryption must be of type "public"`);default:break}},"asymmetricTypeCheck"),is=u((t,e,s)=>{t.startsWith("HS")||t==="dir"||t.startsWith("PBES2")||/^A(?:128|192|256)(?:GCM)?(?:KW)?$/.test(t)||/^A(?:128|192|256)CBC-HS(?:256|384|512)$/.test(t)?tu(t,e,s):su(t,e,s)},"default");_();w();y();_();w();y();_();w();y();_();w();y();var cs=u((t,e)=>{let s=`SHA-${t.slice(-3)}`;switch(t){case"HS256":case"HS384":case"HS512":return{hash:s,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:s,name:"RSA-PSS",saltLength:parseInt(t.slice(-3),10)>>3};case"RS256":case"RS384":case"RS512":return{hash:s,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:s,name:"ECDSA",namedCurve:e.namedCurve};case"Ed25519":case"EdDSA":return{name:"Ed25519"};case"ML-DSA-44":case"ML-DSA-65":case"ML-DSA-87":return{name:t};default:throw new ne(`alg ${t} is not supported either by JOSE or your javascript runtime`)}},"default");_();w();y();var us=u(async(t,e,s)=>{if(e instanceof Uint8Array){if(!t.startsWith("HS"))throw new TypeError(on(e,"CryptoKey","KeyObject","JSON Web Key"));return crypto.subtle.importKey("raw",e,{hash:`SHA-${t.slice(-3)}`,name:"HMAC"},!1,[s])}return nn(e,t,s),e},"default");var fn=u(async(t,e,s,a)=>{let n=await us(t,e,"verify");ns(t,n);let o=cs(t,n.algorithm);try{return await crypto.subtle.verify(o,n,s,a)}catch{return!1}},"default");async function hn(t,e,s){if(!Ae(t))throw new V("Flattened JWS must be an object");if(t.protected===void 0&&t.header===void 0)throw new V('Flattened JWS must have either of the "protected" or "header" members');if(t.protected!==void 0&&typeof t.protected!="string")throw new V("JWS Protected Header incorrect type");if(t.payload===void 0)throw new V("JWS Payload missing");if(typeof t.signature!="string")throw new V("JWS Signature missing or incorrect type");if(t.header!==void 0&&!Ae(t.header))throw new V("JWS Unprotected Header incorrect type");let a={};if(t.protected)try{let f=pt(t.protected);a=JSON.parse(ae.decode(f))}catch{throw new V("JWS Protected Header is invalid")}if(!as(a,t.header))throw new V("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let n={...a,...t.header},o=rs(V,new Map([["b64",!0]]),s?.crit,a,n),m=!0;if(o.has("b64")&&(m=a.b64,typeof m!="boolean"))throw new V('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:r}=n;if(typeof r!="string"||!r)throw new V('JWS "alg" (Algorithm) Header Parameter missing or invalid');let c=s&&un("algorithms",s.algorithms);if(c&&!c.has(r))throw new ts('"alg" (Algorithm) Header Parameter value not allowed');if(m){if(typeof t.payload!="string")throw new V("JWS Payload must be a string")}else if(typeof t.payload!="string"&&!(t.payload instanceof Uint8Array))throw new V("JWS Payload must be a string or an Uint8Array instance");let h=!1;typeof e=="function"&&(e=await e(a,t),h=!0),is(r,e,"verify");let x=qt(Q.encode(t.protected??""),Q.encode("."),typeof t.payload=="string"?Q.encode(t.payload):t.payload),P;try{P=pt(t.signature)}catch{throw new V("Failed to base64url decode the signature")}let N=await os(e,r);if(!await fn(r,N,P,x))throw new ss;let d;if(m)try{d=pt(t.payload)}catch{throw new V("Failed to base64url decode the payload")}else typeof t.payload=="string"?d=Q.encode(t.payload):d=t.payload;let p={payload:d};return t.protected!==void 0&&(p.protectedHeader=a),t.header!==void 0&&(p.unprotectedHeader=t.header),h?{...p,key:N}:p}u(hn,"flattenedVerify");async function gn(t,e,s){if(t instanceof Uint8Array&&(t=ae.decode(t)),typeof t!="string")throw new V("Compact JWS must be a string or Uint8Array");let{0:a,1:n,2:o,length:m}=t.split(".");if(m!==3)throw new V("Invalid Compact JWS");let r=await hn({payload:n,protected:a,signature:o},e,s),c={payload:r.payload,protectedHeader:r.protectedHeader};return typeof e=="function"?{...c,key:r.key}:c}u(gn,"compactVerify");_();w();y();_();w();y();_();w();y();var Ee=u(t=>Math.floor(t.getTime()/1e3),"default");_();w();y();var au=/^(\+|\-)? ?(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)(?: (ago|from now))?$/i,gt=u(t=>{let e=au.exec(t);if(!e||e[4]&&e[1])throw new TypeError("Invalid time period format");let s=parseFloat(e[2]),a=e[3].toLowerCase(),n;switch(a){case"sec":case"secs":case"second":case"seconds":case"s":n=Math.round(s);break;case"minute":case"minutes":case"min":case"mins":case"m":n=Math.round(s*60);break;case"hour":case"hours":case"hr":case"hrs":case"h":n=Math.round(s*3600);break;case"day":case"days":case"d":n=Math.round(s*86400);break;case"week":case"weeks":case"w":n=Math.round(s*604800);break;default:n=Math.round(s*31557600);break}return e[1]==="-"||e[4]==="ago"?-n:n},"default");function ze(t,e){if(!Number.isFinite(e))throw new TypeError(`Invalid ${t} input`);return e}u(ze,"validateInput");var yn=u(t=>t.includes("/")?t.toLowerCase():`application/${t.toLowerCase()}`,"normalizeTyp"),nu=u((t,e)=>typeof t=="string"?e.includes(t):Array.isArray(t)?e.some(Set.prototype.has.bind(new Set(t))):!1,"checkAudiencePresence");function wn(t,e,s={}){let a;try{a=JSON.parse(ae.decode(e))}catch{}if(!Ae(a))throw new Pe("JWT Claims Set must be a top-level JSON object");let{typ:n}=s;if(n&&(typeof t.typ!="string"||yn(t.typ)!==yn(n)))throw new q('unexpected "typ" JWT header value',a,"typ","check_failed");let{requiredClaims:o=[],issuer:m,subject:r,audience:c,maxTokenAge:h}=s,x=[...o];h!==void 0&&x.push("iat"),c!==void 0&&x.push("aud"),r!==void 0&&x.push("sub"),m!==void 0&&x.push("iss");for(let d of new Set(x.reverse()))if(!(d in a))throw new q(`missing required "${d}" claim`,a,d,"missing");if(m&&!(Array.isArray(m)?m:[m]).includes(a.iss))throw new q('unexpected "iss" claim value',a,"iss","check_failed");if(r&&a.sub!==r)throw new q('unexpected "sub" claim value',a,"sub","check_failed");if(c&&!nu(a.aud,typeof c=="string"?[c]:c))throw new q('unexpected "aud" claim value',a,"aud","check_failed");let P;switch(typeof s.clockTolerance){case"string":P=gt(s.clockTolerance);break;case"number":P=s.clockTolerance;break;case"undefined":P=0;break;default:throw new TypeError("Invalid clockTolerance option type")}let{currentDate:N}=s,i=Ee(N||new Date);if((a.iat!==void 0||h)&&typeof a.iat!="number")throw new q('"iat" claim must be a number',a,"iat","invalid");if(a.nbf!==void 0){if(typeof a.nbf!="number")throw new q('"nbf" claim must be a number',a,"nbf","invalid");if(a.nbf>i+P)throw new q('"nbf" claim timestamp check failed',a,"nbf","check_failed")}if(a.exp!==void 0){if(typeof a.exp!="number")throw new q('"exp" claim must be a number',a,"exp","invalid");if(a.exp<=i-P)throw new Dt('"exp" claim timestamp check failed',a,"exp","check_failed")}if(h){let d=i-a.iat,p=typeof h=="number"?h:gt(h);if(d-P>p)throw new Dt('"iat" claim timestamp check failed (too far in the past)',a,"iat","check_failed");if(d<0-P)throw new q('"iat" claim timestamp check failed (it should be in the past)',a,"iat","check_failed")}return a}u(wn,"validateClaimsSet");var ds=class{static{u(this,"JWTClaimsBuilder")}#e;constructor(e){if(!Ae(e))throw new TypeError("JWT Claims Set MUST be an object");this.#e=structuredClone(e)}data(){return Q.encode(JSON.stringify(this.#e))}get iss(){return this.#e.iss}set iss(e){this.#e.iss=e}get sub(){return this.#e.sub}set sub(e){this.#e.sub=e}get aud(){return this.#e.aud}set aud(e){this.#e.aud=e}set jti(e){this.#e.jti=e}set nbf(e){typeof e=="number"?this.#e.nbf=ze("setNotBefore",e):e instanceof Date?this.#e.nbf=ze("setNotBefore",Ee(e)):this.#e.nbf=Ee(new Date)+gt(e)}set exp(e){typeof e=="number"?this.#e.exp=ze("setExpirationTime",e):e instanceof Date?this.#e.exp=ze("setExpirationTime",Ee(e)):this.#e.exp=Ee(new Date)+gt(e)}set iat(e){typeof e>"u"?this.#e.iat=Ee(new Date):e instanceof Date?this.#e.iat=ze("setIssuedAt",Ee(e)):typeof e=="string"?this.#e.iat=ze("setIssuedAt",Ee(new Date)+gt(e)):this.#e.iat=ze("setIssuedAt",e)}};async function yt(t,e,s){let a=await gn(t,e,s);if(a.protectedHeader.crit?.includes("b64")&&a.protectedHeader.b64===!1)throw new Pe("JWTs MUST NOT use unencoded payload");let o={payload:wn(a.protectedHeader,a.payload,s),protectedHeader:a.protectedHeader};return typeof e=="function"?{...o,key:a.key}:o}u(yt,"jwtVerify");_();w();y();_();w();y();_();w();y();var _n=u(async(t,e,s)=>{let a=await us(t,e,"sign");ns(t,a);let n=await crypto.subtle.sign(cs(t,a.algorithm),a,s);return new Uint8Array(n)},"default");var ls=class{static{u(this,"FlattenedSign")}#e;#t;#s;constructor(e){if(!(e instanceof Uint8Array))throw new TypeError("payload must be an instance of Uint8Array");this.#e=e}setProtectedHeader(e){if(this.#t)throw new TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#s)throw new TypeError("setUnprotectedHeader can only be called once");return this.#s=e,this}async sign(e,s){if(!this.#t&&!this.#s)throw new V("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!as(this.#t,this.#s))throw new V("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let a={...this.#t,...this.#s},n=rs(V,new Map([["b64",!0]]),s?.crit,this.#t,a),o=!0;if(n.has("b64")&&(o=this.#t.b64,typeof o!="boolean"))throw new V('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:m}=a;if(typeof m!="string"||!m)throw new V('JWS "alg" (Algorithm) Header Parameter missing or invalid');is(m,e,"sign");let r=this.#e;o&&(r=Q.encode(es(r)));let c;this.#t?c=Q.encode(es(JSON.stringify(this.#t))):c=Q.encode("");let h=qt(c,Q.encode("."),r),x=await os(e,m),P=await _n(m,x,h),N={signature:es(P),payload:""};return o&&(N.payload=ae.decode(r)),this.#s&&(N.header=this.#s),this.#t&&(N.protected=ae.decode(c)),N}};var ps=class{static{u(this,"CompactSign")}#e;constructor(e){this.#e=new ls(e)}setProtectedHeader(e){return this.#e.setProtectedHeader(e),this}async sign(e,s){let a=await this.#e.sign(e,s);if(a.payload===void 0)throw new TypeError("use the flattened module for creating JWS with b64: false");return`${a.protected}.${a.payload}.${a.signature}`}};_();w();y();var ue=class{static{u(this,"SignJWT")}#e;#t;constructor(e={}){this.#t=new ds(e)}setIssuer(e){return this.#t.iss=e,this}setSubject(e){return this.#t.sub=e,this}setAudience(e){return this.#t.aud=e,this}setJti(e){return this.#t.jti=e,this}setNotBefore(e){return this.#t.nbf=e,this}setExpirationTime(e){return this.#t.exp=e,this}setIssuedAt(e){return this.#t.iat=e,this}setProtectedHeader(e){return this.#e=e,this}async sign(e,s){let a=new ps(this.#t.data());if(a.setProtectedHeader(this.#e),Array.isArray(this.#e?.crit)&&this.#e.crit.includes("b64")&&this.#e.b64===!1)throw new Pe("JWTs MUST NOT use unencoded payload");return a.sign(e,s)}};_();w();y();ve();_();w();y();var ru=["'self'","https://syston-postbus.team-platform-2025.workers.dev","https://api.systontigers.co.uk"].join(" "),ou={"Strict-Transport-Security":"max-age=31536000; includeSubDomains; preload","X-Content-Type-Options":"nosniff","X-Frame-Options":"DENY","Referrer-Policy":"no-referrer","Cross-Origin-Opener-Policy":"same-origin","Cross-Origin-Embedder-Policy":"require-corp","Content-Security-Policy":`default-src 'self'; img-src 'self' https: data:; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src ${ru}; font-src 'self' https:`};function be(t={}){let e=new Headers(t.headers||{});for(let[s,a]of Object.entries(ou))e.set(s,a);return{...t,headers:e}}u(be,"withSecurity");var En=E.object({tenant:E.string().min(1),template:E.string().min(1),channels:E.array(E.string().min(1)).min(1),data:E.record(E.any())});function l(t,e=200,s={}){let a=new Headers({"content-type":"application/json"});new Headers(s).forEach((h,x)=>a.set(x,h));let o=a.get("X-Request-Id")||void 0,m=a.get("X-Release")||void 0,r=t;if(r&&typeof r=="object"){let h=r,x=!1,P={...h};if(o&&P.success===!1){let N=P.error,i=N&&typeof N=="object"&&!Array.isArray(N)?{...N}:{code:"INTERNAL",message:typeof N=="string"?N:"Unexpected error"};i.requestId||(i.requestId=o),P.error=i,x=!0}if(m){let N=P.meta,i=N&&typeof N=="object"&&!Array.isArray(N)?{...N}:{};i.release?P.meta!==i&&(P.meta=i):(i.release=m,P.meta=i,x=!0)}x&&(r=P)}let c=typeof r=="string"?r:JSON.stringify(r);return new Response(c,be({status:e,headers:a}))}u(l,"json");function Vs(t){return t.headers.get("Idempotency-Key")||""}u(Vs,"readIdempotencyKey");function re(t,e="bad request"){if(!t)throw Ye(e)}u(re,"assert");function Ye(t){return Object.assign(new Error(t),{status:400})}u(Ye,"badReq");function ms(){return Date.now()}u(ms,"nowMs");function bn(t){return Date.now()+t*6e4}u(bn,"expMs");function wt(){return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2)}u(wt,"id");function Sn(t=21){let e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",s="",a=new Uint8Array(t);crypto.getRandomValues(a);for(let n=0;n<t;n++)s+=e[a[n]%e.length];return s}u(Sn,"nanoid");async function Ze(t,e){return await t.get(e,"json")}u(Ze,"kvGetJSON");async function Se(t,e,s,a){return t.put(e,JSON.stringify(s),a)}u(Se,"kvPutJSON");async function Xe(t,e){let s=await t.list({prefix:e,limit:1e3});return(await Promise.all(s.keys.map(n=>t.get(n.name,"json")))).filter(Boolean)}u(Xe,"kvListJSON");_();w();y();_();w();y();function Tn(t){let e=Array.isArray(t.roles)?t.roles:typeof t.role=="string"?[t.role]:[],s=t.tenantId??t.tenant_id??t.tenant;return{iss:t.iss??"",aud:t.aud,sub:t.sub,roles:e,tenantId:s,iat:t.iat,exp:t.exp}}u(Tn,"normalizeClaims");function fs(t){let e=t.JWT_SECRET||"";try{return Uint8Array.from(atob(e),s=>s.charCodeAt(0))}catch{return new TextEncoder().encode(e)}}u(fs,"getJwtSecret");async function Fs(t,e){let s=fs(e),{payload:a}=await yt(t,s,{issuer:e.JWT_ISSUER,audience:e.JWT_AUDIENCE,clockTolerance:300});return Tn(a)}u(Fs,"verifyAndNormalize");function xn(t){if(!t.roles.includes("admin"))throw new Error("requires admin role")}u(xn,"requireAdminClaims");async function Qe(t,e){let s=fs(t),a=Math.floor(Date.now()/1e3),n=a+e.ttlMinutes*60;return await new ue({roles:["tenant_admin"],tenant_id:e.tenant_id}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setIssuer(t.JWT_ISSUER).setAudience(t.JWT_AUDIENCE).setIssuedAt(a).setExpirationTime(n).sign(s)}u(Qe,"issueTenantAdminJWT");async function In(t,e=30){let s=fs(t),a=Math.floor(Date.now()/1e3),n=a+e;return await new ue({roles:["service"],type:"service"}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setIssuer(t.JWT_ISSUER||"syston.app").setAudience("internal").setIssuedAt(a).setExpirationTime(n).sign(s)}u(In,"generateServiceJWT");async function Ws(t,e){try{let s=fs(t),{payload:a}=await yt(e,s,{issuer:t.JWT_ISSUER||"syston.app",audience:"internal",clockTolerance:10});return Tn(a).roles.includes("service")}catch(s){return console.error("[Service JWT] Verification failed:",s),!1}}u(Ws,"verifyServiceJWT");function Rn(t){let e=t.headers.get("authorization")||"",s=e.startsWith("Bearer ")?e.slice(7):"";if(!s)throw new Response("Unauthorized",{status:401});return s}u(Rn,"getBearer");function iu(){return new Response(JSON.stringify({success:!1,error:{code:"FORBIDDEN"}}),{status:403,headers:{"content-type":"application/json"}})}u(iu,"forbidden");async function O(t,e){let s=Rn(t);try{return await Fs(s,e)}catch(a){throw console.warn("JWT_VERIFY_FAIL",{path:new URL(t.url).pathname,reason:a?.message||String(a)}),new Response("Unauthorized",{status:401})}}u(O,"requireJWT");async function qe(t,e){let s=Rn(t),a;try{return a=await Fs(s,e),xn(a),a}catch(n){throw console.warn("AUTH_FAIL",{path:new URL(t.url).pathname,reason:n?.message||String(n),hdrPrefix:(t.headers.get("authorization")||"").slice(0,16),claims:a}),iu()}}u(qe,"requireAdmin");function D(t,e){return"roles"in t&&Array.isArray(t.roles)?t.roles.includes(e):"role"in t&&t.role===e}u(D,"hasRole");_();w();y();async function Bs(t,e,s,a){let n=a||await cu(e,s),o=await t.KV_IDEMP.get(n);return o?{hit:!0,key:n,response:JSON.parse(o)}:{hit:!1,key:n,store:u(async m=>{await t.KV_IDEMP.put(n,JSON.stringify(m),{expirationTtl:86400})},"store")}}u(Bs,"ensureIdempotent");async function hs(t,e,s){await t.KV_IDEMP.put(e,JSON.stringify(s),{expirationTtl:86400})}u(hs,"setFinalIdempotent");async function cu(t,e){let s=t+":"+JSON.stringify(e),a=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));return"idem:"+t+":"+[...new Uint8Array(a)].map(n=>n.toString(16).padStart(2,"0")).join("")}u(cu,"hashKey");_();w();y();var vn=u(t=>`tenant:${t}`,"key");async function $t(t,e){let s=await t.KV_IDEMP.get(vn(e));if(!s)return null;try{return JSON.parse(s)}catch{return null}}u($t,"getTenantConfig");async function oe(t,e){e.updated_at=Date.now(),await t.KV_IDEMP.put(vn(e.id),JSON.stringify(e))}u(oe,"putTenantConfig");async function ie(t,e){let s=await $t(t,e);if(s)return s;let a={id:e,flags:{use_make:!1,direct_yt:!0},creds:{},makeWebhookUrl:null,created_at:Date.now(),updated_at:Date.now()};return await oe(t,a),a}u(ie,"ensureTenant");async function Js(t,e,s){let a=await ie(t,e);return a.flags={...a.flags,...s},await oe(t,a),a}u(Js,"updateFlags");async function Hs(t,e,s){let a=await ie(t,e);return a.makeWebhookUrl=s,await oe(t,a),a}u(Hs,"setMakeWebhook");async function Pn(t,e,s){let a=await ie(t,e);return a.flags={...a.flags,...s},await oe(t,a),a}u(Pn,"setTenantFlags");async function An(t,e,s,a){let n=await ie(t,e);return n.creds||(n.creds={}),n.creds.make||(n.creds.make={}),n.creds.make[s]=a,await oe(t,n),n}u(An,"setChannelWebhook");async function On(t,e,s,a){let n=await ie(t,e);return n.creds||(n.creds={}),n.creds.yt||(n.creds.yt={}),n.creds.yt.client_id=s,n.creds.yt.client_secret=a,await oe(t,n),n}u(On,"setYouTubeBYOGoogle");function Mt(t,e){try{if(!t)return!1;let s=(e||"").trim();if(!s)return!1;let a=s.split(",").map(o=>o.trim().toLowerCase()).filter(Boolean),n=t.toLowerCase();if(a.includes(n)||a.includes("*.make.com")&&n.endsWith(".make.com")||a.includes("make.com")&&(n==="make.com"||n.endsWith(".make.com")))return!0;for(let o of a)if(o.startsWith(".")){if(n.endsWith(o))return!0}else if(o.startsWith("*.")){let m=o.slice(1);if(n.endsWith(m))return!0}return!1}catch{return!1}}u(Mt,"isAllowedWebhookHost");_();w();y();_();w();y();async function kn(t,e,s,a){let n=e.makeWebhookUrl||t.MAKE_WEBHOOK_BASE;if(!n)throw new Error("Make webhook not configured");let o=await fetch(n,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({template:s,data:a,tenant:e.id})});if(!o.ok)throw new Error(`Make failed ${o.status}`);try{return await o.json()}catch{return{ok:!0}}}u(kn,"publishViaMake");_();w();y();async function Cn(t,e,s,a){let n=await uu(t,e.id);if(!n)throw new Error("YouTube not configured for tenant");let o=await du(n),m=String(a.privacy||"unlisted"),r=String(a.start_iso||new Date(Date.now()+10*6e4).toISOString()),c=String(a.title||"Match Live"),h=String(a.description||"Live stream"),x=await lu(o,{title:c,description:h,scheduledStartTime:r,privacyStatus:m}),P=await pu(o,{title:`${c} Stream`});return await mu(o,x.id,P.id),{ok:!0,watch_url:`https://www.youtube.com/watch?v=${x.id}`,broadcast_id:x.id,stream_id:P.id,start_iso:r}}u(Cn,"publishYouTube");async function uu(t,e){let s=await t.KV_IDEMP.get(`yt:${e}`);return s?JSON.parse(s):null}u(uu,"getTenantYouTubeCreds");async function du(t){let e=new URLSearchParams({client_id:t.client_id,client_secret:t.client_secret,refresh_token:t.refresh_token,grant_type:"refresh_token"}),s=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:e.toString()});if(!s.ok)throw new Error(`OAuth token refresh failed ${s.status}`);let a=await s.json();if(!a.access_token)throw new Error("No access_token");return a.access_token}u(du,"getGoogleAccessToken");async function lu(t,e){let s={snippet:{title:e.title,description:e.description,scheduledStartTime:e.scheduledStartTime},status:{privacyStatus:e.privacyStatus},contentDetails:{enableAutoStart:!0,enableAutoStop:!0}},a=await fetch("https://www.googleapis.com/youtube/v3/liveBroadcasts?part=snippet,contentDetails,status",{method:"POST",headers:{authorization:`Bearer ${t}`,"content-type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error(`createLiveBroadcast failed ${a.status}`);return await a.json()}u(lu,"createLiveBroadcast");async function pu(t,e){let s={snippet:{title:e.title},cdn:{format:"1080p",ingestionType:"rtmp"}},a=await fetch("https://www.googleapis.com/youtube/v3/liveStreams?part=snippet,cdn,status",{method:"POST",headers:{authorization:`Bearer ${t}`,"content-type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error(`createLiveStream failed ${a.status}`);return await a.json()}u(pu,"createLiveStream");async function mu(t,e,s){let a=new URL("https://www.googleapis.com/youtube/v3/liveBroadcasts/bind");a.searchParams.set("id",e),a.searchParams.set("part","id,contentDetails"),a.searchParams.set("streamId",s);let n=await fetch(a.toString(),{method:"POST",headers:{authorization:`Bearer ${t}`}});if(!n.ok)throw new Error(`bindBroadcast failed ${n.status}`);return await n.json()}u(mu,"bindBroadcast");_();w();y();async function Dn(t){let{tenant:e,job:s,env:a,fetchImpl:n=fetch}=t,o=e.creds?.make?.fb;if(o){let r={kind:"facebook_post",tenant:e.id,template:s.template,data:s.data,ts:Date.now()},c=await n(o,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(r)});if(!c.ok)throw new Error(`BYO-Make webhook failed for FB: ${c.status}`);return}if(e.flags?.managed?.fb??!1){let r=e.creds?.fb;throw!r?.page_access_token||!r?.page_id?new Error("Managed FB enabled but credentials not configured. Please connect Facebook or use BYO-Make."):new Error("Facebook Managed publishing not yet implemented. Use BYO-Make or wait for update.")}throw new Error("Facebook channel not configured. Enable Managed mode or set BYO-Make webhook.")}u(Dn,"publishFacebook");_();w();y();async function Nn(t){let{tenant:e,job:s,env:a,fetchImpl:n=fetch}=t,o=e.creds?.make?.ig;if(o){let r={kind:"instagram_post",tenant:e.id,template:s.template,data:s.data,ts:Date.now()},c=await n(o,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(r)});if(!c.ok)throw new Error(`BYO-Make webhook failed for IG: ${c.status}`);return}if(e.flags?.managed?.ig??!1){let r=e.creds?.ig;throw!r?.ig_user_id||!r?.access_token?new Error("Managed IG enabled but credentials not configured. Please connect Instagram or use BYO-Make."):new Error("Instagram Managed publishing not yet implemented. Use BYO-Make or wait for update.")}throw new Error("Instagram channel not configured. Enable Managed mode or set BYO-Make webhook.")}u(Nn,"publishInstagram");_();w();y();async function $n(t){let{tenant:e,job:s,env:a,fetchImpl:n=fetch}=t,o=e.creds?.make?.tiktok;if(o){let r={kind:"tiktok_post",tenant:e.id,template:s.template,data:s.data,ts:Date.now()},c=await n(o,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(r)});if(!c.ok)throw new Error(`BYO-Make webhook failed for TikTok: ${c.status}`);return}if(e.flags?.managed?.tiktok??!1){let r=e.creds?.tiktok;throw!r?.refresh_token||!r?.open_id?new Error("Managed TikTok enabled but credentials not configured. Please connect TikTok or use BYO-Make."):new Error("TikTok Managed publishing not yet implemented. Use BYO-Make or wait for update.")}throw new Error("TikTok channel not configured. Enable Managed mode or set BYO-Make webhook.")}u($n,"publishTikTok");_();w();y();async function Mn(t){let{tenant:e,job:s,env:a,fetchImpl:n=fetch}=t,o=e.creds?.make?.x;if(o){let r={kind:"x_post",tenant:e.id,template:s.template,data:s.data,ts:Date.now()},c=await n(o,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(r)});if(!c.ok)throw new Error(`BYO-Make webhook failed for X: ${c.status}`);return}if(e.flags?.managed?.x??!1){let r=e.creds?.x;throw!r?.access_token||!r?.access_secret?new Error("Managed X enabled but credentials not configured. Please connect X (Twitter) or use BYO-Make."):new Error("X (Twitter) Managed publishing not yet implemented. Use BYO-Make or wait for update.")}throw new Error("X (Twitter) channel not configured. Enable Managed mode or set BYO-Make webhook.")}u(Mn,"publishX");_();w();y();var Ln=u((t,e)=>{let s=new Date().toISOString().split("T")[0];return`rate:${t}:${e}:${s}`},"getCounterKey"),fu={yt:50,fb:200,ig:100,tiktok:50,x:300};async function Un(t,e,s){if(t==="yt"){let a=Ln(e.id,t),n=await s.KV_IDEMP.get(a),o=n?parseInt(n,10):0,m=fu[t];if(o>=m)return!0}return!1}u(Un,"shouldDefer");async function jn(t,e,s){let a=Ln(e.id,t),n=await s.KV_IDEMP.get(a),o=n?parseInt(n,10):0;await s.KV_IDEMP.put(a,String(o+1),{expirationTtl:9e4})}u(jn,"incrementCounter");var Kn={async queue(t,e){for(let s of t.messages){let a=s.body;try{let n=a?.tenant?await $t(e,a.tenant):null;if(!n)throw new Error(`Tenant ${a.tenant} not found`);let o=!!n?.flags?.use_make,m=n?.makeWebhookUrl||null;if(o&&m){let h={};for(let x of a.channels)h[x]=await kn(e,n,a.template,a.data);await hs(e,a.idemKey,{success:!0,data:{results:h}}),await s.ack();continue}let r={},c=[];for(let h of a.channels)try{if(await Un(h,n,e)){c.push({channel:h,reason:`${h}_quota_exhausted`}),r[h]={status:"deferred",fallback:"share",suggested:["share_native","upload_stream"]};continue}let P={tenant:n,job:{template:a.template,data:a.data,text:a.data.text||a.data.msg||a.data.title,mediaUrl:a.data.mediaUrl||a.data.videoUrl},env:e};switch(h){case"yt":await Cn(e,n,a.template,a.data);break;case"fb":await Dn(P);break;case"ig":await Nn(P);break;case"tiktok":await $n(P);break;case"x":await Mn(P);break;default:throw new Error(`Unknown channel: ${h}`)}await jn(h,n,e),r[h]={status:"published"}}catch(x){if(x?.message?.includes("not configured")||x?.message?.includes("not yet implemented"))c.push({channel:h,reason:x.message}),r[h]={status:"fallback_required",error:x.message,fallback:"share",suggested:["share_native","upload_stream"]};else throw x}await hs(e,a.idemKey,{success:c.length===0,data:{results:r,fallbacks:c.length>0?c:void 0}}),await s.ack()}catch(n){if(e.DLQ&&(await e.DLQ.send({tenant:a.tenant,error:n?.message||"unknown",job:a,timestamp:Date.now()}).catch(()=>{}),e.DLQ_ALERT_URL))try{await fetch(e.DLQ_ALERT_URL,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({tenant:a.tenant,reason:n?.message||"unknown",ts:Date.now()})})}catch{}await hs(e,a.idemKey,{success:!1,error:{code:"DLQ",message:String(n?.message||n)}}),await s.ack()}}}};_();w();y();async function Gs(t,e,s){let a=`tenants:${e}:events:${s.id}`;await t.KV_IDEMP.put(a,JSON.stringify(s));let n=`tenants:${e}:events:index`,o=await t.KV_IDEMP.get(n,"json")||[],r=[{id:s.id,title:s.title,type:s.type,startUtc:s.startUtc,teamId:s.teamId},...o.filter(c=>c.id!==s.id)];await t.KV_IDEMP.put(n,JSON.stringify(r.slice(0,5e3)))}u(Gs,"putEvent");async function zs(t,e,s){let a=`tenants:${e}:events:${s}`;return await t.KV_IDEMP.get(a,"json")}u(zs,"getEvent");async function Vn(t,e,s){await t.KV_IDEMP.delete(`tenants:${e}:events:${s}`);let a=`tenants:${e}:events:index`,n=await t.KV_IDEMP.get(a,"json")||[];await t.KV_IDEMP.put(a,JSON.stringify(n.filter(o=>o.id!==s)))}u(Vn,"deleteEvent");async function Fn(t,e){let s=`tenants:${e}:events:index`;return await t.KV_IDEMP.get(s,"json")||[]}u(Fn,"listEvents");async function Wn(t,e,s,a,n){let o=`tenants:${e}:events:${s}:rsvp:${a}`;await t.KV_IDEMP.put(o,n,{expirationTtl:60*60*24*120})}u(Wn,"setRsvp");async function Bn(t,e,s,a){let n=`tenants:${e}:events:${s}:checkins`,o=await t.KV_IDEMP.get(n,"json")||[];o.push({userId:a,ts:Date.now()}),await t.KV_IDEMP.put(n,JSON.stringify(o),{expirationTtl:60*60*24*180})}u(Bn,"addCheckin");_();w();y();async function Jn(t,e,s,a,n){let o=`tenants:${e}:devices:${s}`,r=(await t.KV_IDEMP.get(o,"json")||[]).filter(c=>c.platform!==a);r.push({platform:a,token:n}),await t.KV_IDEMP.put(o,JSON.stringify(r))}u(Jn,"registerDevice");_();w();y();var Ys=u(t=>`invites/${t}`,"INVITES");async function Hn(t,e){re(e.tenant,"tenant required"),re(e.role,"role required");let s=e.role;e.role==="team_manager"&&(re(e.teamId,"teamId required for team_manager role"),s=`team_manager:${e.teamId}`),e.role==="coach"&&(re(e.teamId,"teamId required for coach role"),s=`coach:${e.teamId}`);let a=Sn(24),n={token:a,tenantId:e.tenant,teamId:e.teamId,role:s,maxUses:Math.max(1,e.maxUses??50),used:0,exp:bn(e.ttl_minutes??60*24*7),createdBy:e.createdBy,createdAt:ms()};await t.KV_IDEMP.put(Ys(a),JSON.stringify(n),{expirationTtl:Math.ceil((n.exp-ms())/1e3)});let o=`${t.SETUP_URL.replace(/\/$/,"")}/join?token=${encodeURIComponent(a)}`;return{ok:!0,token:a,inviteUrl:o,invite:n}}u(Hn,"createInvite");async function Gn(t,e){let s=await Ze(t.KV_IDEMP,Ys(e));if(!s)throw Ye("invite not found");return s}u(Gn,"getInvite");async function zn(t,e){let s=Ys(e),a=await Ze(t.KV_IDEMP,s);if(!a)throw Ye("invalid token");if(a.exp<ms())throw Ye("token expired");if(a.used>=a.maxUses)throw Ye("token fully used");return a.used+=1,await Se(t.KV_IDEMP,s,a),a}u(zn,"consumeInvite");_();w();y();var gu=u((t,e)=>`teams/${t}/${e}`,"TEAM_KEY"),yu=u(t=>`teams/${t}/`,"TEAM_PREFIX");async function Yn(t,e){re(e.tenant&&e.teamId&&e.name,"tenant, teamId, name required");let s=gu(e.tenant,e.teamId),a=await Ze(t.KV_IDEMP,s);if(a)return a;let n={tenantId:e.tenant,teamId:e.teamId,name:e.name,ageGroup:e.ageGroup,coaches:[],createdAt:Date.now()};return await Se(t.KV_IDEMP,s,n),n}u(Yn,"createTeam");async function Zn(t,e){return await Xe(t.KV_IDEMP,yu(e))}u(Zn,"listTeams");_();w();y();var _u=u((t,e)=>`chat/room/${t}/${e}`,"ROOM_KEY"),Eu=u(t=>`chat/room/${t}/`,"ROOM_PREFIX"),Xn=u((t,e)=>`chat/msg/${t}/${e}/`,"MSG_PREFIX");async function Qn(t,e){re(e.tenant&&e.roomId&&e.teamId&&e.type,"missing params");let s=_u(e.tenant,e.roomId),a=await Ze(t.KV_IDEMP,s);if(a)return a;let n={roomId:e.roomId,tenantId:e.tenant,teamId:e.teamId,type:e.type,createdAt:Date.now()};return await Se(t.KV_IDEMP,s,n),n}u(Qn,"createRoom");async function Zs(t,e,s){let a=await Xe(t.KV_IDEMP,Eu(e));return s?a.filter(n=>n.teamId===s):a}u(Zs,"listRooms");async function qn(t,e){re(e.text&&e.text.trim(),"empty text");let s={msgId:wt(),userId:e.userId,text:e.text.trim(),ts:Date.now()},a=`${Xn(e.tenant,e.roomId)}${s.msgId}`;return await t.KV_IDEMP.put(a,JSON.stringify(s)),s}u(qn,"addMessage");async function er(t,e){let s=Xn(e.tenant,e.roomId),a=await t.KV_IDEMP.list({prefix:s,limit:Math.min(200,e.limit??50)});return(await Promise.all(a.keys.map(o=>t.KV_IDEMP.get(o.name,"json")))).filter(Boolean).sort((o,m)=>o.ts-m.ts)}u(er,"listMessages");_();w();y();var Su=u((t,e)=>`gallery/album/${t}/${e}`,"ALBUM_KEY"),Tu=u(t=>`gallery/album/${t}/`,"ALBUM_PREFIX"),xu=u((t,e,s)=>`gallery/object/${t}/${e}/${s}`,"OBJ_KEY"),Iu=u((t,e)=>`gallery/object/${t}/${e}/`,"OBJ_PREFIX");async function tr(t,e){re(e.tenant&&e.title,"tenant + title required");let s={albumId:wt(),tenantId:e.tenant,title:e.title,teamId:e.teamId,eventId:e.eventId,createdBy:e.createdBy,createdAt:Date.now()};return await Se(t.KV_IDEMP,Su(e.tenant,s.albumId),s),s}u(tr,"createAlbum");async function Xs(t,e,s){let a=await Xe(t.KV_IDEMP,Tu(e));return s?a.filter(n=>n.teamId===s):a}u(Xs,"listAlbums");async function sr(t,e){let s=`media/${e.tenant}/${e.albumId}/${Date.now()}-${wt()}`;return await t.R2_MEDIA.put(s,e.file,{httpMetadata:{contentType:e.contentType}}),{r2Key:s}}u(sr,"uploadBinary");async function ar(t,e){let s={id:wt(),r2Key:e.r2Key,uploaderId:e.uploaderId,playerTags:e.playerTags??[],consentCheck:!!e.consentCheck,ts:Date.now()};return await Se(t.KV_IDEMP,xu(e.tenant,e.albumId,s.id),s),s}u(ar,"commitMedia");async function nr(t,e){return(await Xe(t.KV_IDEMP,Iu(e.tenant,e.albumId))).sort((a,n)=>a.ts-n.ts)}u(nr,"listMedia");_();w();y();async function ur(t,e){try{let s=Cu(e.clubShortName);if(await t.KV_IDEMP.get(`tenant:${s}`))return{success:!1,error:{code:"TENANT_EXISTS",message:`Tenant '${s}' already exists`}};let n=e.plan||"free",o=null;if(e.promoCode){let{PromoCodeService:p}=await Promise.resolve().then(()=>(Ut(),Lt)),g=await new p(t).applyPromoCode(e.promoCode,s);g.success&&g.discount?(o={code:e.promoCode,discount:g.discount},g.discount.type==="plan_upgrade"&&(n=g.discount.plan),console.log(`[Provisioning] Promo code applied: ${e.promoCode} for ${s}`)):console.warn(`[Provisioning] Invalid promo code: ${e.promoCode}`,g.error)}let m=Du(n),r={id:s,name:e.clubName,locale:e.locale||"en-GB",tz:e.timezone||"Europe/London",flags:m,makeWebhookUrl:e.makeWebhookUrl||null,metadata:{contactEmail:e.contactEmail,contactName:e.contactName,plan:n,createdAt:new Date().toISOString(),provisionedBy:"automated",...o&&{promoCode:o.code,promoDiscount:o.discount}}};await oe(t,r);let c=await Qe(t,{tenant_id:s,ttlMinutes:525600}),h=await Qe(t,{tenant_id:s,ttlMinutes:525600}),x=t.SETUP_URL||"https://setup-console.team-platform-2025.workers.dev",P=await Nu(t,s),N=`${x}?token=${P}`,i=t.ADMIN_CONSOLE_URL||"https://admin-console.team-platform-2025.workers.dev";(t.SENDGRID_API_KEY||t.RESEND_API_KEY)&&await $u(t,{to:e.contactEmail,clubName:e.clubName,setupUrl:N,adminJWT:c});let d=null;if(t.APPS_SCRIPT_AUTO_DEPLOY==="true"){let{deployAppsScriptForTenant:p}=await Promise.resolve().then(()=>(cr(),ir));d=await p(t,s,e.clubName,h),d.success?console.log(`[Provisioning] Apps Script deployed for ${s}:`,d.scriptId):console.warn("[Provisioning] Apps Script deployment failed (non-critical):",d.error)}return{success:!0,tenant:{id:s,name:e.clubName,adminJWT:c,automationJWT:h,setupUrl:N,adminConsoleUrl:i,appsScript:d?.success?{scriptId:d.scriptId,scriptUrl:d.scriptUrl,webAppUrl:d.webAppUrl}:null}}}catch(s){return console.error("PROVISIONING_ERROR",s),{success:!1,error:{code:"PROVISIONING_FAILED",message:s.message||"Unknown error"}}}}u(ur,"provisionTenant");function Cu(t){return t.toLowerCase().replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").substring(0,32)}u(Cu,"sanitizeTenantId");function Du(t){switch(t){case"enterprise":case"managed":return{use_make:!1,direct_yt:!0,direct_fb:!0,direct_ig:!0};case"free":default:return{use_make:!0,direct_yt:!1}}}u(Du,"determineFlagsForPlan");async function Nu(t,e){let s=crypto.randomUUID(),a=Date.now()+24*60*60*1e3;return await t.KV_IDEMP.put(`setup-token:${s}`,JSON.stringify({tenantId:e,expiresAt:a})),s}u(Nu,"generateSetupToken");async function $u(t,e){t.RESEND_API_KEY&&await fetch("https://api.resend.com/emails",{method:"POST",headers:{Authorization:`Bearer ${t.RESEND_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({from:"onboarding@yourdomain.com",to:e.to,subject:`Welcome to ${e.clubName} - Platform Setup`,html:`
        <h1>Welcome to the Platform!</h1>
        <p>Your club <strong>${e.clubName}</strong> has been set up successfully.</p>

        <h2>Next Steps:</h2>
        <ol>
          <li><a href="${e.setupUrl}">Complete your setup</a> (link expires in 24 hours)</li>
          <li>Configure your automation preferences</li>
          <li>Connect your social media accounts</li>
        </ol>

        <h2>Your Credentials:</h2>
        <p><strong>Admin Token:</strong> ${e.adminJWT.substring(0,20)}...</p>
        <p><em>Keep this secure - it provides full access to your account.</em></p>

        <p>Need help? Reply to this email or visit our documentation.</p>
      `})})}u($u,"sendWelcomeEmail");_();w();y();var Mu=new Set(["https://app.systontigers.co.uk","https://admin.systontigers.co.uk","https://setup.systontigers.co.uk","https://app.example.tld","https://admin.example.tld","https://setup.example.tld"]);function dr(t){let e=new Headers,s=t&&Mu.has(t)?t:"";return s&&e.set("Access-Control-Allow-Origin",s),e.set("Vary","Origin"),e.set("Access-Control-Allow-Methods","GET,POST,PUT,DELETE,OPTIONS"),e.set("Access-Control-Allow-Headers","authorization,content-type"),e.set("Access-Control-Max-Age","600"),e}u(dr,"corsHeaders");function lr(t){return t.method==="OPTIONS"}u(lr,"isPreflight");_();w();y();_();w();y();function L(t){console.log(JSON.stringify({t:new Date().toISOString(),...t}))}u(L,"logJSON");function pr(){try{return crypto.randomUUID()}catch{return Math.random().toString(36).slice(2)}}u(pr,"newRequestId");var Lu=60,Uu=60,ju="global";async function mr(t,e,s={}){if((e.ENVIRONMENT||e.NODE_ENV||"development")!=="production")return{ok:!0};let n=e.RATE_LIMIT_KV;if(!n)return{ok:!0};let o=s.limit??Lu,m=s.windowSeconds??Uu,r=s.scope??ju,c=s.requestId,h=s.path||new URL(t.url).pathname,x=t.headers.get("CF-Connecting-IP")||"unknown",P=`rl:${r}:${x}`;try{let N=await n.get(P),i=N?Number.parseInt(N,10):o;if(Number.isFinite(i)||(i=o),i<=0){let p=m;return L({level:"warn",msg:"rate_limited",path:h,requestId:c,status:429}),{ok:!1,remaining:0,limit:o,retryAfter:p}}let d=i-1;return await n.put(P,String(d),{expirationTtl:m}),{ok:!0,remaining:d,limit:o}}catch{return L({level:"error",msg:"rate_limit_error",status:500,path:h,requestId:c}),{ok:!0}}}u(mr,"rateLimit");_();w();y();var ys=class extends Error{static{u(this,"RequestValidationError")}status;issues;constructor(e,s=400){super("INVALID_REQUEST"),this.name="RequestValidationError",this.status=s,this.issues=e}};function et(t){return t instanceof ys||typeof t=="object"&&t!==null&&"issues"in t&&Array.isArray(t.issues)&&"status"in t}u(et,"isValidationError");function tt(t,e){let s=t.safeParse(e);if(!s.success){let a=s.error.issues.map(n=>({path:n.path,message:n.message,code:n.code}));throw new ys(a,400)}return s.data}u(tt,"parse");function W(t,e=200,s){let a=new Headers(s||{});return a.set("Content-Type","application/json"),new Response(JSON.stringify(t),{status:e,headers:a})}u(W,"json");_();w();y();async function fr(){return Response.json({status:"ok",version:APP_VERSION,ts:new Date().toISOString()},{status:200})}u(fr,"healthz");async function hr(t){return Response.json({status:"ready",version:APP_VERSION,ts:new Date().toISOString()},{status:200})}u(hr,"readyz");_();w();y();ve();var Ku=E.object({clubName:E.string().min(1,"Club name required"),clubSlug:E.string().min(3,"Slug must be at least 3 characters").regex(/^[a-z0-9-]+$/,"Slug must be lowercase alphanumeric with hyphens"),email:E.string().email("Valid email required"),plan:E.enum(["starter","pro"]),promoCode:E.string().optional()}),Vu=E.object({primaryColor:E.string().regex(/^#[0-9A-Fa-f]{6}$/,"Must be valid hex color"),secondaryColor:E.string().regex(/^#[0-9A-Fa-f]{6}$/,"Must be valid hex color")}),Fu=E.object({webhookUrl:E.string().url(),webhookSecret:E.string().min(16,"Secret must be at least 16 characters")});async function gr(t,e){try{let s=await In(t,30),a=t.BACKEND_URL||"http://localhost:8787";await fetch(`${a}/internal/provision/queue`,{method:"POST",headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},body:JSON.stringify({tenantId:e})}),console.log(`[Signup] Queued provisioning for ${e}`)}catch(s){console.error(`[Signup] Failed to queue provisioning for ${e}:`,s)}}u(gr,"queueProvisioning");async function yr(t,e,s,a){try{let n=await t.json().catch(()=>({})),o=tt(Ku,n);if(await e.DB.prepare("SELECT id FROM tenants WHERE slug = ?").bind(o.clubSlug).first())return W({success:!1,error:{code:"SLUG_TAKEN",message:"That club slug is already in use"}},400,a);if(await e.DB.prepare("SELECT id FROM tenants WHERE email = ?").bind(o.email).first())return W({success:!1,error:{code:"EMAIL_EXISTS",message:"That email is already registered"}},400,a);let c=null,h=0,x=0;if(o.promoCode){let d=await e.DB.prepare(`
        SELECT id, code, discount_percent, max_uses, used_count, valid_until
        FROM promo_codes
        WHERE code = ? COLLATE NOCASE
      `).bind(o.promoCode).first();if(!d)return W({success:!1,error:{code:"INVALID_PROMO",message:"Invalid promo code"}},400,a);if(d.valid_until&&d.valid_until<Math.floor(Date.now()/1e3))return W({success:!1,error:{code:"PROMO_EXPIRED",message:"Promo code has expired"}},400,a);if(d.max_uses&&d.used_count>=d.max_uses)return W({success:!1,error:{code:"PROMO_MAXED",message:"Promo code has reached maximum uses"}},400,a);c=d.id,h=d.discount_percent,h===100&&(x=1)}let P=`tenant_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,N=Math.floor(Date.now()/1e3)+14*24*60*60;if(await e.DB.prepare(`
      INSERT INTO tenants (id, slug, name, email, plan, status, comped, trial_ends_at)
      VALUES (?, ?, ?, ?, ?, 'trial', ?, ?)
    `).bind(P,o.clubSlug,o.clubName,o.email,o.plan,x,N).run(),await e.DB.prepare(`
      INSERT INTO tenant_brand (tenant_id, primary_color, secondary_color)
      VALUES (?, '#FFD700', '#000000')
    `).bind(P).run(),c){let d=`redemption_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;await e.DB.prepare(`
        INSERT INTO promo_redemptions (id, tenant_id, promo_code_id)
        VALUES (?, ?, ?)
      `).bind(d,P,c).run(),await e.DB.prepare(`
        UPDATE promo_codes SET used_count = used_count + 1 WHERE id = ?
      `).bind(c).run()}let i=await Qe(e,P,o.email);return W({success:!0,tenant:{id:P,slug:o.clubSlug,name:o.clubName,email:o.email,plan:o.plan,status:"trial",comped:x===1,trialEndsAt:N},discount:h,jwt:i},200,a)}catch(n){return et(n)?W({success:!1,error:{code:"INVALID_REQUEST",message:"Validation failed",issues:n.issues}},400,a):(L("error",s,{message:"SIGNUP_START_ERROR",error:n.message}),W({success:!1,error:{code:"SIGNUP_FAILED",message:n.message}},500,a))}}u(yr,"signupStart");async function wr(t,e,s,a){try{let n=await O(t,e),o=n.tenant_id||n.tenantId,m=await t.json().catch(()=>({})),r=tt(Vu,m);return await e.DB.prepare(`
      UPDATE tenant_brand
      SET primary_color = ?, secondary_color = ?, updated_at = unixepoch()
      WHERE tenant_id = ?
    `).bind(r.primaryColor,r.secondaryColor,o).run(),W({success:!0},200,a)}catch(n){if(n instanceof Response)throw n;return et(n)?W({success:!1,error:{code:"INVALID_REQUEST",message:"Validation failed",issues:n.issues}},400,a):(L("error",s,{message:"BRAND_UPDATE_ERROR",error:n.message}),W({success:!1,error:{code:"BRAND_UPDATE_FAILED",message:n.message}},500,a))}}u(wr,"signupBrand");async function _r(t,e,s,a){try{let n=await O(t,e),o=n.tenant_id||n.tenantId,m=await e.DB.prepare("SELECT plan FROM tenants WHERE id = ?").bind(o).first();if(!m||m.plan!=="starter")return W({success:!1,error:{code:"PLAN_MISMATCH",message:"This endpoint is only for Starter plan"}},400,a);let r=await t.json().catch(()=>({})),c=tt(Fu,r),h=new URL(c.webhookUrl).hostname;if(!Mt(h,e))return W({success:!1,error:{code:"INVALID_WEBHOOK_HOST",message:"Webhook host not allowed"}},400,a);let x=`make_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;return await e.DB.prepare(`
      INSERT INTO make_connections (id, tenant_id, webhook_url, webhook_secret)
      VALUES (?, ?, ?, ?)
      ON CONFLICT(tenant_id) DO UPDATE SET
        webhook_url = excluded.webhook_url,
        webhook_secret = excluded.webhook_secret
    `).bind(x,o,c.webhookUrl,c.webhookSecret).run(),await e.DB.prepare(`
      UPDATE tenants SET status = 'active', updated_at = unixepoch() WHERE id = ?
    `).bind(o).run(),await gr(e,o),W({success:!0},200,a)}catch(n){if(n instanceof Response)throw n;return et(n)?W({success:!1,error:{code:"INVALID_REQUEST",message:"Validation failed",issues:n.issues}},400,a):(L("error",s,{message:"MAKE_SETUP_ERROR",error:n.message}),W({success:!1,error:{code:"MAKE_SETUP_FAILED",message:n.message}},500,a))}}u(_r,"signupStarterMake");async function Er(t,e,s,a){try{let n=await O(t,e),o=n.tenant_id||n.tenantId,m=await e.DB.prepare("SELECT plan FROM tenants WHERE id = ?").bind(o).first();if(!m||m.plan!=="pro")return W({success:!1,error:{code:"PLAN_MISMATCH",message:"This endpoint is only for Pro plan"}},400,a);let r=`pro_${Date.now()}_${Math.random().toString(36).substring(2,9)}`;return await e.DB.prepare(`
      INSERT INTO pro_automation (id, tenant_id)
      VALUES (?, ?)
      ON CONFLICT(tenant_id) DO NOTHING
    `).bind(r,o).run(),await e.DB.prepare(`
      UPDATE tenants SET status = 'active', updated_at = unixepoch() WHERE id = ?
    `).bind(o).run(),await gr(e,o),W({success:!0},200,a)}catch(n){if(n instanceof Response)throw n;return L("error",s,{message:"PRO_CONFIRM_ERROR",error:n.message}),W({success:!1,error:{code:"PRO_CONFIRM_FAILED",message:n.message}},500,a)}}u(Er,"signupProConfirm");_();w();y();async function br(t,e){let s=await t.json().catch(()=>({})),a=(s.email||"").toString().trim().toLowerCase(),n=(s.tenantId||"").toString().trim();if(!a||!n)return W({success:!1,error:"email and tenantId required"},400);let o=Math.floor(Date.now()/1e3),m=await new ue({type:"magic_link",roles:["owner","admin"],tenantId:n}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setIssuer(e.JWT_ISSUER||"syston.app").setAudience("syston-admin").setSubject(a).setIssuedAt(o).setExpirationTime(o+24*3600).sign(new TextEncoder().encode(e.JWT_SECRET)),r=`${e.ADMIN_CONSOLE_URL}/admin/onboard?token=${m}`;return console.log(`[Magic] Link for ${a}: ${r}`),W({success:!0})}u(br,"handleMagicStart");async function Sr(t,e){let s=new URL(t.url).searchParams.get("token")||"";if(!s)return W({success:!1,error:"token required"},400);let{payload:a}=await yt(s,new TextEncoder().encode(e.JWT_SECRET),{issuer:e.JWT_ISSUER||"syston.app",audience:"syston-admin",clockTolerance:10}),n=Math.floor(Date.now()/1e3),o=await new ue({roles:["owner","admin"],tenantId:a.tenantId}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setIssuer(e.JWT_ISSUER||"syston.app").setAudience("syston-admin").setSubject(a.sub).setIssuedAt(n).setExpirationTime(n+7*24*3600).sign(new TextEncoder().encode(e.JWT_SECRET)),m=new Headers({"content-type":"application/json"});return m.append("Set-Cookie",`owner_session=${o}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=${7*24*3600}`),new Response(JSON.stringify({success:!0,tenantId:a.tenantId}),{status:200,headers:m})}u(Sr,"handleMagicVerify");_();w();y();async function Tr(t,e){try{let s=t.headers.get("Authorization");if(!s||!s.startsWith("Bearer "))return Response.json({success:!1,error:{code:"UNAUTHORIZED",message:"Service authorization required"}},{status:401});let a=s.substring(7);if(!await Ws(e,a))return Response.json({success:!1,error:{code:"INVALID_TOKEN",message:"Invalid service token"}},{status:401});let o=await t.json();if(!o.tenantId)return Response.json({success:!1,error:{code:"MISSING_TENANT_ID",message:"Tenant ID is required"}},{status:400});let m=await e.DB.prepare("SELECT id, plan FROM tenants WHERE id = ?").bind(o.tenantId).first();if(!m)return Response.json({success:!1,error:{code:"TENANT_NOT_FOUND",message:"Tenant not found"}},{status:404});let r=e.PROVISIONER.idFromName(m.id),c=e.PROVISIONER.get(r);await c.fetch(new Request("https://provisioner/queue",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:m.id,plan:m.plan})}));let x=await(await c.fetch(new Request("https://provisioner/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:m.id,plan:m.plan})}))).json();return Response.json(x)}catch(s){return console.error("[Provision Queue] Error:",s),Response.json({success:!1,error:{code:"QUEUE_ERROR",message:s instanceof Error?s.message:String(s)}},{status:500})}}u(Tr,"handleProvisionQueue");async function xr(t,e,s){try{let a=await e.DB.prepare("SELECT id, plan, status, provisioned_at FROM tenants WHERE id = ?").bind(s).first();if(!a)return Response.json({success:!1,error:{code:"TENANT_NOT_FOUND",message:"Tenant not found"}},{status:404});let n=e.PROVISIONER.idFromName(a.id),r=await(await e.PROVISIONER.get(n).fetch(new Request(`https://provisioner/status?tenantId=${a.id}&plan=${a.plan}`))).json();return!r.success||!r.state?Response.json({success:!0,data:{status:a.provisioned_at?"completed":"pending",step:null,checkpoints:{}}}):Response.json({success:!0,data:{status:r.state.status,currentStep:r.state.currentStep,checkpoints:r.state.checkpoints,error:r.state.error}})}catch(a){return console.error("[Provision Status] Error:",a),Response.json({success:!1,error:{code:"STATUS_ERROR",message:a instanceof Error?a.message:String(a)}},{status:500})}}u(xr,"handleProvisionStatus");async function Ir(t,e,s){try{let a=await e.DB.prepare(`SELECT t.*, tb.primary_color, tb.secondary_color, tb.badge_url
       FROM tenants t
       LEFT JOIN tenant_brand tb ON t.id = tb.tenant_id
       WHERE t.id = ?`).bind(s).first();if(!a)return Response.json({success:!1,error:{code:"TENANT_NOT_FOUND",message:"Tenant not found"}},{status:404});let n=new Date().toISOString().substring(0,7),m=(await e.DB.prepare(`SELECT action_count FROM usage_counters
       WHERE tenant_id = ? AND month = ?`).bind(s,n).first())?.action_count||0,r=a.plan==="starter"&&a.comped===0?1e3:null,c=await e.DB.prepare("SELECT COUNT(*) as count FROM fixtures WHERE tenant_id = ?").bind(s).first(),h=await e.DB.prepare("SELECT COUNT(*) as count FROM results WHERE tenant_id = ?").bind(s).first(),x=await e.DB.prepare("SELECT COUNT(*) as count FROM feed_posts WHERE tenant_id = ?").bind(s).first(),P=null;a.plan==="starter"&&(P=await e.DB.prepare(`SELECT webhook_url, scenario_id, validated_at, last_synced_at
         FROM make_connections WHERE tenant_id = ?`).bind(s).first());let N=null;return a.plan==="pro"&&(N=await e.DB.prepare(`SELECT apps_script_id, apps_script_deploy_status, kv_namespace, cron_schedule, last_synced_at
         FROM pro_automation WHERE tenant_id = ?`).bind(s).first()),Response.json({success:!0,data:{tenant:{id:a.id,slug:a.slug,name:a.name,email:a.email,plan:a.plan,status:a.status,comped:a.comped===1,trialEndsAt:a.trial_ends_at,createdAt:a.created_at,provisionedAt:a.provisioned_at},brand:{primaryColor:a.primary_color,secondaryColor:a.secondary_color,badgeUrl:a.badge_url},usage:{actionCount:m,limit:r,remaining:r?Math.max(0,r-m):null,percentUsed:r?Math.min(100,Math.round(m/r*100)):0},stats:{fixturesCount:c?.count||0,resultsCount:h?.count||0,postsCount:x?.count||0},automation:a.plan==="starter"?P:N}})}catch(a){return console.error("[Tenant Overview] Error:",a),Response.json({success:!1,error:{code:"OVERVIEW_ERROR",message:a instanceof Error?a.message:String(a)}},{status:500})}}u(Ir,"handleTenantOverview");async function Rr(t,e){try{let s=t.headers.get("Authorization");if(!s||!s.startsWith("Bearer "))return Response.json({success:!1,error:{code:"UNAUTHORIZED",message:"Service authorization required"}},{status:401});let a=s.substring(7);if(!await Ws(e,a))return Response.json({success:!1,error:{code:"INVALID_TOKEN",message:"Invalid service token"}},{status:401});let o=await t.json();if(!o.tenantId)return Response.json({success:!1,error:{code:"MISSING_TENANT_ID",message:"Tenant ID is required"}},{status:400});let m=await e.DB.prepare("SELECT id, plan FROM tenants WHERE id = ?").bind(o.tenantId).first();if(!m)return Response.json({success:!1,error:{code:"TENANT_NOT_FOUND",message:"Tenant not found"}},{status:404});let r=e.PROVISIONER.idFromName(m.id),c=e.PROVISIONER.get(r);await c.fetch(new Request("https://provisioner/retry",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:m.id,plan:m.plan})}));let x=await(await c.fetch(new Request("https://provisioner/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tenantId:m.id,plan:m.plan})}))).json();return Response.json(x)}catch(s){return console.error("[Provision Retry] Error:",s),Response.json({success:!1,error:{code:"RETRY_ERROR",message:s instanceof Error?s.message:String(s)}},{status:500})}}u(Rr,"handleProvisionRetry");_();w();y();var ea=class{static{u(this,"TenantRateLimiter")}state;storage;constructor(e){this.state=e,this.storage=e.storage}async fetch(e){let s=new URL(e.url);if(s.pathname!=="/check")return new Response("not found",{status:404});let a=s.searchParams.get("bucket")||"post",n=Date.now(),o=1e3,m=5,r=`rl:${a}:${Math.floor(n/o)}`,c=await this.storage.get(r)??0;return c<m?(await this.storage.put(r,c+1,{expiration:Math.floor((n+o)/1e3)}),new Response(JSON.stringify({ok:!0}),{headers:{"X-RateLimit-Limit":String(m),"X-RateLimit-Remaining":String(m-(c+1)),"X-RateLimit-Reset":"1"}})):new Response(JSON.stringify({ok:!1}),{status:429,headers:{"X-RateLimit-Limit":String(m),"X-RateLimit-Remaining":"0","X-RateLimit-Reset":"1"}})}};_();w();y();var ta=class{static{u(this,"VotingRoom")}state;env;snapshot=null;constructor(e,s){this.state=e,this.env=s}keySnap(e,s){return`tenants:${e}:motm:${s}:snapshot`}ensure(){if(!this.snapshot)throw new Error("room not initialised")}async load(e,s){let a=await this.state.storage.get("snapshot");if(a){this.snapshot=a;return}let n=await this.env.KV_IDEMP.get(this.keySnap(e,s),"json");n&&(await this.state.storage.put("snapshot",n),this.snapshot=n)}async save(){this.ensure(),this.snapshot.updatedAt=Date.now(),await this.state.storage.put("snapshot",this.snapshot)}async flushToKV(){this.ensure();let{tenant:e,matchId:s}=this.snapshot.settings;await this.env.KV_IDEMP.put(this.keySnap(e,s),JSON.stringify(this.snapshot))}async open(e){await this.load(e.tenant,e.matchId);let s={tenant:e.tenant,matchId:e.matchId,open:!0,candidates:e.candidates??[],maxVotesPerUser:e.maxVotesPerUser??1};return this.snapshot={settings:s,counts:Object.fromEntries((s.candidates||[]).map(a=>[a.id,0])),voted:{},updatedAt:Date.now()},await this.save(),await this.flushToKV(),{ok:!0}}async vote(e,s){if(this.ensure(),!this.snapshot.settings.open)throw new Error("voting closed");if(this.snapshot.voted[s])throw new Error("already voted");if(!(e in this.snapshot.counts))throw new Error("invalid candidate");let a=this.snapshot.settings.maxVotesPerUser||1;this.snapshot.counts[e]+=1,this.snapshot.voted[s]=!0,await this.save(),await this.state.storage.put("lastWrite",Date.now());let n=await this.state.storage.get("lastKVFlush")||0;return Date.now()-n>5e3&&(await this.flushToKV(),await this.state.storage.put("lastKVFlush",Date.now())),{ok:!0}}async tally(){return this.ensure(),{open:this.snapshot.settings.open,candidates:this.snapshot.settings.candidates,counts:this.snapshot.counts,updatedAt:this.snapshot.updatedAt}}async close(){return this.ensure(),this.snapshot.settings.open=!1,await this.save(),await this.flushToKV(),{ok:!0}}async fetch(e){let s=new URL(e.url);if(e.method==="POST"&&s.pathname.endsWith("/open")){let a=await e.json();return Response.json(await this.open(a))}if(e.method==="POST"&&s.pathname.endsWith("/vote")){let{candidateId:a,userHash:n}=await e.json();return Response.json(await this.vote(a,n))}return e.method==="GET"&&s.pathname.endsWith("/tally")?Response.json(await this.tally()):e.method==="POST"&&s.pathname.endsWith("/close")?Response.json(await this.close()):new Response("Not found",{status:404})}};_();w();y();var sa=class{static{u(this,"MatchRoom")}state;env;matchState=null;lastPushTs=0;constructor(e,s){this.state=e,this.env=s}keySnap(e,s){return`tenants:${e}:matches:${s}:live`}async load(e,s){let a=await this.state.storage.get("state");if(a){this.matchState=a;return}let n=await this.env.KV_IDEMP.get(this.keySnap(e,s),"json");n&&(await this.state.storage.put("state",n),this.matchState=n)}async save(){if(!this.matchState)throw new Error("match not initialized");this.matchState.updatedAt=Date.now(),await this.state.storage.put("state",this.matchState)}async flushToKV(){if(!this.matchState)return;let{tenant:e,matchId:s}=this.matchState;await this.env.KV_IDEMP.put(this.keySnap(e,s),JSON.stringify(this.matchState))}async maybePush(e,s){if(!this.matchState)return;let a=Date.now();if(e==="goal"||a-this.lastPushTs>15e3){this.lastPushTs=a;try{let n=`tenants:${this.matchState.tenant}:push:tokens`,o=await this.env.KV_IDEMP.get(n,"json")||[];o.length>0&&console.log(`[MatchRoom] Would push to ${o.length} tokens: ${s}`)}catch(n){console.error("[MatchRoom] push error:",n)}}}async open(e){return await this.load(e.tenant,e.matchId),this.matchState={tenant:e.tenant,matchId:e.matchId,title:e.title,home:e.home,away:e.away,kickoffTs:e.kickoffTs,timeline:[],homeScore:0,awayScore:0,closed:!1,updatedAt:Date.now()},await this.save(),await this.flushToKV(),{ok:!0}}async event(e){if(!this.matchState)throw new Error("match not initialized");if(this.matchState.closed)throw new Error("match closed");let s=`evt_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,a=Date.now(),n={id:s,ts:a,...e};e.type==="goal"&&e.payload?.side&&(e.payload.side==="home"?this.matchState.homeScore++:e.payload.side==="away"&&this.matchState.awayScore++),this.matchState.timeline.push(n),await this.save();let o=await this.state.storage.get("lastKVFlush")||0;a-o>5e3&&(await this.flushToKV(),await this.state.storage.put("lastKVFlush",a));let m=`Match event: ${e.type}`;return e.type==="goal"&&e.payload?.scorer&&(m=`\u26BD Goal! ${e.payload.scorer} (${e.minute}')`),await this.maybePush(e.type,m),{ok:!0,eventId:s}}async tally(){if(!this.matchState)throw new Error("match not initialized");return{ok:!0,data:{matchId:this.matchState.matchId,title:this.matchState.title,home:this.matchState.home,away:this.matchState.away,homeScore:this.matchState.homeScore,awayScore:this.matchState.awayScore,timeline:this.matchState.timeline,closed:this.matchState.closed,updatedAt:this.matchState.updatedAt}}}async close(){if(!this.matchState)throw new Error("match not initialized");return this.matchState.closed=!0,await this.save(),await this.flushToKV(),{ok:!0}}async fetch(e){let s=new URL(e.url);if(e.method==="POST"&&s.pathname.endsWith("/open")){let a=await e.json();return Response.json(await this.open(a))}if(e.method==="POST"&&s.pathname.endsWith("/event")){let a=await e.json();return Response.json(await this.event(a))}return e.method==="GET"&&s.pathname.endsWith("/tally")?Response.json(await this.tally()):e.method==="POST"&&s.pathname.endsWith("/close")?Response.json(await this.close()):new Response("Not found",{status:404})}};_();w();y();var aa=class{static{u(this,"ChatRoom")}state;env;chatState=null;typingUsers=new Map;constructor(e,s){this.state=e,this.env=s}keySnap(e,s){return`tenants:${e}:chat:${s}:last`}keyIndex(e){return`tenants:${e}:chat:index`}async load(e,s){let a=await this.state.storage.get("state");if(a){this.chatState=a;return}let n=await this.env.KV_IDEMP.get(this.keySnap(e,s),"json");n?(await this.state.storage.put("state",n),this.chatState=n):(this.chatState={tenant:e,roomId:s,messages:[],updatedAt:Date.now()},await this.state.storage.put("state",this.chatState))}async save(){if(!this.chatState)throw new Error("chat not initialized");this.chatState.updatedAt=Date.now(),await this.state.storage.put("state",this.chatState)}async flushToKV(){if(!this.chatState)return;let{tenant:e,roomId:s}=this.chatState,a={...this.chatState,messages:this.chatState.messages.slice(-200)};await this.env.KV_IDEMP.put(this.keySnap(e,s),JSON.stringify(a));let n=this.keyIndex(e),o=await this.env.KV_IDEMP.get(n,"json")||[],r=[{roomId:s,lastTs:this.chatState.updatedAt},...o.filter(c=>c.roomId!==s)];await this.env.KV_IDEMP.put(n,JSON.stringify(r.slice(0,1e3)))}async send(e){if(await this.load(e.tenant,e.roomId),!this.chatState)throw new Error("chat not initialized");let s=["badword1","badword2"],a=e.text;for(let c of s)a=a.replace(new RegExp(c,"gi"),"***");let n=`msg_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,o=Date.now(),m={id:n,ts:o,userId:e.userId,text:a,media:e.mediaIds};this.chatState.messages.push(m),this.chatState.messages.length>500&&(this.chatState.messages=this.chatState.messages.slice(-500)),await this.save();let r=await this.state.storage.get("lastKVFlush")||0;return o-r>5e3&&(await this.flushToKV(),await this.state.storage.put("lastKVFlush",o)),{ok:!0,messageId:n}}async history(e){if(await this.load(e.tenant,e.roomId),!this.chatState)throw new Error("chat not initialized");let s=e.limit||50,a=[...this.chatState.messages];if(e.cursor){let m=parseInt(e.cursor,10);a=a.filter(r=>r.ts<m)}a.sort((m,r)=>r.ts-m.ts);let n=a.slice(0,s),o=n.length>0?String(n[n.length-1].ts):null;return{ok:!0,data:{messages:n,nextCursor:o}}}async typing(e){if(await this.load(e.tenant,e.roomId),!this.chatState)throw new Error("chat not initialized");let s=Date.now();e.typing?this.typingUsers.set(e.userId,s+1e4):this.typingUsers.delete(e.userId);for(let[a,n]of this.typingUsers.entries())s>n&&this.typingUsers.delete(a);return{ok:!0,typing:Array.from(this.typingUsers.keys())}}async fetch(e){let s=new URL(e.url);if(e.method==="POST"&&s.pathname.endsWith("/send")){let a=await e.json();return Response.json(await this.send(a))}if(e.method==="GET"&&s.pathname.endsWith("/history")){let a=s.searchParams.get("tenant")||"",n=s.searchParams.get("roomId")||"",o=s.searchParams.get("cursor")||void 0,m=parseInt(s.searchParams.get("limit")||"50",10);return Response.json(await this.history({tenant:a,roomId:n,cursor:o,limit:m}))}if(e.method==="POST"&&s.pathname.endsWith("/typing")){let a=await e.json();return Response.json(await this.typing(a))}return new Response("Not found",{status:404})}};_();w();y();var na=class{static{u(this,"GeoFenceManager")}state;env;geoState=null;constructor(e,s){this.state=e,this.env=s}async load(){let e=await this.state.storage.get("geoState");e&&(this.geoState={...e,userLocations:new Map(Object.entries(e.userLocations||{}))})}async save(){if(!this.geoState)return;let e={...this.geoState,userLocations:Object.fromEntries(this.geoState.userLocations)};await this.state.storage.put("geoState",e)}async init(e){return await this.load(),this.geoState={tenant:e.tenant,matchId:e.matchId,venueLocation:e.venueLatitude&&e.venueLongitude?{latitude:e.venueLatitude,longitude:e.venueLongitude}:void 0,userLocations:new Map,lastCleanup:Date.now()},await this.save(),{ok:!0}}async updateLocation(e){if(await this.load(),!this.geoState)throw new Error("Geo-fence not initialized");let s={token:e.token,latitude:e.latitude,longitude:e.longitude,timestamp:Date.now()};return this.geoState.userLocations.set(e.token,s),await this.save(),Date.now()-this.geoState.lastCleanup>3e5&&await this.cleanupOldLocations(),{ok:!0}}async setVenue(e){if(await this.load(),!this.geoState)throw new Error("Geo-fence not initialized");return this.geoState.venueLocation={latitude:e.latitude,longitude:e.longitude},await this.save(),{ok:!0}}async getNotificationTokens(){if(await this.load(),!this.geoState||!this.geoState.venueLocation)return Array.from(this.geoState?.userLocations.keys()||[]);let e=[],s=this.geoState.venueLocation;for(let[a,n]of this.geoState.userLocations.entries()){let o=this.calculateDistance(n.latitude,n.longitude,s.latitude,s.longitude);o>500?e.push(a):console.log(`[GeoFence] User ${a} is at venue (${o.toFixed(0)}m), skipping notification`)}return e}calculateDistance(e,s,a,n){let m=e*Math.PI/180,r=a*Math.PI/180,c=(a-e)*Math.PI/180,h=(n-s)*Math.PI/180,x=Math.sin(c/2)*Math.sin(c/2)+Math.cos(m)*Math.cos(r)*Math.sin(h/2)*Math.sin(h/2);return 6371e3*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))}async cleanupOldLocations(){if(!this.geoState)return;let e=Date.now(),s=6e5;for(let[a,n]of this.geoState.userLocations.entries())e-n.timestamp>s&&(this.geoState.userLocations.delete(a),console.log(`[GeoFence] Removed stale location for token ${a}`));this.geoState.lastCleanup=e,await this.save()}async getState(){return await this.load(),this.geoState?{ok:!0,data:{tenant:this.geoState.tenant,matchId:this.geoState.matchId,venueLocation:this.geoState.venueLocation,userCount:this.geoState.userLocations.size,users:Array.from(this.geoState.userLocations.values()).map(e=>({latitude:e.latitude,longitude:e.longitude,timestamp:e.timestamp,age:Date.now()-e.timestamp}))}}:{ok:!1,error:"Not initialized"}}async fetch(e){let s=new URL(e.url);if(e.method==="POST"&&s.pathname.endsWith("/init")){let a=await e.json();return Response.json(await this.init(a))}if(e.method==="POST"&&s.pathname.endsWith("/location")){let a=await e.json();return Response.json(await this.updateLocation(a))}if(e.method==="POST"&&s.pathname.endsWith("/venue")){let a=await e.json();return Response.json(await this.setVenue(a))}if(e.method==="GET"&&s.pathname.endsWith("/tokens")){let a=await this.getNotificationTokens();return Response.json({ok:!0,tokens:a})}return e.method==="GET"&&s.pathname.endsWith("/state")?Response.json(await this.getState()):new Response("Not found",{status:404})}};_();w();y();var Ar=["seedDefaultContent","configureRouting"],vr=[...Ar,"validateWebhook","sendOwnerEmails","markReady"],Pr=[...Ar,"deployAutomations","deployAppsScript","sendOwnerEmails","markReady"],ra=class{static{u(this,"Provisioner")}storage;env;stateCache=null;constructor(e,s){this.storage=e.storage,this.env=s}async loadState(e,s){if(this.stateCache)return;let a=await this.storage.get("state");if(a){this.stateCache=a;return}let n=s==="starter"?vr:Pr,o={};for(let m of n)o[m]={step:m,status:"pending"};this.stateCache={tenantId:e,plan:s,currentStep:null,checkpoints:o,status:"idle"},await this.saveState()}async saveState(){this.stateCache&&await this.storage.put("state",this.stateCache)}get order(){return this.stateCache.plan==="starter"?vr:Pr}nextStep(){for(let e of this.order)if(this.stateCache.checkpoints[e].status!=="completed")return e;return null}async markStart(e){this.stateCache.currentStep=e;let s=this.stateCache.checkpoints[e];this.stateCache.checkpoints[e]={...s,status:"running",startedAt:Date.now()},await this.saveState()}async markDone(e){let s=this.stateCache.checkpoints[e];this.stateCache.checkpoints[e]={...s,status:"completed",completedAt:Date.now()},await this.saveState()}async markFail(e,s){let a=this.stateCache.checkpoints[e];this.stateCache.checkpoints[e]={...a,status:"failed",error:s,retryCount:(a.retryCount??0)+1},await this.saveState()}async step_seedDefaultContent(){let e=this.stateCache.tenantId;await this.env.DB.prepare(`INSERT INTO feed_posts (id, tenant_id, title, content, author, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?)`).bind(`post_${crypto.randomUUID()}`,e,"Welcome to Your Club Platform! \u{1F389}","Your platform is ready. Start by adding fixtures and news.","System",Date.now(),Date.now()).run();let s=Date.now()+7*24*3600*1e3;await this.env.DB.prepare(`INSERT INTO fixtures (id, tenant_id, home_team, away_team, venue, kick_off, status, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?)`).bind(`fixture_${crypto.randomUUID()}`,e,"Home Team","Away Team","Home Ground",s,"scheduled",Date.now()).run()}async step_configureRouting(){let e=this.stateCache.tenantId;await this.env.DB.prepare("UPDATE tenants SET route_ready = 1, updated_at = ? WHERE id = ?").bind(Date.now(),e).run()}async step_validateWebhook(){let e=this.stateCache.tenantId,s=await this.env.DB.prepare("SELECT webhook_url, webhook_secret FROM make_connections WHERE tenant_id = ?").bind(e).first();if(!s)throw new Error("Make.com connection not found");let a=Date.now().toString(),n=await this.hmac(s.webhook_secret,`HEAD:${a}`),o=await fetch(s.webhook_url,{method:"HEAD",headers:{"X-Signature":n,"X-Timestamp":a}});if(!o.ok&&o.status!==405)throw new Error(`Webhook validation status ${o.status}`);await this.env.DB.prepare("UPDATE make_connections SET validated_at = ?, updated_at = ? WHERE tenant_id = ?").bind(Date.now(),Date.now(),e).run()}async step_deployAutomations(){let e=this.stateCache.tenantId,s=`tenant_${e.replace(/^tenant_/,"")}`;await this.env.DB.prepare("UPDATE pro_automation SET kv_namespace = ?, cron_schedule = ?, updated_at = ? WHERE tenant_id = ?").bind(s,"0 */6 * * *",Date.now(),e).run()}async step_deployAppsScript(){if(this.env.APPS_SCRIPT_AUTO_DEPLOY!=="true")return;let e=this.stateCache.tenantId,s=`deploy_${crypto.randomUUID()}`;await this.env.DB.prepare(`UPDATE pro_automation
         SET apps_script_deploy_job_id = ?, apps_script_deploy_status = ?, updated_at = ?
       WHERE tenant_id = ?`).bind(s,"ready",Date.now(),e).run()}async step_sendOwnerEmails(){let e=this.stateCache.tenantId,s=await this.env.DB.prepare("SELECT id, slug, name, email FROM tenants WHERE id = ?").bind(e).first();if(!s)throw new Error("Tenant not found");let a=await this.magicToken(e,s.email),n=`${this.env.ADMIN_CONSOLE_URL}/admin/onboard?token=${a}`;await this.env.DB.prepare("UPDATE tenants SET owner_email_sent_at = ?, updated_at = ? WHERE id = ?").bind(Date.now(),Date.now(),e).run(),console.log(`[Provisioner] Magic link for ${s.email}: ${n}`)}async step_markReady(){let e=this.stateCache.tenantId;await this.env.DB.prepare("UPDATE tenants SET status = 'active', provisioned_at = ?, updated_at = ? WHERE id = ?").bind(Date.now(),Date.now(),e).run()}async runAll(){this.stateCache.status="running",this.stateCache.startedAt??=Date.now(),await this.saveState();try{let e=this.nextStep();for(;e;){await this.markStart(e);try{switch(e){case"seedDefaultContent":await this.step_seedDefaultContent();break;case"configureRouting":await this.step_configureRouting();break;case"validateWebhook":await this.step_validateWebhook();break;case"deployAutomations":await this.step_deployAutomations();break;case"deployAppsScript":await this.step_deployAppsScript();break;case"sendOwnerEmails":await this.step_sendOwnerEmails();break;case"markReady":await this.step_markReady();break}await this.markDone(e)}catch(s){throw await this.markFail(e,s?.message??String(s)),s}e=this.nextStep()}this.stateCache.status="completed",this.stateCache.completedAt=Date.now(),this.stateCache.currentStep=null,await this.saveState()}catch(e){throw this.stateCache.status="failed",this.stateCache.error=e?.message??String(e),await this.saveState(),e}}async hmac(e,s){let a=new TextEncoder,n=await crypto.subtle.importKey("raw",a.encode(e),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),o=await crypto.subtle.sign("HMAC",n,a.encode(s));return[...new Uint8Array(o)].map(m=>m.toString(16).padStart(2,"0")).join("")}async magicToken(e,s){let a=new TextEncoder,n=btoa(JSON.stringify({alg:"HS256",typ:"JWT"})).replace(/=+$/,""),o=btoa(JSON.stringify({iss:this.env.JWT_ISSUER||"syston.app",aud:this.env.JWT_AUDIENCE||"syston-admin",sub:s,tenantId:e,type:"magic_link",roles:["owner","admin"],iat:Math.floor(Date.now()/1e3),exp:Math.floor(Date.now()/1e3)+24*3600})).replace(/=+$/,""),m=`${n}.${o}`,r=await crypto.subtle.importKey("raw",a.encode(this.env.JWT_SECRET),{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",r,a.encode(m)),h=btoa(String.fromCharCode(...new Uint8Array(c))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");return`${m}.${h}`}async fetch(e){let s=new URL(e.url);if(e.method==="POST"&&s.pathname==="/queue"){let{tenantId:a,plan:n}=await e.json();return await this.loadState(a,n),Response.json({success:!0,state:this.stateCache})}if(e.method==="POST"&&s.pathname==="/run"){let{tenantId:a,plan:n}=await e.json();return await this.loadState(a,n),(async()=>await this.runAll())(),Response.json({success:!0,state:this.stateCache})}if(e.method==="GET"&&s.pathname==="/status")return this.stateCache?Response.json({success:!0,state:this.stateCache}):Response.json({success:!0,state:null});if(e.method==="POST"&&s.pathname==="/retry"){let{tenantId:a,plan:n}=await e.json();await this.loadState(a,n);for(let o of this.order)this.stateCache.checkpoints[o].status==="failed"&&(this.stateCache.checkpoints[o].status="pending",this.stateCache.checkpoints[o].error=void 0);return this.stateCache.status="idle",await this.saveState(),Response.json({success:!0,state:this.stateCache})}return new Response("Not found",{status:404})}};var nd=new Set(["https://localhost:5173","http://localhost:5173","https://localhost:3000","http://localhost:3000","capacitor://localhost"]),rd=E.object({clubName:E.string().min(1,"clubName required"),clubShortName:E.string().min(1,"clubShortName required"),contactEmail:E.string().email("valid email required"),contactName:E.string().min(1,"contactName required"),locale:E.string().optional(),timezone:E.string().optional(),plan:E.enum(["free","managed","enterprise"]).optional(),makeWebhookUrl:E.string().url().optional(),promoCode:E.string().optional()}),od=E.object({event_type:E.string().min(1,"event_type required"),data:E.record(E.unknown()),channels:E.array(E.enum(["yt","fb","ig","tiktok","x"])).optional(),template:E.string().optional()});function id(t){let e=t.split("/").filter(Boolean);return e.length?e.slice(0,3).join(":"):"root"}u(id,"buildRateLimitScope");function cd(t,e,s,a){let n=dr(t),o=typeof e?.CORS_ALLOWED=="string"?String(e.CORS_ALLOWED).split(",").map(c=>c.trim()).filter(Boolean):[],m=new Set([...nd,...o]);t&&m.has(t)&&n.set("Access-Control-Allow-Origin",t);let r=new Set((n.get("Access-Control-Allow-Headers")||"").split(",").map(c=>c.trim()).filter(Boolean));for(let c of["authorization","content-type","Idempotency-Key","idempotency-key","x-amz-content-sha256","x-amz-date","x-amz-acl","x-amz-meta-*"])c&&r.add(c);return n.set("Access-Control-Allow-Headers",Array.from(r).join(",")),n.set("Access-Control-Expose-Headers","X-Request-Id, X-Release"),n.set("X-Request-Id",s),n.set("X-Release",a),n}u(cd,"buildCorsHeaders");function jt(t,e){let s=new Headers(t);return e&&new Headers(e).forEach((n,o)=>s.set(o,n)),s}u(jt,"mergeHeaders");function Tt(t,e){let s=jt(e,t.headers);return new Response(t.body,be({status:t.status,headers:s}))}u(Tt,"respondWithCors");var wS={async fetch(t,e,s){let a=Date.now(),n=pr(),o=t.headers.get("Origin"),r=cd(o,e,n,typeof APP_VERSION=="string"?APP_VERSION:"unknown"),c=null;if(lr(t))return new Response(null,be({status:204,headers:jt(r)}));try{if(c=new URL(t.url),t.method==="GET"&&c.pathname==="/healthz"){let i=await fr();return Tt(i,r)}if(t.method==="GET"&&c.pathname==="/readyz"){let i=await hr(e);return Tt(i,r)}if(c.pathname==="/__meta/ping")return new Response(JSON.stringify({ok:!0,method:t.method,pathname:c.pathname,search:c.search,fullUrl:c.href,apiVersion:e.API_VERSION||"v1"}),{status:200,headers:{"content-type":"application/json",...r}});if(c.pathname==="/internal/dev/admin-token"&&t.method==="POST"){if((e.ENVIRONMENT||"development")==="production")return l({success:!1,error:{code:"FORBIDDEN",message:"This endpoint is disabled in production"}},403,r);try{let d=await t.json().catch(()=>({})),f=E.object({email:E.string().email()}).parse(d),g=new TextEncoder().encode(e.JWT_SECRET||"");if(!e.JWT_SECRET)throw new Error("JWT_SECRET not configured");let b=Math.floor(Date.now()/1e3),S=b+7*24*60*60,v=await new ue({sub:f.email,roles:["admin"]}).setProtectedHeader({alg:"HS256"}).setIssuer(e.JWT_ISSUER||"syston.app").setAudience(e.JWT_AUDIENCE||"syston-mobile").setIssuedAt(b).setExpirationTime(S).sign(g);return l({success:!0,token:v,expiresAt:new Date(S*1e3).toISOString()},200,r)}catch(d){return d.errors?l({success:!1,error:{code:"VALIDATION",details:d.errors}},400,r):l({success:!1,error:{code:"TOKEN_MINT_FAILED",message:String(d?.message||d)}},500,r)}}let h=e.API_VERSION||"v1",x=t.method.toUpperCase();if(x!=="GET"&&x!=="HEAD"){let i=id(c.pathname),d=await mr(t,e,{scope:i,requestId:n,path:c.pathname});if(!d.ok){let p=new Headers(r);return typeof d.retryAfter=="number"&&p.set("Retry-After",String(d.retryAfter)),typeof d.limit=="number"&&p.set("X-RateLimit-Limit",String(d.limit)),p.set("X-RateLimit-Remaining","0"),l({success:!1,error:{code:"RATE_LIMITED",message:"Too many requests"}},429,p)}typeof d.limit=="number"&&r.set("X-RateLimit-Limit",String(d.limit)),typeof d.remaining=="number"&&r.set("X-RateLimit-Remaining",String(Math.max(d.remaining,0)))}if(c.pathname===`/api/${h}/signup`&&t.method==="POST")try{let i=await t.json().catch(()=>({})),d=tt(rd,i),p=await ur(e,d);return p.success?l({success:!0,data:p.tenant},200,r):l({success:!1,error:p.error},400,r)}catch(i){return et(i)?l({success:!1,error:{code:"INVALID_REQUEST",message:"Validation failed",issues:i.issues}},i.status,r):l({success:!1,error:{code:"SIGNUP_FAILED",message:i.message}},500,r)}if(c.pathname==="/public/signup/start"&&t.method==="POST")return await yr(t,e,n,r);if(c.pathname==="/public/signup/brand"&&t.method==="POST")return await wr(t,e,n,r);if(c.pathname==="/public/signup/starter/make"&&t.method==="POST")return await _r(t,e,n,r);if(c.pathname==="/public/signup/pro/confirm"&&t.method==="POST")return await Er(t,e,n,r);if(c.pathname==="/auth/magic/start"&&t.method==="POST")return await br(t,e);if(c.pathname==="/auth/magic/verify"&&t.method==="GET")return await Sr(t,e);if(c.pathname==="/internal/provision/queue"&&t.method==="POST")return await Tr(t,e);if(c.pathname==="/internal/provision/retry"&&t.method==="POST")return await Rr(t,e);let P=c.pathname.match(/^\/api\/v1\/tenants\/([^/]+)\/provision-status$/);if(P&&t.method==="GET"){let i=P[1];return await xr(t,e,i)}let N=c.pathname.match(/^\/api\/v1\/tenants\/([^/]+)\/overview$/);if(N&&t.method==="GET"){let i=N[1];return await Ir(t,e,i)}if(c.pathname===`/api/${h}/usage`&&t.method==="GET"){let i=(t.headers.get("x-tenant")||c.searchParams.get("tenant")||"default").toString(),d=new Date,p=`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`,f=`usage:${i}:${p}`,g=await e.KV_IDEMP.get(f,"json")||{count:0,month:p};return l({success:!0,data:{tenant:i,month:p,count:Number(g.count||0)}},200,r)}if(c.pathname===`/api/${h}/usage/increment`&&t.method==="POST"){let i=(t.headers.get("x-tenant")||"default").toString(),d=new Date,p=`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}`,f=`usage:${i}:${p}`,g=`tenant:${i}:plan`,b=await e.KV_IDEMP.get(f,"json")||{count:0,month:p},S=Number(b.count||0)+1,v=await ie(e,i),j=!!v?.flags?.managed?.yt,J=!!v?.flags?.comped;return!j&&!J&&S>1e3?l({success:!1,error:{code:"USAGE_CAP",message:"Monthly cap reached (1,000)."},data:{tenant:i,month:p,count:S-1}},402,r):(await e.KV_IDEMP.put(f,JSON.stringify({count:S,month:p})),l({success:!0,data:{tenant:i,month:p,count:S}},200,r))}if(c.pathname===`/api/${h}/post`&&t.method==="POST")try{let i=await O(t,e),d=i.tenant_id||i.tenantId;if(!d)return l({success:!1,error:"tenant_id required in JWT"},400,r);let p=await t.json().catch(()=>({})),{event_type:f,data:g,channels:b,template:S}=tt(od,p),v=Vs(t),j=await Bs(e,d,p,v||void 0);if(j.hit)return l(j.response,200,r);let J={tenant:d,template:S||f,channels:b||["yt","fb","ig"],data:{...g,event_type:f,timestamp:new Date().toISOString()},createdAt:Date.now(),idemKey:j.key};await e.POST_QUEUE.send(J);let H={success:!0,queued:!0,tenant:d,event_type:f,job_id:j.key};return await j.store(H),l(H,200,r)}catch(i){return i instanceof Response?Tt(i,r):et(i)?l({success:!1,error:{code:"INVALID_REQUEST",message:"Validation failed",issues:i.issues}},i.status,r):(L({level:"error",msg:`POST_EVENT_ERROR:${i?.message||"unknown"}`,requestId:n,path:c.pathname,status:500}),l({success:!1,error:{code:"POST_FAILED",message:i.message}},500,r))}if(c.pathname.includes("/admin/")&&t.headers.get("x-admin-console")==="true"&&L({level:"info",msg:"ADMIN_CONSOLE_CALL",requestId:n,path:c.pathname}),c.pathname===`/api/${h}/admin/whoami`&&t.method==="GET")try{let i=await O(t,e);return l({ok:!0,claims:i},200,r)}catch(i){return i instanceof Response?Tt(i,r):(L({level:"error",msg:`WHOAMI_FAIL:${i?.message||"unknown"}`,requestId:n,path:c.pathname,status:401}),l({ok:!1,error:String(i?.message||i)},401,r))}if(c.pathname===`/api/${h}/admin/stats`&&t.method==="GET")return await getAdminStats(t,e,n,r);if(c.pathname===`/api/${h}/admin/tenant/create`&&t.method==="POST"){await qe(t,e);let i=await t.json().catch(()=>({})),p=E.object({id:E.string().min(1,"id required"),name:E.string().optional(),locale:E.string().optional(),tz:E.string().optional()}).safeParse(i);if(!p.success)return l({success:!1,error:{code:"VALIDATION",details:p.error.issues}},400,r);let{id:f,name:g,locale:b,tz:S}=p.data,v={id:f,name:g,locale:b,tz:S,flags:{use_make:!1,direct_yt:!0},makeWebhookUrl:null};return await oe(e,v),l({success:!0,data:{created:!0,tenant:v}},200,r)}if(c.pathname===`/api/${h}/admin/tenant/webhook`&&t.method==="POST")try{await qe(t,e);let i=await t.json().catch(()=>({})),p=E.object({tenant:E.string().min(1),make_webhook_url:E.string().url()}).safeParse(i);if(!p.success)return l({success:!1,error:{code:"VALIDATION",details:p.error.issues}},400,r);let{tenant:f,make_webhook_url:g}=p.data,b;try{b=new URL(g)}catch{return l({success:!1,error:{code:"VALIDATION",message:"Invalid URL format"}},400,r)}let S=(e.ALLOWED_WEBHOOK_HOSTS||"")+",.make.com";if(!Mt(b.host,S))return l({success:!1,error:{code:"VALIDATION",message:`Host ${b.host} not allowed`}},400,r);let v=await Hs(e,f,g);return l({success:!0,data:{tenant:v.id,makeWebhookUrl:v.makeWebhookUrl}},200,r)}catch(i){return i instanceof Response?Tt(i,r):(L({level:"error",msg:`ADMIN_WEBHOOK_SAVE_ERROR:${i?.message||"unknown"}`,requestId:n,path:c.pathname,status:500}),l({success:!1,error:{code:"INTERNAL",message:"Webhook save failed"}},500,r))}if(c.pathname===`/api/${h}/admin/fixtures/refresh`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=e.FIXTURES_REFRESH_URL||"";if(!d)return l({success:!0,data:{pinged:!1,note:"No FIXTURES_REFRESH_URL set"}},200,r);let p=await fetch(d,{method:"POST"}).catch(()=>null),f=!!p&&p.ok;return l({success:f,data:{pinged:f}},f?200:502,r)}if(c.pathname===`/api/${h}/fixtures/sync`&&t.method==="POST")try{let i=await t.json().catch(()=>({})),{fixtures:d}=i;if(!Array.isArray(d))return l({success:!1,error:{code:"INVALID_DATA",message:"fixtures must be an array"}},400,r);let p=0;for(let f of d)try{await e.DB.prepare(`
              INSERT INTO fixtures (
                fixture_date, opponent, venue, competition, kick_off_time, status, source, updated_at
              )
              VALUES (?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
              ON CONFLICT(fixture_date, opponent)
              DO UPDATE SET
                venue = excluded.venue,
                competition = excluded.competition,
                kick_off_time = excluded.kick_off_time,
                status = excluded.status,
                source = excluded.source,
                updated_at = CURRENT_TIMESTAMP
            `).bind(f.date,f.opponent,f.venue||"",f.competition||"",f.time||"",f.status||"scheduled",f.source||"unknown").run(),p++}catch(g){L("error",n,{message:"Fixture sync error",error:String(g)})}return l({success:!0,synced:p},200,r)}catch(i){return L("error",n,{message:"Fixtures sync failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Sync failed"}},500,r)}if(c.pathname===`/api/${h}/fixtures/upcoming`&&t.method==="GET")try{let i=await e.DB.prepare(`
          SELECT
            id, fixture_date as date, opponent, venue, competition,
            kick_off_time as kickOffTime, status, source
          FROM fixtures
          WHERE fixture_date >= DATE('now')
            AND status != 'postponed'
          ORDER BY fixture_date ASC
          LIMIT 10
        `).all();return l({success:!0,data:i.results||[]},200,r)}catch(i){return L("error",n,{message:"Get fixtures failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/all`&&t.method==="GET")try{let i=parseInt(c.searchParams.get("limit")||"50"),d=c.searchParams.get("status"),p=`
          SELECT
            id, fixture_date as date, opponent, venue, competition,
            kick_off_time as kickOffTime, status, source
          FROM fixtures
        `,f=[];d&&(p+=" WHERE status = ?",f.push(d)),p+=" ORDER BY fixture_date DESC LIMIT ?",f.push(i.toString());let g=await e.DB.prepare(p).bind(...f).all();return l({success:!0,data:g.results||[]},200,r)}catch(i){return L("error",n,{message:"Get all fixtures failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/results`&&t.method==="GET")try{let i=parseInt(c.searchParams.get("limit")||"10"),d=await e.DB.prepare(`
          SELECT
            id, match_date as date, opponent, home_score as homeScore,
            away_score as awayScore, venue, competition, scorers
          FROM results
          ORDER BY match_date DESC
          LIMIT ?
        `).bind(i).all();return l({success:!0,data:d.results||[]},200,r)}catch(i){return L("error",n,{message:"Get results failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/results`&&t.method==="POST")try{let i=await t.json().catch(()=>({}));return await e.DB.prepare(`
          INSERT INTO results (
            match_date, opponent, home_score, away_score, venue, competition, scorers
          )
          VALUES (?, ?, ?, ?, ?, ?, ?)
          ON CONFLICT(match_date, opponent)
          DO UPDATE SET
            home_score = excluded.home_score,
            away_score = excluded.away_score,
            venue = excluded.venue,
            competition = excluded.competition,
            scorers = excluded.scorers
        `).bind(i.date,i.opponent,i.homeScore||0,i.awayScore||0,i.venue||"",i.competition||"",i.scorers||"").run(),l({success:!0},200,r)}catch(i){return L("error",n,{message:"Add result failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/settings`&&t.method==="GET")try{let i=c.searchParams.get("tenant_id")||"default",d=await e.DB.prepare(`
          SELECT
            tenant_id as tenantId,
            team_name as teamName,
            fa_website_url as faWebsiteUrl,
            fa_snippet_url as faSnippetUrl,
            sync_enabled as syncEnabled,
            sync_interval_minutes as syncIntervalMinutes,
            calendar_id as calendarId
          FROM fixture_settings
          WHERE tenant_id = ?
        `).bind(i).first();return d?l({success:!0,data:d},200,r):l({success:!1,error:{code:"NOT_FOUND",message:"Settings not found"}},404,r)}catch(i){return L("error",n,{message:"Get settings failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/settings/config`&&t.method==="GET")try{let i=c.searchParams.get("tenant_id")||"default",d=await e.DB.prepare(`
          SELECT
            tenant_id as tenantId,
            team_name as teamName,
            fa_website_url as faWebsiteUrl,
            fa_snippet_url as faSnippetUrl,
            sync_enabled as syncEnabled,
            calendar_id as calendarId
          FROM fixture_settings
          WHERE tenant_id = ?
        `).bind(i).first();return d?l({success:!0,data:d},200,r):l({success:!0,data:{tenantId:"default",teamName:"Shepshed Dynamo Youth U16",faWebsiteUrl:"",faSnippetUrl:"",syncEnabled:!0,calendarId:""}},200,r)}catch(i){return L("error",n,{message:"Get config failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/fixtures/settings`&&t.method==="PUT"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);try{let d=await t.json().catch(()=>({})),p=d.tenantId||"default";return await e.DB.prepare(`
          INSERT INTO fixture_settings (
            tenant_id,
            team_name,
            fa_website_url,
            fa_snippet_url,
            sync_enabled,
            sync_interval_minutes,
            calendar_id,
            calendar_enabled,
            gmail_search_query,
            gmail_label,
            email_sync_enabled,
            updated_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
          ON CONFLICT(tenant_id)
          DO UPDATE SET
            team_name = excluded.team_name,
            fa_website_url = excluded.fa_website_url,
            fa_snippet_url = excluded.fa_snippet_url,
            sync_enabled = excluded.sync_enabled,
            sync_interval_minutes = excluded.sync_interval_minutes,
            calendar_id = excluded.calendar_id,
            calendar_enabled = excluded.calendar_enabled,
            gmail_search_query = excluded.gmail_search_query,
            gmail_label = excluded.gmail_label,
            email_sync_enabled = excluded.email_sync_enabled,
            updated_at = CURRENT_TIMESTAMP
        `).bind(p,d.teamName||"",d.faWebsiteUrl||"",d.faSnippetUrl||"",d.syncEnabled?1:0,d.syncIntervalMinutes||5,d.calendarId||"",d.calendarEnabled?1:0,d.gmailSearchQuery||"",d.gmailLabel||"",d.emailSyncEnabled?1:0).run(),l({success:!0},200,r)}catch(d){return L("error",n,{message:"Update settings failed",error:String(d)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}}if(c.pathname===`/api/${h}/fixtures/next`&&t.method==="GET")try{let i=await e.DB.prepare(`
          SELECT
            id,
            fixture_date || 'T' || COALESCE(kick_off_time, '00:00:00') || 'Z' as kickoffIso,
            COALESCE(home_team, 'Home Team') as homeTeam,
            COALESCE(away_team, opponent) as awayTeam,
            opponent,
            CASE
              WHEN home_team IS NOT NULL THEN 'H'
              ELSE 'A'
            END as homeAway,
            venue,
            competition,
            COALESCE(match_status, status) as status,
            home_score,
            away_score,
            current_minute as minute,
            youtube_live_id as youtubeLiveId,
            youtube_status as youtubeStatus,
            youtube_scheduled_start as youtubeScheduledStart
          FROM fixtures
          WHERE fixture_date >= DATE('now')
            AND status != 'postponed'
          ORDER BY fixture_date ASC, kick_off_time ASC
          LIMIT 1
        `).first();if(i){let d={id:i.id,kickoffIso:i.kickoffIso,homeTeam:i.homeTeam,awayTeam:i.awayTeam,opponent:i.opponent,homeAway:i.homeAway,venue:i.venue||null,competition:i.competition||null,status:i.status||"scheduled",score:i.home_score!==null&&i.away_score!==null?{home:i.home_score,away:i.away_score}:null,minute:i.minute||0,youtubeLiveId:i.youtubeLiveId||null,youtubeStatus:i.youtubeStatus||null,youtubeScheduledStart:i.youtubeScheduledStart||null};return l({success:!0,data:d},200,r)}else return l({success:!0,data:null},200,r)}catch(i){return L("error",n,{message:"Get next fixture failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Failed to fetch next fixture"}},500,r)}if(c.pathname===`/api/${h}/live-updates`&&t.method==="GET")try{let i=c.searchParams.get("matchId");if(!i)return l({success:!1,error:{code:"INVALID_REQUEST",message:"matchId parameter required"}},400,r);let d=await e.DB.prepare(`
          SELECT
            id,
            match_id as matchId,
            minute,
            type,
            text,
            scorer,
            assist,
            card,
            player,
            score_so_far as scoreSoFar,
            created_at as createdAt
          FROM live_updates
          WHERE match_id = ?
          ORDER BY created_at ASC
        `).bind(i).all();return l({success:!0,data:d.results||[]},200,r)}catch(i){return L("error",n,{message:"Get live updates failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Failed to fetch live updates"}},500,r)}if(c.pathname===`/api/${h}/live-updates`&&t.method==="POST")try{let i=await t.json().catch(()=>({}));if(!i.matchId||typeof i.minute!="number"||!i.type||!i.text)return l({success:!1,error:{code:"INVALID_REQUEST",message:"matchId, minute, type, and text are required"}},400,r);if(!["goal","card","subs","info"].includes(i.type))return l({success:!1,error:{code:"INVALID_REQUEST",message:"type must be one of: goal, card, subs, info"}},400,r);if(i.card&&!["yellow","red","sinbin"].includes(i.card))return l({success:!1,error:{code:"INVALID_REQUEST",message:"card must be one of: yellow, red, sinbin"}},400,r);let p=`update-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,f=new Date().toISOString();await e.DB.prepare(`
          INSERT INTO live_updates (
            id, match_id, minute, type, text, scorer, assist, card, player, score_so_far, created_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        `).bind(p,i.matchId,i.minute,i.type,i.text,i.scorer||null,i.assist||null,i.card||null,i.player||null,i.scoreSoFar||null,f).run();let g={id:p,matchId:i.matchId,minute:i.minute,type:i.type,text:i.text,scorer:i.scorer||null,assist:i.assist||null,card:i.card||null,player:i.player||null,scoreSoFar:i.scoreSoFar||null,createdAt:f};return L("info",n,{message:"Live update posted",updateId:p,matchId:i.matchId,type:i.type}),l({success:!0,data:g},201,r)}catch(i){return L("error",n,{message:"Post live update failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Failed to post live update"}},500,r)}if(c.pathname.match(new RegExp(`^/api/${h}/matches/([^/]+)/state$`))&&t.method==="POST")try{let i=c.pathname.split("/").slice(-2,-1)[0],d=await t.json().catch(()=>({})),p=["scheduled","live","halftime","ft"];if(!d.status||!p.includes(d.status))return l({success:!1,error:{code:"INVALID_REQUEST",message:"status must be one of: scheduled, live, halftime, ft"}},400,r);let f="UPDATE fixtures SET match_status = ?, updated_at = CURRENT_TIMESTAMP",g=[d.status];return typeof d.minute=="number"&&(f+=", current_minute = ?",g.push(d.minute)),d.score&&typeof d.score.home=="number"&&typeof d.score.away=="number"&&(f+=", home_score = ?, away_score = ?",g.push(d.score.home,d.score.away)),f+=" WHERE id = ?",g.push(i),await e.DB.prepare(f).bind(...g).run(),L("info",n,{message:"Match state updated",matchId:i,status:d.status}),l({success:!0,data:{ok:!0}},200,r)}catch(i){return L("error",n,{message:"Set match state failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Failed to set match state"}},500,r)}if(c.pathname===`/api/${h}/live-updates/cleanup`&&t.method==="POST")try{let d=(await t.json().catch(()=>({}))).matchId,p=0;return d?(p=(await e.DB.prepare("DELETE FROM live_updates WHERE match_id = ?").bind(d).run()).meta?.changes||0,L("info",n,{message:"Cleaned up match updates",matchId:d,removed:p})):(p=(await e.DB.prepare(`
            DELETE FROM live_updates
            WHERE match_id IN (
              SELECT id FROM fixtures
              WHERE match_status = 'ft'
                AND updated_at < datetime('now', '-90 minutes')
            )
          `).run()).meta?.changes||0,L("info",n,{message:"Cleaned up stale updates",removed:p})),l({success:!0,data:{removed:p}},200,r)}catch(i){return L("error",n,{message:"Cleanup failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL",message:"Failed to cleanup live updates"}},500,r)}if(c.pathname===`/api/${h}/league/sync`&&t.method==="POST")try{let i=await t.json().catch(()=>({})),{tenantId:d,competition:p,standings:f}=i;if(!Array.isArray(f))return l({success:!1,error:{code:"INVALID_DATA",message:"standings must be an array"}},400,r);await e.DB.prepare("DELETE FROM league_standings WHERE tenant_id = ? AND competition = ?").bind(d||"default",p||"").run();let g=0;for(let b of f)try{await e.DB.prepare(`
              INSERT INTO league_standings (
                tenant_id, competition, team_name, position,
                played, won, drawn, lost, goals_for, goals_against, goal_difference, points,
                last_updated
              )
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
            `).bind(d||"default",p||"",b.teamName,b.position,b.played,b.won,b.drawn,b.lost,b.goalsFor,b.goalsAgainst,b.goalDifference,b.points).run(),g++}catch(S){L("error",n,{message:"Error syncing team",error:String(S)})}return l({success:!0,synced:g},200,r)}catch(i){return L("error",n,{message:"League sync failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/league/table`&&t.method==="GET")try{let i=c.searchParams.get("tenant_id")||"default",d=c.searchParams.get("competition"),p=`
          SELECT
            position, team_name as teamName, played, won, drawn, lost,
            goals_for as goalsFor, goals_against as goalsAgainst,
            goal_difference as goalDifference, points
          FROM league_standings
          WHERE tenant_id = ?
        `,f=[i];d&&(p+=" AND competition = ?",f.push(d)),p+=" ORDER BY position ASC";let g=await e.DB.prepare(p).bind(...f).all();return l({success:!0,data:g.results||[]},200,r)}catch(i){return L("error",n,{message:"Get league table failed",error:String(i)}),l({success:!1,error:{code:"INTERNAL"}},500,r)}if(c.pathname===`/api/${h}/admin/promo/create`&&t.method==="POST"){await qe(t,e);try{let i=await t.json().catch(()=>({})),p=E.object({code:E.string().min(1),type:E.enum(["percentage_discount","months_free","plan_upgrade","referral_reward"]),value:E.union([E.string(),E.number()]),durationMonths:E.number().optional(),maxUses:E.number().optional(),expiresAt:E.string().optional(),active:E.boolean().default(!0),metadata:E.object({description:E.string().optional(),targetTenant:E.string().optional()}).optional()}).parse(i),{PromoCodeService:f}=await Promise.resolve().then(()=>(Ut(),Lt)),b=await new f(e).createPromoCode({...p,createdBy:"admin"});return b.success?l({success:!0,data:b.code},200,r):l({success:!1,error:{code:"PROMO_CREATE_FAILED",message:b.error}},400,r)}catch(i){return i.errors?l({success:!1,error:{code:"VALIDATION_ERROR",message:i.errors[0].message}},400,r):l({success:!1,error:{code:"PROMO_CREATE_FAILED",message:i.message}},500,r)}}if(c.pathname===`/api/${h}/admin/promo/list`&&t.method==="GET"){await qe(t,e);try{let{PromoCodeService:i}=await Promise.resolve().then(()=>(Ut(),Lt)),p=await new i(e).listPromoCodes();return l({success:!0,data:p},200,r)}catch(i){return l({success:!1,error:{code:"PROMO_LIST_FAILED",message:i.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/promo/[^/]+/deactivate$`))&&t.method==="POST"){await qe(t,e);try{let i=c.pathname.split("/")[5],{PromoCodeService:d}=await Promise.resolve().then(()=>(Ut(),Lt)),f=await new d(e).deactivatePromoCode(i);return f.success?l({success:!0},200,r):l({success:!1,error:{code:"PROMO_DEACTIVATE_FAILED",message:f.error}},400,r)}catch(i){return l({success:!1,error:{code:"PROMO_DEACTIVATE_FAILED",message:i.message}},500,r)}}if(c.pathname===`/api/${h}/admin/tenant/invite`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),f=E.object({tenant:E.string().min(1),ttl_minutes:E.number().min(5).max(1440).default(60)}).safeParse(d);if(!f.success)return l({success:!1,error:{code:"VALIDATION",details:f.error.issues}},400,r);let{tenant:g,ttl_minutes:b}=f.data,S=await ie(e,g),v=await Qe(e,{tenant_id:S.id,ttlMinutes:b}),J=`${e.SETUP_URL||"https://setup.yourbrand.app"}/?token=${encodeURIComponent(v)}`;return l({success:!0,data:{setup_url:J}},200,r)}if(c.pathname===`/api/${h}/admin/tenant/flags`&&t.method==="POST"){await qe(t,e);let i=await t.json().catch(()=>null);if(!i?.tenant||typeof i.flags!="object")return l({success:!1,error:{code:"VALIDATION",message:"tenant + flags required"}},400,r);let d=await Js(e,i.tenant,i.flags);return l({success:!0,data:{updated:!0,flags:d.flags}},200,r)}if(c.pathname===`/api/${h}/admin/tenant/youtube-token`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>null);return!d?.tenant||!d?.client_id||!d?.client_secret||!d?.refresh_token?l({success:!1,error:{code:"VALIDATION",message:"tenant, client_id, client_secret, refresh_token"}},400,r):(await e.KV_IDEMP.put(`yt:${d.tenant}`,JSON.stringify({client_id:d.client_id,client_secret:d.client_secret,refresh_token:d.refresh_token,channel_id:d.channel_id||null})),l({success:!0,data:{stored:!0}},200,r))}if(c.pathname===`/api/${h}/admin/yt/start`&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant");if(!d)return l({success:!1,error:{code:"VALIDATION",message:"tenant required"}},400,r);let p=e.YT_CLIENT_ID,f=e.YT_REDIRECT_URL;if(!p||!f)return l({success:!1,error:{code:"CONFIG",message:"YT_CLIENT_ID or YT_REDIRECT_URL not configured"}},500,r);let g=encodeURIComponent("https://www.googleapis.com/auth/youtube https://www.googleapis.com/auth/youtube.readonly"),b=`https://accounts.google.com/o/oauth2/v2/auth?response_type=code&client_id=${encodeURIComponent(p)}&redirect_uri=${encodeURIComponent(f)}&scope=${g}&access_type=offline&prompt=consent&state=${encodeURIComponent(d)}`;return l({success:!0,data:{url:b}},200,r)}if(c.pathname===`/api/${h}/admin/yt/callback`&&t.method==="GET"){let i=c.searchParams.get("code"),d=c.searchParams.get("state")||"";if(!i||!d)return new Response("Missing code/state",{status:400});let p=e.YT_CLIENT_ID,f=e.YT_CLIENT_SECRET,g=e.YT_REDIRECT_URL,b=new URLSearchParams({code:i,client_id:p,client_secret:f,redirect_uri:g,grant_type:"authorization_code"}),S=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:b});if(!S.ok)return new Response("Token exchange failed",{status:502});let v=await S.json(),j=await ie(e,d);return j.youtube={...v},await oe(e,j),new Response("YouTube connected. You can close this window.",{status:200})}if(c.pathname===`/api/${h}/admin/tenant/channel/flags`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),f=E.object({tenant:E.string().min(1),managed:E.record(E.boolean()).optional()}).safeParse(d);if(!f.success)return l({success:!1,error:{code:"VALIDATION",details:f.error.issues}},400,r);let{tenant:g,managed:b}=f.data,S=await Pn(e,g,{managed:b});return l({success:!0,data:{tenant:S.id,flags:S.flags}},200,r)}if(c.pathname===`/api/${h}/admin/tenant/channel/webhook`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),f=E.object({tenant:E.string().min(1),channel:E.enum(["yt","fb","ig","tiktok","x"]),url:E.string().url()}).safeParse(d);if(!f.success)return l({success:!1,error:{code:"VALIDATION",details:f.error.issues}},400,r);let{tenant:g,channel:b,url:S}=f.data,v=await An(e,g,b,S);return l({success:!0,data:{tenant:v.id,channel:b,webhook:S}},200,r)}if(c.pathname===`/api/${h}/admin/tenant/yt/byo-google`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),f=E.object({tenant:E.string().min(1),client_id:E.string().min(1),client_secret:E.string().min(1)}).safeParse(d);if(!f.success)return l({success:!1,error:{code:"VALIDATION",details:f.error.issues}},400,r);let{tenant:g,client_id:b,client_secret:S}=f.data,v=await On(e,g,b,S);return l({success:!0,data:{tenant:v.id,byo_google:!0}},200,r)}if(c.pathname===`/api/${h}/tenant/self`&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"tenant_admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=i.tenantId,p=await ie(e,d),f=null;return p.makeWebhookUrl&&(f=`***${p.makeWebhookUrl.slice(-6)}`),l({success:!0,data:{id:p.id,flags:p.flags,makeWebhookMasked:f}},200,r)}if(c.pathname===`/api/${h}/tenant/self/webhook`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"tenant_admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=i.tenantId,p=await t.json().catch(()=>({})),g=E.object({make_webhook_url:E.string().url()}).safeParse(p);if(!g.success)return l({success:!1,error:{code:"VALIDATION",details:g.error.issues}},400,r);let b=new URL(g.data.make_webhook_url),S=(e.ALLOWED_WEBHOOK_HOSTS||"")+",.make.com";return Mt(b.host,S)?(await Hs(e,d,b.toString()),l({success:!0,data:{saved:!0}},200,r)):l({success:!1,error:{code:"VALIDATION",message:`Host ${b.host} not allowed`}},400,r)}if(c.pathname===`/api/${h}/tenant/self/flags`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"tenant_admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=i.tenantId,p=await t.json().catch(()=>({})),g=E.object({use_make:E.boolean().optional(),direct_yt:E.boolean().optional()}).safeParse(p);if(!g.success)return l({success:!1,error:{code:"VALIDATION",details:g.error.issues}},400,r);let b=await Js(e,d,g.data);return l({success:!0,data:{flags:b.flags}},200,r)}if(c.pathname===`/api/${h}/tenant/self/test-webhook`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"tenant_admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=i.tenantId,p=await ie(e,d);if(!p.flags.use_make||!p.makeWebhookUrl)return l({success:!1,error:{code:"INVALID_STATE",message:"Enable BYO-Make and set webhook first"}},400,r);try{let f=await fetch(p.makeWebhookUrl,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({kind:"test",tenant:d,ts:Date.now()})});return l({success:f.ok,data:{status:f.status}},200,r)}catch(f){return l({success:!1,error:{code:"UPSTREAM",message:f?.message||"webhook failed"}},502,r)}}if(c.pathname===`/api/${h}/stripe/webhook`&&t.method==="POST"){if(!e.STRIPE_SECRET_KEY&&!e.STRIPE_WEBHOOK_SECRET)return l({success:!1,error:{code:"STRIPE_DISABLED",message:"Stripe not configured"}},503,r);let i=await t.json().catch(()=>null);if(!i)return new Response("bad json",{status:400});try{let d=i.type,p=i.data?.object?.metadata?.tenant||i.data?.object?.metadata?.tenant_id;if(!p)return new Response("ok",{status:200});if(d==="customer.subscription.created"||d==="customer.subscription.updated"){let f=i.data.object?.plan?.nickname||i.data.object?.items?.data?.[0]?.price?.nickname||"",g=/managed|pro|premium/i.test(f),b=await ie(e,p);b.flags={use_make:!g,direct_yt:g},await oe(e,b)}}catch{}return new Response("ok",{status:200})}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/motm/open$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],p=await t.json().catch(()=>({})),f=p.tenant||"default",g=e.VotingRoom.idFromName(`${f}:${d}`),b=e.VotingRoom.get(g),S={tenant:f,matchId:d,...p},v=await b.fetch("https://do/open",{method:"POST",body:JSON.stringify(S)});return l(await v.json(),v.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/motm/close$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],f=(await t.json().catch(()=>({}))).tenant||"default",g=e.VotingRoom.idFromName(`${f}:${d}`),S=await e.VotingRoom.get(g).fetch("https://do/close",{method:"POST"});return l(await S.json(),S.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/motm/tally$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],p=c.searchParams.get("tenant")||"default",f=e.VotingRoom.idFromName(`${p}:${d}`),b=await e.VotingRoom.get(f).fetch("https://do/tally");return l(await b.json(),b.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/matches/[^/]+/motm/vote$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=t.headers.get("cf-connecting-ip")||t.headers.get("x-forwarded-for")||"unknown",g=t.headers.get("user-agent")||"",b=`${f}:${g}`.substring(0,64),S=e.VotingRoom.idFromName(`${p}:${i}`),v=e.VotingRoom.get(S),j={candidateId:d.candidateId,userHash:b},J=await v.fetch("https://do/vote",{method:"POST",body:JSON.stringify(j)});return l(await J.json(),J.status,r)}if(c.pathname===`/api/${h}/admin/events`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),p=d.tenant||"default",f=Date.now();return d.createdAt=d.createdAt||f,d.updatedAt=f,await Gs(e,p,d),l({success:!0,data:{id:d.id}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/events/[^/]+$`))&&t.method==="PATCH"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=await t.json().catch(()=>({})),f=p.tenant||"default",g=await zs(e,f,d);if(!g)return l({success:!1,error:{code:"NOT_FOUND"}},404,r);let b={...g,...p,updatedAt:Date.now()};return await Gs(e,f,b),l({success:!0,data:{id:d}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/events/[^/]+$`))&&t.method==="DELETE"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=c.searchParams.get("tenant")||"default";return await Vn(e,p,d),l({success:!0},200,r)}if(c.pathname===`/api/${h}/events`&&t.method==="GET"){let i=c.searchParams.get("tenant")||"default",d=await Fn(e,i);return l({success:!0,data:d},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/events/[^/]+$`))&&t.method==="GET"){let i=c.pathname.split("/").pop(),d=c.searchParams.get("tenant")||"default",p=await zs(e,d,i);return p?l({success:!0,data:p},200,r):l({success:!1,error:{code:"NOT_FOUND"}},404,r)}if(c.pathname.match(new RegExp(`^/api/${h}/events/[^/]+/rsvp$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.userId||"anonymous",g=d.rsvp;return["yes","no","maybe"].includes(g)?(await Wn(e,p,i,f,g),l({success:!0},200,r)):l({success:!1,error:{code:"VALIDATION",message:"rsvp must be yes/no/maybe"}},400,r)}if(c.pathname.match(new RegExp(`^/api/${h}/events/[^/]+/checkin$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.userId||"anonymous";return await Bn(e,p,i,f),l({success:!0,data:{ts:Date.now()}},200,r)}if(c.pathname===`/api/${h}/devices/register`&&t.method==="POST"){let i=await t.json().catch(()=>({})),d=i.tenant||"default",p=i.userId||"anonymous",f=i.platform||"unknown",g=i.token;return g?(await Jn(e,d,p,f,g),l({success:!0},200,r)):l({success:!1,error:{code:"VALIDATION",message:"token required"}},400,r)}if(c.pathname===`/api/${h}/push/register`&&t.method==="POST"){let i=await t.json().catch(()=>({})),d=i.tenant||"default",p=i.teamId,f=i.token;if(!f)return l({success:!1,error:{code:"VALIDATION",message:"token required"}},400,r);let g=`tenants:${d}:push:tokens`,b=await e.KV_IDEMP.get(g,"json")||[];if(b.includes(f)||(b.push(f),await e.KV_IDEMP.put(g,JSON.stringify(b))),p){let S=`tenants:${d}:team:${p}:tokens`,v=await e.KV_IDEMP.get(S,"json")||[];v.includes(f)||(v.push(f),await e.KV_IDEMP.put(S,JSON.stringify(v)))}return l({success:!0},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/league/[^/]+/table$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("season")||new Date().getFullYear().toString();try{let f=`${(e.FIXTURES_REFRESH_URL||"").replace("/refresh","")}/table?league=${i}&season=${d}`,g=await fetch(f),b=await g.json();return!g.ok||!b.ok?l({success:!1,error:{code:"UPSTREAM_ERROR",message:b.message||"Failed"}},g.status,r):l({success:!0,data:b.data},200,r)}catch(p){return l({success:!1,error:{code:"FETCH_ERROR",message:p.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/league/[^/]+/fixtures$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("season")||new Date().getFullYear().toString();try{let f=`${(e.FIXTURES_REFRESH_URL||"").replace("/refresh","")}/fixtures?league=${i}&season=${d}`,g=await fetch(f),b=await g.json();return!g.ok||!b.ok?l({success:!1,error:{code:"UPSTREAM_ERROR",message:b.message||"Failed"}},g.status,r):l({success:!0,data:b.data},200,r)}catch(p){return l({success:!1,error:{code:"FETCH_ERROR",message:p.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/league/[^/]+/results$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("season")||new Date().getFullYear().toString();try{let f=`${(e.FIXTURES_REFRESH_URL||"").replace("/refresh","")}/results?league=${i}&season=${d}`,g=await fetch(f),b=await g.json();return!g.ok||!b.ok?l({success:!1,error:{code:"UPSTREAM_ERROR",message:b.message||"Failed"}},g.status,r):l({success:!0,data:b.data},200,r)}catch(p){return l({success:!1,error:{code:"FETCH_ERROR",message:p.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/league/[^/]+/seasons$`))&&t.method==="GET"){let i=c.pathname.split("/")[4];try{let p=`${(e.FIXTURES_REFRESH_URL||"").replace("/refresh","")}/seasons?league=${i}`,f=await fetch(p),g=await f.json();return!f.ok||!g.ok?l({success:!1,error:{code:"UPSTREAM_ERROR",message:g.message||"Failed"}},f.status,r):l({success:!0,data:g.data},200,r)}catch(d){return l({success:!1,error:{code:"FETCH_ERROR",message:d.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/live/open$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],p=await t.json().catch(()=>({})),f=p.tenant||"default",g=e.MatchRoom.idFromName(`${f}::${d}`),b=e.MatchRoom.get(g),S={tenant:f,matchId:d,...p},v=await b.fetch("https://do/open",{method:"POST",body:JSON.stringify(S)});return l(await v.json(),v.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/live/event$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],p=await t.json().catch(()=>({})),f=p.tenant||"default",g=e.MatchRoom.idFromName(`${f}::${d}`),S=await e.MatchRoom.get(g).fetch("https://do/event",{method:"POST",body:JSON.stringify(p)});return l(await S.json(),S.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/admin/matches/[^/]+/live/close$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/")[5],f=(await t.json().catch(()=>({}))).tenant||"default",g=e.MatchRoom.idFromName(`${f}::${d}`),S=await e.MatchRoom.get(g).fetch("https://do/close",{method:"POST"});return l(await S.json(),S.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/matches/[^/]+/live$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=e.MatchRoom.idFromName(`${d}::${i}`),g=await e.MatchRoom.get(p).fetch("https://do/tally");return l(await g.json(),g.status,r)}if(c.pathname===`/api/${h}/push/register`&&t.method==="POST"){let i=await t.json().catch(()=>({})),d=i.tenant||"default",p=i.token,f=i.platform;if(!p)return l({success:!1,error:{code:"MISSING_TOKEN",message:"Push token required"}},400,r);let g=`tenants:${d}:push:tokens`,b=await e.KV_IDEMP.get(g,"json")||[];b.includes(p)||(b.push(p),await e.KV_IDEMP.put(g,JSON.stringify(b)));let S=`tenants:${d}:push:token:${p}`;return await e.KV_IDEMP.put(S,JSON.stringify({token:p,platform:f,registered:Date.now()})),l({success:!0,data:{registered:!0}},200,r)}if(c.pathname===`/api/${h}/push/location`&&t.method==="POST"){let i=await t.json().catch(()=>({})),d=i.tenant||"default",p=i.token,f=i.latitude,g=i.longitude,b=i.timestamp||Date.now();if(!p||f===void 0||g===void 0)return l({success:!1,error:{code:"MISSING_DATA",message:"Token and location required"}},400,r);let S=`tenants:${d}:push:location:${p}`;return await e.KV_IDEMP.put(S,JSON.stringify({latitude:f,longitude:g,timestamp:b}),{expirationTtl:1800}),l({success:!0,data:{updated:!0}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/geo/[^/]+/init$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.venueLatitude,g=d.venueLongitude,b=e.GeoFenceManager.idFromName(`${p}::${i}`),S=e.GeoFenceManager.get(b),v={tenant:p,matchId:i,venueLatitude:f,venueLongitude:g},j=await S.fetch("https://do/init",{method:"POST",body:JSON.stringify(v)});return l(await j.json(),j.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/geo/[^/]+/venue$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.latitude,g=d.longitude;if(f===void 0||g===void 0)return l({success:!1,error:{code:"MISSING_LOCATION",message:"Latitude and longitude required"}},400,r);let b=e.GeoFenceManager.idFromName(`${p}::${i}`),S=e.GeoFenceManager.get(b),v={latitude:f,longitude:g},j=await S.fetch("https://do/venue",{method:"POST",body:JSON.stringify(v)});return l(await j.json(),j.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/geo/[^/]+/tokens$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=e.GeoFenceManager.idFromName(`${d}::${i}`),g=await e.GeoFenceManager.get(p).fetch("https://do/tokens");return l(await g.json(),g.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/geo/[^/]+/state$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=e.GeoFenceManager.idFromName(`${d}::${i}`),g=await e.GeoFenceManager.get(p).fetch("https://do/state");return l(await g.json(),g.status,r)}if(c.pathname===`/api/${h}/videos/upload`&&t.method==="POST"){let i=await t.formData(),d=i.get("tenant")||"default",p=i.get("user_id")||"anonymous",f=i.get("video");if(!f||!(f instanceof File))return l({success:!1,error:{code:"MISSING_VIDEO",message:"Video file required"}},400,r);let g=`vid-${Date.now()}-${Math.random().toString(36).substring(7)}`,b=`videos/${d}/uploads/${g}.mp4`,S=await f.arrayBuffer();await e.R2_MEDIA.put(b,S,{httpMetadata:{contentType:"video/mp4"},customMetadata:{tenant:d,userId:p,uploadedAt:new Date().toISOString()}});let v={id:g,tenant:d,userId:p,filename:f.name,size:f.size,r2Key:b,uploadTimestamp:Date.now(),status:"uploaded",processingProgress:0};await e.KV_IDEMP.put(`video:${d}:${g}`,JSON.stringify(v));let j=`video_list:${d}`,J=await e.KV_IDEMP.get(j,"json")||[];return J.unshift(g),await e.KV_IDEMP.put(j,JSON.stringify(J.slice(0,100))),l({success:!0,data:{videoId:g,status:"uploaded"}},200,r)}if(c.pathname===`/api/${h}/videos`&&t.method==="GET"){let i=c.searchParams.get("tenant")||"default",d=parseInt(c.searchParams.get("limit")||"20"),p=parseInt(c.searchParams.get("offset")||"0"),f=`video_list:${i}`,g=await e.KV_IDEMP.get(f,"json")||[],b=g.slice(p,p+d),S=[];for(let v of b){let j=await e.KV_IDEMP.get(`video:${i}:${v}`,"json");j&&S.push(j)}return l({success:!0,data:{videos:S,total:g.length}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/videos/[^/]+$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=await e.KV_IDEMP.get(`video:${d}:${i}`,"json");return p?l({success:!0,data:p},200,r):l({success:!1,error:{code:"VIDEO_NOT_FOUND",message:"Video not found"}},404,r)}if(c.pathname.match(new RegExp(`^/api/${h}/videos/[^/]+/status$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=await e.KV_IDEMP.get(`video:${d}:${i}`,"json");return p?l({success:!0,data:{videoId:i,status:p.status||"uploaded",progress:p.processingProgress||0,clips:p.clips||[]}},200,r):l({success:!1,error:{code:"VIDEO_NOT_FOUND",message:"Video not found"}},404,r)}if(c.pathname.match(new RegExp(`^/api/${h}/videos/[^/]+/process$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],p=(await t.json().catch(()=>({}))).tenant||"default",f=await e.KV_IDEMP.get(`video:${p}:${i}`,"json");return f?(f.status="processing",f.processingProgress=0,await e.KV_IDEMP.put(`video:${p}:${i}`,JSON.stringify(f)),l({success:!0,data:{videoId:i,status:"processing"}},200,r)):l({success:!1,error:{code:"VIDEO_NOT_FOUND",message:"Video not found"}},404,r)}if(c.pathname.match(new RegExp(`^/api/${h}/videos/[^/]+$`))&&t.method==="DELETE"){let i=c.pathname.split("/")[4],p=(await t.json().catch(()=>({}))).tenant||"default",f=await e.KV_IDEMP.get(`video:${p}:${i}`,"json");if(!f)return l({success:!1,error:{code:"VIDEO_NOT_FOUND",message:"Video not found"}},404,r);await e.R2_MEDIA.delete(f.r2Key),await e.KV_IDEMP.delete(`video:${p}:${i}`);let g=`video_list:${p}`,S=(await e.KV_IDEMP.get(g,"json")||[]).filter(v=>v!==i);return await e.KV_IDEMP.put(g,JSON.stringify(S)),l({success:!0,data:{deleted:!0}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/videos/[^/]+/clips$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=await e.KV_IDEMP.get(`video:${d}:${i}`,"json");return p?l({success:!0,data:{clips:p.clips||[]}},200,r):l({success:!1,error:{code:"VIDEO_NOT_FOUND",message:"Video not found"}},404,r)}if(c.pathname.match(new RegExp(`^/api/${h}/chat/[^/]+/send$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.userId||"anonymous",g=`${p}:chat:${i}:${f}`,b=e.TenantRateLimiter.idFromName(g);if(!(await(await e.TenantRateLimiter.get(b).fetch("https://do/check",{method:"POST",body:JSON.stringify({key:g,limit:1,window:1e3})})).json()).allowed)return l({success:!1,error:{code:"RATE_LIMIT",message:"Too many messages"}},429,r);let J=e.ChatRoom.idFromName(`${p}::${i}`),H=e.ChatRoom.get(J),xt={tenant:p,roomId:i,...d},la=await H.fetch("https://do/send",{method:"POST",body:JSON.stringify(xt)});return l(await la.json(),la.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/chat/[^/]+/history$`))&&t.method==="GET"){let i=c.pathname.split("/")[4],d=c.searchParams.get("tenant")||"default",p=c.searchParams.get("cursor")||void 0,f=parseInt(c.searchParams.get("limit")||"50",10),g=e.ChatRoom.idFromName(`${d}::${i}`),S=await e.ChatRoom.get(g).fetch(`https://do/history?tenant=${d}&roomId=${i}&cursor=${p||""}&limit=${f}`);return l(await S.json(),S.status,r)}if(c.pathname.match(new RegExp(`^/api/${h}/chat/[^/]+/typing$`))&&t.method==="POST"){let i=c.pathname.split("/")[4],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=e.ChatRoom.idFromName(`${p}::${i}`),g=e.ChatRoom.get(f),b={tenant:p,roomId:i,...d},S=await g.fetch("https://do/typing",{method:"POST",body:JSON.stringify(b)});return l(await S.json(),S.status,r)}if(c.pathname===`/api/${h}/media/albums`&&t.method==="POST"){let i=await t.json().catch(()=>({})),d=i.tenant||"default",p=i.title||"Untitled Album",f=i.teamId,g=`alb_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,b=`tenants:${d}:albums:index`,S=await e.KV_IDEMP.get(b,"json")||[],j=[{albumId:g,title:p,teamId:f,coverKey:null,count:0,updatedTs:Date.now()},...S.filter(H=>H.albumId!==g)];await e.KV_IDEMP.put(b,JSON.stringify(j.slice(0,500)));let J=`tenants:${d}:albums:${g}:index`;return await e.KV_IDEMP.put(J,JSON.stringify([])),l({success:!0,data:{albumId:g}},200,r)}if(c.pathname===`/api/${h}/media/albums`&&t.method==="GET"){let d=`tenants:${c.searchParams.get("tenant")||"default"}:albums:index`,p=await e.KV_IDEMP.get(d,"json")||[];return l({success:!0,data:p},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/media/albums/[^/]+$`))&&t.method==="GET"){let i=c.pathname.split("/").pop(),d=c.searchParams.get("tenant")||"default",p=`tenants:${d}:albums:index`,g=(await e.KV_IDEMP.get(p,"json")||[]).find(v=>v.albumId===i);if(!g)return l({success:!1,error:{code:"NOT_FOUND"}},404,r);let b=`tenants:${d}:albums:${i}:index`,S=await e.KV_IDEMP.get(b,"json")||[];return l({success:!0,data:{...g,photos:S.slice(0,20)}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/media/albums/[^/]+/upload-url$`))&&t.method==="POST"){let i=c.pathname.split("/")[5],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.contentType||"image/jpeg",g=`photo_${Date.now()}_${Math.random().toString(36).slice(2,9)}`,b=`tenants/${p}/albums/${i}/${g}.jpg`;try{let S=await e.R2_MEDIA.createMultipartUpload(b);return l({success:!0,data:{putUrl:S,objectKey:b}},200,r)}catch(S){return l({success:!1,error:{code:"R2_ERROR",message:S.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/media/albums/[^/]+/commit$`))&&t.method==="POST"){let i=c.pathname.split("/")[5],d=await t.json().catch(()=>({})),p=d.tenant||"default",f=d.objectKey,g=d.caption;if(!f)return l({success:!1,error:{code:"VALIDATION",message:"objectKey required"}},400,r);let b=`tenants:${p}:albums:${i}:index`,S=await e.KV_IDEMP.get(b,"json")||[],v={key:f,ts:Date.now(),caption:g};S.push(v),await e.KV_IDEMP.put(b,JSON.stringify(S));let j=`tenants:${p}:albums:index`,J=await e.KV_IDEMP.get(j,"json")||[],H=J.find(xt=>xt.albumId===i);return H&&(H.count=S.length,H.updatedTs=Date.now(),H.coverKey||(H.coverKey=f),await e.KV_IDEMP.put(j,JSON.stringify(J))),l({success:!0,data:{photoKey:f}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/media/albums/[^/]+/photos$`))&&t.method==="GET"){let i=c.pathname.split("/")[5],d=c.searchParams.get("tenant")||"default",p=c.searchParams.get("cursor")||"0",f=`tenants:${d}:albums:${i}:index`,g=await e.KV_IDEMP.get(f,"json")||[],b=parseInt(p,10),S=20,v=g.slice(b,b+S),j=await Promise.all(v.map(async H=>{try{return await e.R2_MEDIA.get(H.key)?{...H,url:`/api/${h}/media/photo/${encodeURIComponent(H.key)}`}:{...H,url:null}}catch{return{...H,url:null}}})),J=b+v.length<g.length?String(b+S):null;return l({success:!0,data:{photos:j,nextCursor:J}},200,r)}if(c.pathname.match(new RegExp(`^/api/${h}/media/photos/`))&&t.method==="DELETE"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=decodeURIComponent(c.pathname.split("/media/photos/")[1]),p=c.searchParams.get("tenant")||"default";try{return await e.R2_MEDIA.delete(d),l({success:!0},200,r)}catch(f){return l({success:!1,error:{code:"R2_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/media/photo/`))&&t.method==="GET"){let i=decodeURIComponent(c.pathname.split("/media/photo/")[1]);try{let d=await e.R2_MEDIA.get(i);if(!d)return new Response("Not found",{status:404});let p=jt(r,{"content-type":d.httpMetadata?.contentType||"image/jpeg","cache-control":"public, max-age=3600"});return new Response(d.body,be({status:200,headers:p}))}catch(d){return l({success:!1,error:{code:"R2_ERROR",message:d.message}},500,r)}}if(c.pathname===`/api/${h}/admin/invites/create`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),{tenant:p,teamId:f,role:g,maxUses:b,ttl_minutes:S}=d;try{let v=await Hn(e,{tenant:p,teamId:f,role:g,maxUses:b,ttl_minutes:S,createdBy:i.userId||"admin"});return l(v,200,r)}catch(v){return l({success:!1,error:{code:"INVITE_ERROR",message:v.message}},v.status||500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/invites/[^/]+$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop();try{let p=await Gn(e,d);return l({ok:!0,invite:p},200,r)}catch(p){return l({success:!1,error:{code:"INVITE_ERROR",message:p.message}},p.status||500,r)}}if(c.pathname===`/api/${h}/invites/consume`&&t.method==="POST"){let i=await t.json().catch(()=>({})),{token:d,email:p,name:f}=i;try{let g=await zn(e,d);return l({ok:!0,invite:g},200,r)}catch(g){return l({success:!1,error:{code:"INVITE_ERROR",message:g.message}},g.status||500,r)}}if(c.pathname===`/api/${h}/admin/teams`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),{tenant:p,teamId:f,name:g,ageGroup:b}=d;try{let S=await Yn(e,{tenant:p,teamId:f,name:g,ageGroup:b});return l({ok:!0,team:S},200,r)}catch(S){return l({success:!1,error:{code:"TEAM_ERROR",message:S.message}},S.status||500,r)}}if(c.pathname===`/api/${h}/teams`&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.searchParams.get("tenant")||"default";try{let p=await Zn(e,d);return l({ok:!0,teams:p},200,r)}catch(p){return l({success:!1,error:{code:"TEAM_ERROR",message:p.message}},500,r)}}if(c.pathname===`/api/${h}/admin/chat/rooms`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),{tenant:p,roomId:f,teamId:g,type:b}=d;try{let S=await Qn(e,{tenant:p,roomId:f,teamId:g,type:b});return l({ok:!0,room:S},200,r)}catch(S){return l({success:!1,error:{code:"CHAT_ERROR",message:S.message}},S.status||500,r)}}if(c.pathname===`/api/${h}/chat/rooms`&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.searchParams.get("tenant")||"default",p=c.searchParams.get("teamId")||void 0;try{let f=await Zs(e,d,p);return l({ok:!0,rooms:f},200,r)}catch(f){return l({success:!1,error:{code:"CHAT_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/chat/rooms/[^/]+/messages$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i)return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.pathname.split("/")[5],p=await t.json().catch(()=>({})),{tenant:f,text:g}=p;try{let b=await qn(e,{tenant:f,roomId:d,userId:i.userId||"anonymous",text:g});return l({ok:!0,msg:b},200,r)}catch(b){return l({success:!1,error:{code:"CHAT_ERROR",message:b.message}},b.status||500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/chat/rooms/[^/]+/messages$`))&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.pathname.split("/")[5],p=c.searchParams.get("tenant")||"default";try{let f=await er(e,{tenant:p,roomId:d,limit:100});return l({ok:!0,messages:f},200,r)}catch(f){return l({success:!1,error:{code:"CHAT_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)$`)),p=d?d[1]:"";try{let f=await $t(e,p);if(!f)return l({success:!1,error:{code:"NOT_FOUND",message:"Tenant not found"}},404,r);let g={id:f.id,name:f.name,flags:f.flags||{},makeWebhookUrl:f.makeWebhookUrl?"***configured***":void 0,createdAt:f.createdAt};return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"INTERNAL",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)/chat-index$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)/chat-index$`)),p=d?d[1]:"";try{let f=await Zs(e,p);return l({success:!0,data:{tenant:p,rooms:f}},200,r)}catch(f){return l({success:!1,error:{code:"INTERNAL",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)/gallery-index$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.match(new RegExp(`^/api/${h}/admin/export/tenant/([^/]+)/gallery-index$`)),p=d?d[1]:"";try{let f=await Xs(e,p);return l({success:!0,data:{tenant:p,albums:f}},200,r)}catch(f){return l({success:!1,error:{code:"INTERNAL",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/admin/gallery/albums`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),{tenant:p,title:f,teamId:g,eventId:b}=d;try{let S=await tr(e,{tenant:p,title:f,teamId:g,eventId:b,createdBy:i.userId||"admin"});return l({ok:!0,album:S},200,r)}catch(S){return l({success:!1,error:{code:"GALLERY_ERROR",message:S.message}},S.status||500,r)}}if(c.pathname===`/api/${h}/gallery/albums`&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.searchParams.get("tenant")||"default",p=c.searchParams.get("teamId")||void 0;try{let f=await Xs(e,d,p);return l({ok:!0,albums:f},200,r)}catch(f){return l({success:!1,error:{code:"GALLERY_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/gallery/albums/[^/]+/upload$`))&&t.method==="POST"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.pathname.split("/")[5],p=c.searchParams.get("tenant")||"default";if(!(t.headers.get("content-type")||"").startsWith("multipart/form-data"))return l({success:!1,error:{code:"VALIDATION",message:"multipart required"}},400,r);try{let b=(await t.formData()).get("file");if(!(b instanceof File))return l({success:!1,error:{code:"VALIDATION",message:"file missing"}},400,r);let S=await b.arrayBuffer(),{r2Key:v}=await sr(e,{tenant:p,albumId:d,file:S,contentType:b.type});return l({ok:!0,r2Key:v},200,r)}catch(g){return l({success:!1,error:{code:"GALLERY_ERROR",message:g.message}},g.status||500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/gallery/albums/[^/]+/commit$`))&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i)return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.pathname.split("/")[5],p=await t.json().catch(()=>({})),{tenant:f,r2Key:g,playerTags:b,consentCheck:S}=p;try{let v=await ar(e,{tenant:f,albumId:d,r2Key:g,uploaderId:i.userId||"anonymous",playerTags:b,consentCheck:S});return l({ok:!0,media:v},200,r)}catch(v){return l({success:!1,error:{code:"GALLERY_ERROR",message:v.message}},v.status||500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/gallery/albums/[^/]+$`))&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.pathname.split("/")[5],p=c.searchParams.get("tenant")||"default";try{let f=await nr(e,{tenant:p,albumId:d,respectConsent:!0});return l({ok:!0,media:f},200,r)}catch(f){return l({success:!1,error:{code:"GALLERY_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/gallery/file`&&t.method==="GET"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=c.searchParams.get("key");if(!d)return l({success:!1,error:{code:"VALIDATION",message:"key required"}},400,r);try{let p=await e.R2_MEDIA.get(d);if(!p)return l({success:!1,error:{code:"NOT_FOUND"}},404,r);let f=jt(r,{"content-type":p.httpMetadata?.contentType||"image/jpeg","cache-control":"public, max-age=3600"});return new Response(p.body,be({status:200,headers:f}))}catch(p){return l({success:!1,error:{code:"R2_ERROR",message:p.message}},500,r)}}if(c.pathname===`/api/${h}/admin/player-images`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),p=d.tenant||"default";try{let{createPlayerImage:f}=await Promise.resolve().then(()=>(Et(),_t)),g=await f(e,p,{playerId:d.playerId,playerName:d.playerName,type:d.type,imageUrl:d.imageUrl,r2Key:d.r2Key,uploadedBy:i.userId||"admin",metadata:d.metadata});return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"PLAYER_IMAGE_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/admin/player-images`&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant")||"default",p=c.searchParams.get("playerId")||void 0,f=c.searchParams.get("type");try{let{listPlayerImages:g}=await Promise.resolve().then(()=>(Et(),_t)),b=await g(e,d,{playerId:p,type:f});return l({success:!0,data:b},200,r)}catch(g){return l({success:!1,error:{code:"PLAYER_IMAGE_ERROR",message:g.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/player-images/[^/]+$`))&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=c.searchParams.get("tenant")||"default";try{let{getPlayerImage:f}=await Promise.resolve().then(()=>(Et(),_t)),g=await f(e,p,d);return g?l({success:!0,data:g},200,r):l({success:!1,error:{code:"NOT_FOUND"}},404,r)}catch(f){return l({success:!1,error:{code:"PLAYER_IMAGE_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/player-images/[^/]+$`))&&t.method==="PATCH"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=await t.json().catch(()=>({})),f=p.tenant||"default";try{let{updatePlayerImage:g}=await Promise.resolve().then(()=>(Et(),_t)),b=await g(e,f,d,p);return b?l({success:!0,data:b},200,r):l({success:!1,error:{code:"NOT_FOUND"}},404,r)}catch(g){return l({success:!1,error:{code:"PLAYER_IMAGE_ERROR",message:g.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/player-images/[^/]+$`))&&t.method==="DELETE"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=c.searchParams.get("tenant")||"default";try{let{deletePlayerImage:f}=await Promise.resolve().then(()=>(Et(),_t));return await f(e,p,d)?l({success:!0},200,r):l({success:!1,error:{code:"NOT_FOUND"}},404,r)}catch(f){return l({success:!1,error:{code:"PLAYER_IMAGE_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/admin/auto-posts-matrix`&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant")||"default";try{let{getAutoPostsMatrix:p}=await Promise.resolve().then(()=>(bs(),Es)),f=await p(e,d);return l({success:!0,data:f},200,r)}catch(p){return l({success:!1,error:{code:"MATRIX_ERROR",message:p.message}},500,r)}}if(c.pathname===`/api/${h}/admin/auto-posts-matrix`&&t.method==="PUT"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),p=d.tenant||"default";try{let{updateAutoPostsMatrix:f}=await Promise.resolve().then(()=>(bs(),Es)),g=await f(e,p,d.matrix);return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"MATRIX_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/admin/auto-posts-matrix/reset`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let p=(await t.json().catch(()=>({}))).tenant||"default";try{let{resetAutoPostsMatrix:f}=await Promise.resolve().then(()=>(bs(),Es)),g=await f(e,p);return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"MATRIX_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/brand`&&t.method==="GET"){let i=c.searchParams.get("tenant")||t.headers.get("x-tenant")||"default";try{let{getBrand:d}=await Promise.resolve().then(()=>(da(),ua)),p=await d(e,i);return l({success:!0,data:p},200,r)}catch(d){return l({success:!1,error:{code:"BRAND_ERROR",message:d.message}},500,r)}}if(c.pathname===`/api/${h}/brand`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),p=d.tenant||t.headers.get("x-tenant")||c.searchParams.get("tenant")||"default";try{let{setBrand:f}=await Promise.resolve().then(()=>(da(),ua)),g=await f(e,p,d);return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"BRAND_ERROR",message:f.message}},400,r)}}if(c.pathname===`/api/${h}/admin/club-config`&&t.method==="GET"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant")||"default";try{let{getClubConfig:p}=await Promise.resolve().then(()=>(st(),St)),f=await p(e,d);return l({success:!0,data:f},200,r)}catch(p){return l({success:!1,error:{code:"CONFIG_ERROR",message:p.message}},500,r)}}if(c.pathname===`/api/${h}/admin/club-config`&&t.method==="PUT"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=await t.json().catch(()=>({})),p=d.tenant||"default";try{let{updateClubConfig:f}=await Promise.resolve().then(()=>(st(),St)),g=await f(e,p,d.config);return l({success:!0,data:g},200,r)}catch(f){return l({success:!1,error:{code:"CONFIG_ERROR",message:f.message}},500,r)}}if(c.pathname.match(new RegExp(`^/api/${h}/admin/club-config/[^/]+$`))&&t.method==="PATCH"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.pathname.split("/").pop(),p=await t.json().catch(()=>({})),f=p.tenant||"default";try{let{updateClubConfigSection:g}=await Promise.resolve().then(()=>(st(),St)),b=await g(e,f,d,p.data);return l({success:!0,data:b},200,r)}catch(g){return l({success:!1,error:{code:"CONFIG_ERROR",message:g.message}},500,r)}}if(c.pathname===`/api/${h}/admin/club-config/upload-badge`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant")||"default";if(!(t.headers.get("content-type")||"").startsWith("multipart/form-data"))return l({success:!1,error:{code:"VALIDATION",message:"multipart required"}},400,r);try{let g=(await t.formData()).get("file");if(!(g instanceof File))return l({success:!1,error:{code:"VALIDATION",message:"file missing"}},400,r);let b=await g.arrayBuffer(),{uploadClubBadge:S}=await Promise.resolve().then(()=>(st(),St)),v=await S(e,d,b,g.type);return l({success:!0,data:v},200,r)}catch(f){return l({success:!1,error:{code:"CONFIG_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/admin/club-config/upload-sponsor`&&t.method==="POST"){let i=await O(t,e).catch(()=>null);if(!i||!D(i,"admin"))return l({success:!1,error:{code:"FORBIDDEN"}},403,r);let d=c.searchParams.get("tenant")||"default";if(!(t.headers.get("content-type")||"").startsWith("multipart/form-data"))return l({success:!1,error:{code:"VALIDATION",message:"multipart required"}},400,r);try{let g=(await t.formData()).get("file");if(!(g instanceof File))return l({success:!1,error:{code:"VALIDATION",message:"file missing"}},400,r);let b=await g.arrayBuffer(),{uploadSponsorLogo:S}=await Promise.resolve().then(()=>(st(),St)),v=await S(e,d,b,g.type);return l({success:!0,data:v},200,r)}catch(f){return l({success:!1,error:{code:"CONFIG_ERROR",message:f.message}},500,r)}}if(c.pathname===`/api/${h}/post`&&t.method==="POST"){if(!await O(t,e).catch(()=>null))return l({success:!1,error:{code:"UNAUTHORIZED"}},401,r);let d=await t.json().catch(()=>null),p=d?En.safeParse(d):{success:!1,error:{message:"Invalid JSON"}};if(!("success"in p)||!p.success)return l({success:!1,error:{code:"VALIDATION",message:p.error?.message||"Invalid"}},400,r);let f=Vs(t),g=await Bs(e,p.data.tenant,p.data,f||void 0);if(g.hit)return l(g.response,200,r);await e.POST_QUEUE.send({tenant:p.data.tenant,template:p.data.template,channels:p.data.channels,data:p.data.data,createdAt:Date.now(),idemKey:g.key});let b={success:!0,data:{queued:!0}};return await g.store(b),l(b,202,r)}return L("warn",n,{message:"Route not found",method:t.method,pathname:c?.pathname,search:c?.search}),l({success:!1,error:{code:"NOT_FOUND",message:"Route not found"}},404,r)}catch(h){let x=Date.now()-a;if(h instanceof Response){let N=Tt(h,r);return L({level:"error",msg:h.statusText||"response_error",requestId:n,path:c?.pathname,status:N.status,ms:x}),N}return L({level:"error",msg:h?.message||"unhandled",requestId:n,path:c?.pathname,status:500,ms:x}),l({success:!1,error:{code:"INTERNAL",message:"Unexpected error"}},500,r);let P=jt(r,{"content-type":"application/json"});return new Response(JSON.stringify({error:{code:"INTERNAL",requestId:n}}),be({status:500,headers:P}))}finally{let h=Date.now()-a;L({level:"info",msg:"request_end",requestId:n,path:c?.pathname,ms:h})}},queue:Kn.queue,async scheduled(t,e,s){L({level:"info",msg:"cron_tick",path:"scheduled",ms:Date.now()-t.scheduledTime})}};export{aa as ChatRoom,na as GeoFenceManager,sa as MatchRoom,ra as Provisioner,ea as TenantRateLimiter,ta as VotingRoom,wS as default};
//# sourceMappingURL=index.js.map
