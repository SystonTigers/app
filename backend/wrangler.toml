
name = "app"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]
minify = true
workers_dev = true

[observability]
enabled = true

# ─────────────────────────────────────────────────────────
# PRODUCTION ENVIRONMENT
# ─────────────────────────────────────────────────────────
[env.production]
compatibility_date = "2024-11-01"

[env.production.vars]
# Public Config
API_VERSION = "v1"
JWT_ISSUER = "syston.app"
JWT_AUDIENCE = "syston-mobile"
APP_VERSION = "7.0.0"
TEMPLATE_SPREADSHEET_ID = "1YourTemplateSpreadsheetId"
FIXTURES_REFRESH_URL = "https://syston-fixtures.team-platform-2025.workers.dev/refresh"
ALLOWED_WEBHOOK_HOSTS = "hook.make.com,hook.eu2.make.com,hook.us1.make.com,*.make.com,webhook.site"
SETUP_URL = "https://setup-console.team-platform-2025.workers.dev"
GALLERY_ALLOWED = "image/jpeg,image/png,image/webp"
GALLERY_MAX_BYTES = "10485760"
YT_REDIRECT_URL = "https://syston-postbus.team-platform-2025.workers.dev/api/v1/admin/yt/callback"
RL_POSTS_PER_MIN = "60"
RL_UPLOADS_PER_MIN = "20"
APPS_SCRIPT_AUTO_DEPLOY = "true"
BACKEND_URL = "https://syston-postbus.team-platform-2025.workers.dev"
ADMIN_CONSOLE_URL = "https://admin-console.team-platform-2025.workers.dev"
RESEND_FROM_EMAIL = "onboarding@syston.app"
WORKER_BASE_URL = "https://app.team-platform-2025.workers.dev"
ENVIRONMENT = "production"
DRY_RUN = "false"
MAKE_VALIDATE_STRICT = "true"
SENTRY_DSN = "https://prod-sentry.example.com/1"
GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwMEAZaXwn_1mvpa_XWFB4ywU8oP795NFVyVu6RmyCXpLIOA0MurWVVuWbocmWakF3O/exec"
SUPABASE_URL = "https://prod-supabase.example.com"
SUPABASE_ANON_KEY = "prod-anon-key"

# Secret variables are bound below from Wrangler secrets

[[env.production.kv_namespaces]]
binding = "TENANTS"
id = "71b9f158fb2c4e1a8858dded2633ff5b"

[[env.production.kv_namespaces]]
binding = "KV_IDEMP"
id = "5948d4a91ac04b50904a06c923221994"

[[env.production.kv_namespaces]]
binding = "FEATURE_FLAGS"
id = "2b092164260d45d6a9a4af55555ffc09"

[[env.production.d1_databases]]
binding = "DB"
database_name = "syston-db"
database_id = "3031c292-6290-4906-947d-ab9a145538ed"

[[env.production.queues.producers]]
binding = "POST_QUEUE"
queue = "post-queue"

[[env.production.queues.producers]]
binding = "HIGHLIGHTS_QUEUE"
queue = "highlights-queue"

[[env.production.queues.producers]]
binding = "DLQ"
queue = "dead-letter"

[[env.production.queues.consumers]]
queue = "post-queue"

[[env.production.r2_buckets]]
binding = "R2_MEDIA"
bucket_name = "syston-media"

[[env.production.r2_buckets]]
binding = "VIDEOS_BUCKET"
bucket_name = "oa-videos"

[[env.production.r2_buckets]]
binding = "HIGHLIGHTS_BUCKET"
bucket_name = "oa-highlights"

[[env.production.durable_objects.bindings]]
name = "TenantRateLimiter"
class_name = "TenantRateLimiter"

[[env.production.durable_objects.bindings]]
name = "VotingRoom"
class_name = "VotingRoom"

[[env.production.durable_objects.bindings]]
name = "ChatRoom"
class_name = "ChatRoom"

[[env.production.durable_objects.bindings]]
name = "MatchRoom"
class_name = "MatchRoom"

[[env.production.durable_objects.bindings]]
name = "GeoFenceManager"
class_name = "GeoFenceManager"

[[env.production.durable_objects.bindings]]
name = "PROVISIONER"
class_name = "Provisioner"

# ─────────────────────────────────────────────────────────
# PREVIEW ENVIRONMENT
# ─────────────────────────────────────────────────────────
[env.preview]
compatibility_date = "2024-11-01"

[env.preview.vars]
# Public Config
API_VERSION = "v1"
JWT_ISSUER = "syston.app"
JWT_AUDIENCE = "syston-mobile"
APP_VERSION = "7.0.0"
TEMPLATE_SPREADSHEET_ID = "1YourTemplateSpreadsheetId"
FIXTURES_REFRESH_URL = "https://syston-fixtures.team-platform-2025.workers.dev/refresh"
ALLOWED_WEBHOOK_HOSTS = "hook.make.com,hook.eu2.make.com,hook.us1.make.com,*.make.com,webhook.site"
SETUP_URL = "https://setup-console.team-platform-2025.workers.dev"
GALLERY_ALLOWED = "image/jpeg,image/png,image/webp"
GALLERY_MAX_BYTES = "10485760"
YT_REDIRECT_URL = "https://syston-postbus.team-platform-2025.workers.dev/api/v1/admin/yt/callback"
RL_POSTS_PER_MIN = "60"
RL_UPLOADS_PER_MIN = "20"
APPS_SCRIPT_AUTO_DEPLOY = "true"
BACKEND_URL = "https://syston-postbus.team-platform-2025.workers.dev"
ADMIN_CONSOLE_URL = "https://admin-console.team-platform-2025.workers.dev"
RESEND_FROM_EMAIL = "onboarding@syston.app"
WORKER_BASE_URL = "https://app-preview.team-platform-2025.workers.dev"
ENVIRONMENT = "preview"
DRY_RUN = "true"
MAKE_VALIDATE_STRICT = "false"
SENTRY_DSN = "https://preview-sentry.example.com/1"
GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwMEAZaXwn_1mvpa_XWFB4ywU8oP795NFVyVu6RmyCXpLIOA0MurWVVuWbocmWakF3O/exec"
SUPABASE_URL = "https://preview-supabase.example.com"
SUPABASE_ANON_KEY = "preview-anon-key"

# Secret variables are bound below from Wrangler secrets

[[env.preview.kv_namespaces]]
binding = "TENANTS"
id = "ed3084ae6a9b46e7bbb5e1798831f331"

[[env.preview.kv_namespaces]]
binding = "KV_IDEMP"
id = "5948d4a91ac04b50904a06c923221994"

[[env.preview.kv_namespaces]]
binding = "FEATURE_FLAGS"
id = "8657ad3a5cca4f069c691ddd7eaf88a7"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "syston-db"
database_id = "3031c292-6290-4906-947d-ab9a145538ed"

[[env.preview.queues.producers]]
binding = "POST_QUEUE"
queue = "post-queue"

[[env.preview.queues.producers]]
binding = "HIGHLIGHTS_QUEUE"
queue = "highlights-queue"

[[env.preview.queues.producers]]
binding = "DLQ"
queue = "dead-letter"

[[env.preview.queues.consumers]]
queue = "post-queue"

[[env.preview.r2_buckets]]
binding = "R2_MEDIA"
bucket_name = "syston-media"

[[env.preview.r2_buckets]]
binding = "VIDEOS_BUCKET"
bucket_name = "oa-videos"

[[env.preview.r2_buckets]]
binding = "HIGHLIGHTS_BUCKET"
bucket_name = "oa-highlights"

[[env.preview.durable_objects.bindings]]
name = "TenantRateLimiter"
class_name = "TenantRateLimiter"

[[env.preview.durable_objects.bindings]]
name = "VotingRoom"
class_name = "VotingRoom"

[[env.preview.durable_objects.bindings]]
name = "ChatRoom"
class_name = "ChatRoom"

[[env.preview.durable_objects.bindings]]
name = "MatchRoom"
class_name = "MatchRoom"

[[env.preview.durable_objects.bindings]]
name = "GeoFenceManager"
class_name = "GeoFenceManager"

[[env.preview.durable_objects.bindings]]
name = "PROVISIONER"
class_name = "Provisioner"

# ─────────────────────────────────────────────────────────
# TEST ENVIRONMENT
# ─────────────────────────────────────────────────────────
[env.test]
compatibility_date = "2024-11-01"

[env.test.vars]
JWT_SECRET="test-secret-key-that-is-at-least-32-characters-long"
GAS_HMAC_SECRET="test-hmac-secret"
BACKEND_API_KEY="test-backend-api-key"
YOUTUBE_API_KEY="test-youtube-api-key"
SUPABASE_SERVICE_ROLE="test-supabase-service-role"
EBAY_CLIENT_ID="test-ebay-client-id"
EBAY_CLIENT_SECRET="test-ebay-client-secret"
RESEND_API_KEY="test-resend-api-key"
GOOGLE_SERVICE_ACCOUNT_KEY="{}"
FCM_SERVER_KEY="test-fcm-server-key"
STRIPE_SECRET_KEY="test-stripe-secret-key"
STRIPE_WEBHOOK_SECRET="test-stripe-webhook-secret"
GITHUB_TOKEN="test-github-token"
EXPO_ACCESS_TOKEN="test-expo-access-token"
YT_CLIENT_ID="test-yt-client-id"
YT_CLIENT_SECRET="test-yt-client-secret"
API_VERSION = "v1"
JWT_ISSUER = "syston.app"
JWT_AUDIENCE = "syston-mobile"
APP_VERSION = "7.0.0-test"
TEMPLATE_SPREADSHEET_ID = "test-spreadsheet-id"
FIXTURES_REFRESH_URL = "http://localhost/refresh"
ALLOWED_WEBHOOK_HOSTS = "localhost"
SETUP_URL = "http://localhost"
GALLERY_ALLOWED = "image/jpeg"
GALLERY_MAX_BYTES = "1024"
YT_REDIRECT_URL = "http://localhost/callback"
RL_POSTS_PER_MIN = "100"
RL_UPLOADS_PER_MIN = "100"
APPS_SCRIPT_AUTO_DEPLOY = "false"
BACKEND_URL = "http://localhost"
ADMIN_CONSOLE_URL = "http://localhost"
RESEND_FROM_EMAIL = "test@syston.app"
WORKER_BASE_URL = "http://localhost"
ENVIRONMENT = "development"
GAS_WEBAPP_URL = "http://localhost"
SUPABASE_URL = "http://localhost"
SUPABASE_ANON_KEY = "test-anon-key"
DRY_RUN = "true"
MAKE_VALIDATE_STRICT = "false"


# ─────────────────────────────────────────────────────────
# DURABLE OBJECT MIGRATIONS (Global)
# ─────────────────────────────────────────────────────────
[[migrations]]
tag = "v1"
new_classes = [ "TenantRateLimiter" ]

[[migrations]]
tag = "v2"
new_classes = [ "VotingRoom" ]

[[migrations]]
tag = "v3"
new_classes = [ "ChatRoom", "MatchRoom" ]

[[migrations]]
tag = "v4"
new_classes = [ "GeoFenceManager" ]

[[migrations]]
tag = "v5"
new_classes = [ "Provisioner" ]

# ─────────────────────────────────────────────────────────
# CRON TRIGGERS (Global)
# ─────────────────────────────────────────────────────────
[triggers]
crons = [ "*/5 * * * *" ]
