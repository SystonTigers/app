name = "app"
main = "src/index.ts"
compatibility_date = "2024-11-01"
compatibility_flags = ["nodejs_compat"]
minify = true
workers_dev = true

[observability]
enabled = true

# [wasm_modules]
# RESVG_WASM = "node_modules/@resvg/resvg-wasm/index_bg.wasm"
# NOTE: wasm_modules not compatible with ES modules - import directly in code if needed

[vars]
API_VERSION = "v1"
JWT_ISSUER = "syston.app"
JWT_AUDIENCE = "syston-mobile"
WORKER_BASE_URL = "https://your-worker.example.workers.dev"
ENVIRONMENT = "production"
APP_VERSION = "7.0.0"
BACKEND_API_KEY = "replace-with-secret-api-key"
GAS_WEBAPP_URL = "https://script.google.com/macros/s/REPLACE/exec"
GAS_HMAC_SECRET = "replace-with-long-random-string"
TEMPLATE_SPREADSHEET_ID = "1YourTemplateSpreadsheetId"
YOUTUBE_API_KEY = "AIzaSyREPLACE"
# Fixtures refresh endpoint
FIXTURES_REFRESH_URL = "https://syston-fixtures.team-platform-2025.workers.dev/refresh"
# Allowlist of hosts for BYO-Make webhooks (comma-separated)
ALLOWED_WEBHOOK_HOSTS = "hook.make.com,hook.eu2.make.com,hook.us1.make.com,*.make.com,webhook.site"
# Public URL for tenant setup page (invite flow)
SETUP_URL = "https://setup-console.team-platform-2025.workers.dev"
# Gallery settings
GALLERY_ALLOWED = "image/jpeg,image/png,image/webp"
GALLERY_MAX_BYTES = "10485760"
# YouTube OAuth redirect URL (update with your domain when ready)
YT_REDIRECT_URL = "https://syston-postbus.team-platform-2025.workers.dev/api/v1/admin/yt/callback"
# CORS allowed origins (comma-separated, optional - defaults include localhost)
# CORS_ALLOWED = "https://app.yourbrand.com,https://admin.yourbrand.com"
# DLQ alert webhook (optional - notifies on queue failures)
# DLQ_ALERT_URL = "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
# Rate limits (requests per minute, per tenant)
RL_POSTS_PER_MIN = "60"
RL_UPLOADS_PER_MIN = "20"
# Apps Script automation (optional - enables auto-deployment)
APPS_SCRIPT_AUTO_DEPLOY = "true"  # Set to "true" to enable
BACKEND_URL = "https://syston-postbus.team-platform-2025.workers.dev"
ADMIN_CONSOLE_URL = "https://admin-console.team-platform-2025.workers.dev"
# Email configuration (Resend)
RESEND_FROM_EMAIL = "onboarding@syston.app"
# NOTE: Secrets must be set using wrangler secret put:
# - GOOGLE_SERVICE_ACCOUNT_KEY (Apps Script automation)
# - APPS_SCRIPT_TEMPLATE_ID (Apps Script template)
# - RESEND_API_KEY (Email sending via Resend)
# Example: wrangler secret put RESEND_API_KEY



[[kv_namespaces]]
binding = "KV_IDEMP"
id = "5948d4a91ac04b50904a06c923221994"   # <-- replace after Step 3 (if regenerated)

# --- D1 Database (SQLite)
[[d1_databases]]
binding = "DB"
database_name = "syston-db"
database_id = "3031c292-6290-4906-947d-ab9a145538ed"

# --- Queues
[[queues.producers]]
binding = "POST_QUEUE"
queue = "post-queue"

[[queues.producers]]
binding = "HIGHLIGHTS_QUEUE"
queue = "highlights-queue"

[[queues.producers]]
binding = "DLQ"
queue = "dead-letter"

[[queues.consumers]]
queue = "post-queue"

# --- R2 Storage (Media/Gallery)
# NOTE: R2 must be enabled in Cloudflare Dashboard first
# Uncomment after enabling R2 and running: wrangler r2 bucket create syston-media
[[r2_buckets]]
binding = "R2_MEDIA"
bucket_name = "syston-media"

[[r2_buckets]]
binding = "VIDEOS_BUCKET"
bucket_name = "oa-videos"

[[r2_buckets]]
binding = "HIGHLIGHTS_BUCKET"
bucket_name = "oa-highlights"

# --- Durable Objects
[[durable_objects.bindings]]
name = "TenantRateLimiter"
class_name = "TenantRateLimiter"

[[durable_objects.bindings]]
name = "VotingRoom"
class_name = "VotingRoom"

[[durable_objects.bindings]]
name = "ChatRoom"
class_name = "ChatRoom"

[[durable_objects.bindings]]
name = "MatchRoom"
class_name = "MatchRoom"

[[durable_objects.bindings]]
name = "GeoFenceManager"
class_name = "GeoFenceManager"

[[durable_objects.bindings]]
name = "PROVISIONER"
class_name = "Provisioner"

# --- DO migrations
[[migrations]]
tag = "v1"
new_classes = [ "TenantRateLimiter" ]

[[migrations]]
tag = "v2"
new_classes = [ "VotingRoom" ]

[[migrations]]
tag = "v3"
new_classes = [ "ChatRoom", "MatchRoom" ]

[[migrations]]
tag = "v4"
new_classes = [ "GeoFenceManager" ]

[[migrations]]
tag = "v5"
new_classes = [ "Provisioner" ]

# --- Cron triggers (event reminders)
[triggers]
crons = [ "*/5 * * * *" ]

# Custom domain routes (update zone_name with your actual domain)
# routes = [
#   { pattern = "api.YOURBRAND.com/*", zone_name = "YOURBRAND.com" }
# ]

[env.production]
kv_namespaces = [
  { binding = "TENANTS", id = "71b9f158fb2c4e1a8858dded2633ff5b" }
]

[env.preview]
kv_namespaces = [
  { binding = "TENANTS", id = "ed3084ae6a9b46e7bbb5e1798831f331" }
]

