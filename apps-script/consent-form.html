<!DOCTYPE html>
<html>
<head>
  <title>GDPR Consent Form – <?= teamName ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: <?= primaryColor ?>;
      --secondary: <?= secondaryColor ?>;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 40px;
      text-align: center;
    }

    .club-badge {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      <? if (badgeUrl && !badgeUrl.includes('[SET')) { ?>
        background: url('<?= badgeUrl ?>') center/contain no-repeat;
      <? } else { ?>
        background: rgba(255,255,255,0.2);
      <? } ?>
      border-radius: 50%;
    }

    .header h1 { margin-bottom: 10px; font-size: 28px; }
    .header p { opacity: 0.9; font-size: 16px; }

    .content {
      padding: 40px;
    }

    .section {
      margin-bottom: 40px;
    }

    .section h2 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
    }

    .consent-item {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      transition: all 0.3s;
    }

    .consent-item:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .consent-item.required {
      border-color: var(--warning);
      background: #fff8e1;
    }

    .consent-item.age-restricted {
      border-color: var(--danger);
      background: #ffebee;
    }

    .consent-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .consent-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }

    .consent-badges {
      display: flex;
      gap: 8px;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .badge.required { background: var(--warning); color: white; }
    .badge.age-restricted { background: var(--danger); color: white; }
    .badge.optional { background: #6c757d; color: white; }

    .consent-description {
      color: #666;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .consent-details {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .detail-row {
      display: flex;
      margin-bottom: 10px;
    }

    .detail-label {
      font-weight: 600;
      color: #333;
      min-width: 120px;
    }

    .detail-value {
      color: #666;
    }

    .consent-choice {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .choice-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      text-align: center;
      justify-content: center;
    }

    .choice-option:hover {
      border-color: var(--primary);
    }

    .choice-option.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .choice-option.selected.refused {
      border-color: var(--danger);
      background: var(--danger);
    }

    .choice-option input[type="radio"] {
      margin: 0;
    }

    .legal-basis {
      background: #e3f2fd;
      border-left: 4px solid var(--info);
      padding: 20px;
      margin: 25px 0;
      border-radius: 0 8px 8px 0;
    }

    .legal-basis h4 {
      color: var(--info);
      margin-bottom: 10px;
    }

    .rights-section {
      background: #f0f8f0;
      border-radius: 12px;
      padding: 25px;
      margin: 25px 0;
    }

    .rights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .right-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid var(--success);
    }

    .right-title {
      font-weight: 600;
      color: var(--success);
      margin-bottom: 5px;
    }

    .signatures-section {
      background: #fff3cd;
      border: 2px solid var(--warning);
      border-radius: 12px;
      padding: 25px;
      margin: 30px 0;
    }

    .signature-box {
      border: 2px dashed #adb5bd;
      border-radius: 8px;
      height: 80px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
    }

    .signature-box:hover {
      border-color: var(--primary);
    }

    .signature-box.signed {
      border-color: var(--success);
      background: #f8fff8;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .submit-section {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      margin: 40px -40px -40px;
      padding: 40px;
      text-align: center;
    }

    .btn-submit {
      background: white;
      color: var(--primary);
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .progress-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #6c757d;
    }

    .step-circle.active {
      background: var(--primary);
      color: white;
    }

    .step-line {
      width: 50px;
      height: 2px;
      background: #e9ecef;
      margin: 0 10px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .alert.info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .alert.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .alert.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    @media (max-width: 768px) {
      .content { padding: 20px; }
      .consent-choice { flex-direction: column; }
      .rights-grid { grid-template-columns: 1fr; }
      .submit-section { margin: 20px -20px -20px; padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <? if (badgeUrl && !badgeUrl.includes('[SET')) { ?>
        <div class="club-badge"></div>
      <? } ?>
      <h1><?= teamName ?></h1>
      <p>GDPR Data Processing Consent Form</p>
      <p><strong>Player:</strong> <?= playerName ?> | <strong>Season:</strong> <?= season ?></p>
    </div>

    <div class="content">
      <div class="progress-indicator">
        <div class="progress-step">
          <div class="step-circle active">1</div>
          <div class="step-line"></div>
          <div class="step-circle">2</div>
          <div class="step-line"></div>
          <div class="step-circle">3</div>
        </div>
      </div>

      <? if (requiresParentConsent) { ?>
        <div class="alert info">
          <strong>Parent/Guardian Consent Required:</strong>
          As <?= playerName ?> is <?= isMinor ? 'under 16' : 'under 18' ?>,
          parent or guardian consent is required for data processing.
        </div>
      <? } ?>

      <form id="consentForm">
        <input type="hidden" name="formId" value="<?= formId ?>">
        <input type="hidden" name="playerName" value="<?= playerName ?>">

        <div class="section">
          <h2>📋 Data Processing Consents</h2>

          <? for (let item of consentItems) { ?>
            <div class="consent-item <?= item.required ? 'required' : '' ?> <?= item.ageRestricted ? 'age-restricted' : '' ?>">
              <div class="consent-header">
                <div class="consent-title"><?= item.title ?></div>
                <div class="consent-badges">
                  <? if (item.required) { ?>
                    <span class="badge required">Required</span>
                  <? } else { ?>
                    <span class="badge optional">Optional</span>
                  <? } ?>
                  <? if (item.ageRestricted) { ?>
                    <span class="badge age-restricted">Parental Consent</span>
                  <? } ?>
                </div>
              </div>

              <div class="consent-description">
                <?= item.description ?>
              </div>

              <div class="consent-details">
                <div class="detail-row">
                  <div class="detail-label">Data Types:</div>
                  <div class="detail-value"><?= item.dataTypes.join(', ') ?></div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Retention:</div>
                  <div class="detail-value"><?= item.retention ?></div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Consequences:</div>
                  <div class="detail-value"><?= item.consequences ?></div>
                </div>
              </div>

              <div class="consent-choice">
                <label class="choice-option" onclick="selectChoice(this, '<?= item.type ?>', 'granted')">
                  <input type="radio" name="consent_<?= item.type ?>" value="granted" <?= item.required ? 'required' : '' ?>>
                  <span>✓ I Consent</span>
                </label>
                <label class="choice-option" onclick="selectChoice(this, '<?= item.type ?>', 'refused')">
                  <input type="radio" name="consent_<?= item.type ?>" value="refused">
                  <span>✗ I Do Not Consent</span>
                </label>
              </div>
            </div>
          <? } ?>
        </div>

        <div class="section">
          <h2>⚖️ Legal Basis for Processing</h2>

          <div class="legal-basis">
            <h4>Contractual Necessity</h4>
            <p><?= legalBasis.contractualNecessity.description ?></p>
            <p><strong>Applies to:</strong> <?= legalBasis.contractualNecessity.applies.join(', ') ?></p>
          </div>

          <div class="legal-basis">
            <h4>Legitimate Interests</h4>
            <p><?= legalBasis.legitimateInterests.description ?></p>
            <p><?= legalBasis.legitimateInterests.balancing ?></p>
            <p><strong>Applies to:</strong> <?= legalBasis.legitimateInterests.applies.join(', ') ?></p>
          </div>

          <div class="legal-basis">
            <h4>Explicit Consent</h4>
            <p><?= legalBasis.consent.description ?></p>
            <p><strong>Applies to:</strong> <?= legalBasis.consent.applies.join(', ') ?></p>
          </div>
        </div>

        <div class="section">
          <h2>🛡️ Your Data Protection Rights</h2>

          <div class="rights-section">
            <p>Under GDPR, you have the following rights regarding your personal data:</p>

            <div class="rights-grid">
              <div class="right-item">
                <div class="right-title">Right to Access</div>
                <div><?= rightsInformation.rightToAccess ?></div>
              </div>
              <div class="right-item">
                <div class="right-title">Right to Rectification</div>
                <div><?= rightsInformation.rightToRectification ?></div>
              </div>
              <div class="right-item">
                <div class="right-title">Right to Erasure</div>
                <div><?= rightsInformation.rightToErasure ?></div>
              </div>
              <div class="right-item">
                <div class="right-title">Right to Restriction</div>
                <div><?= rightsInformation.rightToRestriction ?></div>
              </div>
              <div class="right-item">
                <div class="right-title">Right to Portability</div>
                <div><?= rightsInformation.rightToPortability ?></div>
              </div>
              <div class="right-item">
                <div class="right-title">Right to Withdraw</div>
                <div><?= rightsInformation.rightToWithdraw ?></div>
              </div>
            </div>

            <div class="alert info">
              <strong>Contact:</strong> <?= rightsInformation.contactEmail ?> |
              <strong>Response Time:</strong> <?= rightsInformation.responseTime ?>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>✍️ Digital Signatures</h2>

          <div class="signatures-section">
            <? if (requiresParentConsent) { ?>
              <div class="form-group">
                <label class="form-label">Parent/Guardian Full Name *</label>
                <input type="text" name="parentName" class="form-input" required
                       placeholder="Enter parent/guardian full name">
              </div>

              <div class="form-group">
                <label class="form-label">Parent/Guardian Digital Signature *</label>
                <div class="signature-box" onclick="openSignaturePad('parent')">
                  <span id="parentSignatureText">Click to sign digitally</span>
                </div>
                <input type="hidden" name="parentSignature" required>
              </div>
            <? } ?>

            <? if (!isMinor) { ?>
              <div class="form-group">
                <label class="form-label">Player Digital Signature *</label>
                <div class="signature-box" onclick="openSignaturePad('player')">
                  <span id="playerSignatureText">Click to sign digitally</span>
                </div>
                <input type="hidden" name="playerSignature" required>
              </div>
            <? } ?>

            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" required style="margin-right: 8px;">
                I confirm that I have read and understood this consent form and the
                information provided about data processing.
              </label>
            </div>

            <div class="alert warning">
              <strong>Important:</strong> This consent is valid until <?= expiryDate ?>.
              You can withdraw your consent at any time by contacting <?= rightsInformation.contactEmail ?>.
            </div>
          </div>
        </div>

        <div class="submit-section">
          <button type="submit" class="btn-submit" id="submitBtn" disabled>
            🔒 Submit Consent Form
          </button>
          <p style="color: white; margin-top: 15px; opacity: 0.9;">
            Your form will be securely processed and confirmation sent via email.
          </p>
        </div>
      </form>
    </div>
  </div>

  <script>
    let signatures = {};

    function selectChoice(element, consentType, value) {
      // Remove selected class from siblings
      const parent = element.closest('.consent-choice');
      parent.querySelectorAll('.choice-option').forEach(opt => {
        opt.classList.remove('selected', 'refused');
      });

      // Add selected class to clicked option
      element.classList.add('selected');
      if (value === 'refused') {
        element.classList.add('refused');
      }

      // Check if form is complete
      checkFormCompletion();
    }

    function checkFormCompletion() {
      const form = document.getElementById('consentForm');
      const requiredInputs = form.querySelectorAll('input[required]');
      const submitBtn = document.getElementById('submitBtn');

      let allComplete = true;
      requiredInputs.forEach(input => {
        if (!input.value && input.type !== 'radio') {
          allComplete = false;
        }
      });

      // Check required radio buttons
      const requiredRadios = form.querySelectorAll('input[type="radio"][required]');
      const radioGroups = {};
      requiredRadios.forEach(radio => {
        if (!radioGroups[radio.name]) {
          radioGroups[radio.name] = false;
        }
        if (radio.checked) {
          radioGroups[radio.name] = true;
        }
      });

      Object.values(radioGroups).forEach(checked => {
        if (!checked) allComplete = false;
      });

      submitBtn.disabled = !allComplete;
    }

    function openSignaturePad(type) {
      // Simple signature implementation - in production, use a proper signature library
      const signature = prompt(`Please type your full name as your digital signature:`);
      if (signature && signature.trim()) {
        signatures[type] = signature.trim();

        document.querySelector(`input[name="${type}Signature"]`).value = signature;
        document.getElementById(`${type}SignatureText`).textContent = `Signed: ${signature}`;
        document.querySelector(`#${type}SignatureText`).closest('.signature-box').classList.add('signed');

        checkFormCompletion();
      }
    }

    document.getElementById('consentForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = '🔄 Processing...';

      const formData = new FormData(e.target);
      formData.append('action', 'submit_consent');
      formData.append('timestamp', new Date().toISOString());

      try {
        const response = await fetch(window.location.href.split('?')[0], {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // Show success message
          document.querySelector('.container').innerHTML = `
            <div class="header">
              <div class="club-badge"></div>
              <h1>✅ Consent Form Submitted</h1>
              <p>Thank you for completing the GDPR consent form</p>
            </div>
            <div class="content" style="text-align: center; padding: 60px;">
              <h2 style="color: var(--success); margin-bottom: 20px;">
                Consent Successfully Recorded
              </h2>
              <p style="font-size: 18px; margin-bottom: 30px;">
                Your consent preferences have been securely recorded.
                A confirmation email will be sent shortly.
              </p>
              <div class="alert success">
                <strong>Form ID:</strong> ${result.formId}<br>
                <strong>Consents Granted:</strong> ${result.consentsGranted.join(', ')}<br>
                <strong>Processed:</strong> ${new Date().toLocaleString('en-GB')}
              </div>
              <p style="margin-top: 30px;">
                You can withdraw or modify your consent at any time by contacting:<br>
                <strong><?= rightsInformation.contactEmail ?></strong>
              </p>
            </div>
          `;
        } else {
          alert('❌ Error submitting form: ' + result.error);
          submitBtn.disabled = false;
          submitBtn.textContent = '🔒 Submit Consent Form';
        }
      } catch (error) {
        alert('❌ Error submitting form: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = '🔒 Submit Consent Form';
      }
    });

    // Add event listeners for form completion checking
    document.addEventListener('change', checkFormCompletion);
    document.addEventListener('input', checkFormCompletion);

    // Initial form check
    checkFormCompletion();

    console.log('📋 <?= teamName ?> GDPR Consent Form Ready!');
  </script>
</body>
</html>